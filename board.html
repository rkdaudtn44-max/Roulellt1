<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²Œì‹œíŒ</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;
      --pri:#5b7cff;--danger:#ef4444;--warn:#f59e0b;--good:#10b981;
      --shadow:0 10px 24px rgba(17,24,39,.08);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
    a{color:inherit;text-decoration:none}
    .top{
      position:sticky;top:0;z-index:10;
      background:rgba(246,247,251,.92);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
    }
    .topin{max-width:1100px;margin:0 auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .brand{font-weight:900;letter-spacing:-.02em;margin-right:auto}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);background:#fff;color:var(--text);
      padding:8px 12px;border-radius:999px;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition:.15s transform,.15s background,.15s border;
      user-select:none;
      font-weight:900;
    }
    .btn:hover{transform:translateY(-1px);border-color:#d9dced}
    .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.small{padding:6px 10px;font-size:13px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);font-weight:900}
    .pill.admin{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#b91c1c}
    .pill.user{border-color:rgba(91,124,255,.25);background:rgba(91,124,255,.08);color:#1d4ed8}

    .wrap{max-width:1100px;margin:0 auto;padding:16px 12px 44px}
    .layout{display:grid;grid-template-columns: 1fr 320px;gap:12px;align-items:start;}
    @media (max-width:980px){.layout{grid-template-columns:1fr}.sidebar{order:-1}}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .h1{font-size:18px;font-weight:900;margin:0 0 6px;letter-spacing:-.02em}
    .sub{color:var(--muted);font-size:13px;line-height:1.4;font-weight:800}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .input{
      border:1px solid var(--line);border-radius:12px;background:#fff;
      padding:10px 12px;font-size:14px;outline:none;min-width:220px;flex:1;
    }
    select.input{min-width:150px;flex:0}
    textarea.input{min-height:180px;resize:vertical}

    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .postItem{
      border:1px solid var(--line);border-radius:14px;background:#fff;padding:12px;
      cursor:pointer;transition:.12s transform,.12s border;
    }
    .postItem:hover{transform:translateY(-1px);border-color:#d9dced}
    .postTitle{margin:0 0 6px;font-weight:900;letter-spacing:-.01em}
    .postMeta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px;font-weight:900}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:3px 7px;border-radius:999px;background:#fff;font-weight:900;}
    .tag{font-size:12px;border-radius:999px;padding:3px 7px;font-weight:900;border:1px solid rgba(91,124,255,.35);background:rgba(91,124,255,.08);color:#1d4ed8;}
    .pin{font-size:12px;color:#a16207;background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.25);padding:3px 7px;border-radius:999px;font-weight:900}
    .lock{font-size:12px;color:#991b1b;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);padding:3px 7px;border-radius:999px;font-weight:900}
    .preview{
      margin:8px 0 0;color:#374151;font-size:13px;line-height:1.45;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;font-weight:700;
    }
    .empty{border:1px dashed #cfd3e6;border-radius:14px;padding:14px;color:var(--muted);background:rgba(255,255,255,.6);font-weight:900}
    .divider{height:1px;background:var(--line);margin:12px 0}

    .catHead{display:flex;align-items:center;justify-content:space-between}
    .catTitle{margin:0;font-size:14px;font-weight:900;letter-spacing:-.01em}
    .catList{margin-top:10px;display:flex;flex-direction:column;gap:6px}
    .catBtn{
      width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fff;cursor:pointer;font-weight:900;color:#111827;transition:.12s transform,.12s border;
    }
    .catBtn:hover{transform:translateY(-1px);border-color:#d9dced}
    .catBtn.active{border-color:rgba(91,124,255,.35);background:rgba(91,124,255,.08);color:#1d4ed8}
    .catName{display:flex;gap:8px;align-items:center;min-width:0}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(91,124,255,.55)}
    .catCount{font-variant-numeric:tabular-nums;color:var(--muted);font-weight:900}
    .catLabel{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:190px}

    .detailTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .detailTitle{margin:10px 0 10px;font-size:20px;font-weight:900;letter-spacing:-.02em}
    .contentBox{white-space:pre-wrap;line-height:1.6;font-size:14px;border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px;font-weight:700;}
    .miniLine{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .likeBtn{
      border:1px solid rgba(91,124,255,.35);background:rgba(91,124,255,.08);
      color:#1d4ed8;border-radius:999px;padding:7px 10px;font-weight:900;cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
    }
    .likeBtn.on{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#b91c1c;}
    .rightActions{display:flex;gap:8px;flex-wrap:wrap}

    .comments{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .cmtItem{border:1px solid var(--line);border-radius:14px;background:#fff;padding:10px 12px;}
    .cmtText{margin:0 0 6px;font-weight:800}
    .cmtMeta{color:var(--muted);font-size:12px;font-weight:900}
    .cmtBar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:#111827;color:#fff;padding:10px 12px;border-radius:999px;
      font-size:13px;display:none;z-index:1000;
      box-shadow:0 10px 28px rgba(0,0,0,.25);
      font-weight:900;
    }
    .toast.show{display:block}

    .modalBg{position:fixed;inset:0;background:rgba(17,24,39,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:999;}
    .modalBg.show{display:flex}
    .modal{width:min(760px,100%);background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:14px;}
    .modalHead{display:flex;align-items:center;gap:10px}
    .modalHead h3{margin:0;font-size:16px;font-weight:900}
    .modalHead .x{margin-left:auto}

    .adminBox{margin-top:12px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.75);padding:12px}
    .adminGrid{display:grid;grid-template-columns: 1fr;gap:8px;margin-top:10px}
    .adminItem{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
    .adminItemTop{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .miniBtn{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer}
    .miniBtn:hover{border-color:#d9dced;transform:translateY(-1px)}
    .miniBtn.danger{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#b91c1c}
    .miniBtn.primary{border-color:rgba(91,124,255,.35);background:rgba(91,124,255,.08);color:#1d4ed8}
    .help{font-size:12px;color:var(--muted);font-weight:800;line-height:1.35;margin-top:6px}
  </style>
</head>

<body>
  <div class="top">
    <div class="topin">
      <div class="brand">ê²Œì‹œíŒ</div>
      <div class="nav">
        <a class="btn small" href="./roulette.html">ë£°ë ›</a>
        <a class="btn small" href="./log.html">ê¸°ë¡</a>
        <a class="btn small" href="./lottery.html">ë³µê¶Œ</a>
        <a class="btn small primary" href="./board.html">ê²Œì‹œíŒ</a>
      </div>
      <span id="rolePill" class="pill">ë¡œê·¸ì¸ í™•ì¸ì¤‘â€¦</span>
      <button id="btnLogout" class="btn small" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">

      <div class="main card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="h1" id="mainTitle">ì „ì²´ ê¸€</div>
            <div class="sub" id="mainSub">ìš°ì¸¡ ì¹´í…Œê³ ë¦¬ì—ì„œ ì´ë™ â†’ ê¸€ í´ë¦­ ì‹œ ë³¸ë¬¸ ë³´ê¸°</div>
          </div>
          <div class="row" style="gap:8px">
            <button id="btnNew" class="btn primary" disabled>ê¸€ì“°ê¸°</button>
            <button id="btnBack" class="btn" style="display:none">â† ëª©ë¡</button>
          </div>
        </div>

        <div class="controls" id="searchBar">
          <input id="q" class="input" placeholder="ê²€ìƒ‰ (ì œëª©/ë‚´ìš©/ì‘ì„±ì)" />
          <select id="sort" class="input">
            <option value="pinThenNew">ê³ ì •ìš°ì„ Â·ìµœì‹ </option>
            <option value="new">ìµœì‹ ìˆœ</option>
            <option value="popular">ì¸ê¸°ìˆœ(ì¢‹ì•„ìš”)</option>
          </select>
          <button id="btnRefresh" class="btn">ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div id="listView">
          <div id="list" class="list"></div>
          <div id="listEmpty" class="empty" style="display:none;margin-top:12px">ê²Œì‹œê¸€ì´ ì—†ì–´.</div>
        </div>

        <div id="detailView" style="display:none">
          <div class="divider"></div>

          <div class="detailTop">
            <div class="miniLine">
              <span id="dCat" class="tag">ì¹´í…Œê³ ë¦¬</span>
              <span id="dLock" class="lock" style="display:none">ğŸ”’ ê´€ë¦¬ìì „ìš©</span>
              <span id="dPin" class="pin" style="display:none">ğŸ“Œ ê³ ì •</span>
              <span id="dMeta" class="badge"></span>
            </div>
            <div class="rightActions">
              <button id="btnLike" class="likeBtn"><span>â¤ï¸</span><span id="dLike" class="nums">0</span></button>
              <span class="badge">ğŸ‘ï¸ <span id="dView" class="nums">0</span></span>
              <span class="badge">ğŸ’¬ <span id="dCmtCnt" class="nums">0</span></span>
              <button id="btnCopy" class="btn small">ë§í¬ ë³µì‚¬</button>
              <button id="btnEdit" class="btn small" disabled>ìˆ˜ì •</button>
              <button id="btnDelete" class="btn small danger" disabled>ì‚­ì œ</button>
              <button id="btnPin" class="btn small" disabled>ê³ ì •</button>
            </div>
          </div>

          <h2 id="dTitle" class="detailTitle"></h2>
          <div id="dContent" class="contentBox"></div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between">
            <div class="h1" style="font-size:15px;margin:0">ëŒ“ê¸€</div>
            <span id="commentCount" class="badge nums">0</span>
          </div>

          <div id="comments" class="comments"></div>
          <div id="commentsEmpty" class="empty" style="display:none;margin-top:10px">ëŒ“ê¸€ì´ ì—†ì–´.</div>

          <div class="cmtBar">
            <input id="cmt" class="input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì¤˜ (ë¡œê·¸ì¸ í•„ìš”)" />
            <button id="btnCmt" class="btn primary" disabled>ë“±ë¡</button>
          </div>
        </div>
      </div>

      <div class="sidebar card">
        <div class="catHead">
          <h3 class="catTitle">ì¹´í…Œê³ ë¦¬</h3>
          <span class="pill" id="whoPill">-</span>
        </div>
        <div class="sub" style="margin-top:6px">ê´€ë¦¬ìê°€ ì§ì ‘ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ/ìˆœì„œ ë³€ê²½ ê°€ëŠ¥</div>

        <div class="catList" id="catList"></div>

        <div id="adminCatBox" class="adminBox" style="display:none">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:900">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬(ê´€ë¦¬ì)</div>
            <span class="badge">Firestore ì €ì¥</span>
          </div>

          <div class="row" style="margin-top:8px">
            <input id="newCatName" class="input" style="min-width:0" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„" />
            <select id="newCatPolicy" class="input" style="min-width:140px;flex:0">
              <option value="user">ì „ì²´ ê¸€ì“°ê¸°</option>
              <option value="admin">ê´€ë¦¬ì ì „ìš©</option>
            </select>
            <button id="btnAddCat" class="btn primary" style="flex:0">ì¶”ê°€</button>
          </div>
          <div class="help">
            - â€œê´€ë¦¬ì ì „ìš©â€ ì¹´í…Œê³ ë¦¬ëŠ” ğŸ”’ í‘œì‹œ, ê¸€ì“°ê¸°ë„ ê´€ë¦¬ìë§Œ ê°€ëŠ¥<br/>
            - ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë°”ê¾¸ë©´ ìƒˆ ê¸€ë¶€í„° ìƒˆ ì´ë¦„ìœ¼ë¡œ í‘œì‹œë¨(ê¸°ì¡´ ê¸€ì€ ìë™ ë™ê¸°í™” ì•ˆ í•¨)
          </div>

          <div class="adminGrid" id="adminCatList"></div>
        </div>

        <div class="divider"></div>
        <div class="sub">ê¶Œí•œ ê·œì¹™</div>
        <div class="sub" style="margin-top:6px">
          - ì¹´í…Œê³ ë¦¬ë§ˆë‹¤ â€œì „ì²´/ê´€ë¦¬ìì „ìš©â€ì„ ê´€ë¦¬ìê°€ ì„¤ì •<br/>
          - ê¸€ ìˆ˜ì •/ì‚­ì œ: ë³¸ì¸ ê¸€ ë˜ëŠ” ê´€ë¦¬ì<br/>
          - ì¢‹ì•„ìš”/ëŒ“ê¸€: ë¡œê·¸ì¸ ìœ ì €
        </div>
      </div>
    </div>
  </div>

  <div id="modalBg" class="modalBg" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h3 id="modalTitle">ê¸€ì“°ê¸°</h3>
        <button class="btn small x" id="modalClose">ë‹«ê¸°</button>
      </div>

      <div class="field" style="margin-top:10px">
        <div class="sub" style="margin-bottom:6px">ì¹´í…Œê³ ë¦¬</div>
        <select id="fCat" class="input"></select>
        <div class="sub" id="fCatHelp" style="margin-top:6px">ì¹´í…Œê³ ë¦¬ë³„ ì‘ì„± ê¶Œí•œì´ ì ìš©ë¼.</div>
      </div>

      <div class="field">
        <div class="sub" style="margin-bottom:6px">ì œëª©</div>
        <input id="fTitle" class="input" maxlength="60" placeholder="ì œëª©ì„ ì…ë ¥í•´ì¤˜" />
      </div>

      <div class="field">
        <div class="sub" style="margin-bottom:6px">ë‚´ìš©</div>
        <textarea id="fContent" class="input" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜"></textarea>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:10px">
        <label class="row" style="gap:8px">
          <input id="fPin" type="checkbox" />
          <span style="font-size:13px;font-weight:900">ìƒë‹¨ ê³ ì •(ê´€ë¦¬ìë§Œ)</span>
        </label>
        <button id="modalSave" class="btn primary">ì €ì¥</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, addDoc, updateDoc, getDocs,
      query, where, orderBy, limit, serverTimestamp, increment, runTransaction
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // âœ… ë„¤ê°€ ì¤€ firebaseConfig ê·¸ëŒ€ë¡œ ì ìš©
    const firebaseConfig = {
      apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
      authDomain: "roulette-b5455.firebaseapp.com",
      projectId: "roulette-b5455",
      storageBucket: "roulette-b5455.firebasestorage.app",
      messagingSenderId: "728191308035",
      appId: "1:728191308035:web:b14b46c38bbe0261969936",
      measurementId: "G-SPY41ZKXYQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (s) => document.querySelector(s);

    // ===== ìƒíƒœ =====
    let me = { uid:null, nick:"ê²ŒìŠ¤íŠ¸", role:"guest" }; // role: guest/user/admin
    let currentCatId = "all"; // all or categoryId
    let viewMode = "list";    // list | detail
    let selectedPostId = null;

    // ì¹´í…Œê³ ë¦¬ ìºì‹œ
    let cats = [];               // [{id,name,writePolicy,order,isDeleted}]
    let catMap = new Map();      // id -> cat
    let countsCache = new Map(); // catId -> count

    // ì¤‘ë³µ ì¡°íšŒìˆ˜ ë°©ì§€(ê°™ì€ íƒ­)
    const viewedKey = "boardViewed_v1";
    const viewed = new Set(JSON.parse(sessionStorage.getItem(viewedKey) || "[]"));

    // ===== ìœ í‹¸ =====
    const signedIn = () => !!me.uid;
    const isAdmin = () => me.role === "admin";

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(t._t);
      t._t = setTimeout(()=>t.classList.remove("show"), 1600);
    }

    function fmtTime(ts){
      const d = new Date(ts);
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function snippet(s){
      s = (s||"").trim().replace(/\n+/g," ");
      return s.length > 130 ? s.slice(0,130)+"â€¦" : s;
    }

    function canWriteInCat(cat){
      if (!cat) return false;
      if (cat.writePolicy === "admin") return isAdmin();
      return signedIn(); // user
    }

    function canEditPost(p){
      if (!p) return false;
      if (!signedIn()) return false;
      if (isAdmin()) return true;
      return p.authorUid === me.uid;
    }

    // ===== ë¡œê·¸ì¸ ìœ ì € ì •ë³´(users/{uid}ì—ì„œ role/nickname ì½ê¸°) =====
    async function loadMe(uid, email){
      let role = "user";
      let nick = (email ? email.split("@")[0] : "ìœ ì €");
      try{
        const us = await getDoc(doc(db,"users",uid));
        if (us.exists()){
          const d = us.data();
          role = d.role || "user";
          nick = d.nickname || d.nick || nick;
        }
      }catch(e){}
      me = { uid, role, nick };
    }

    function setPills(){
      const rolePill = $("#rolePill");
      const whoPill = $("#whoPill");
      const btnLogout = $("#btnLogout");

      rolePill.className = "pill";
      if (isAdmin()){
        rolePill.classList.add("admin");
        rolePill.textContent = `ê´€ë¦¬ì Â· ${me.nick}`;
      } else if (signedIn()){
        rolePill.classList.add("user");
        rolePill.textContent = `ìœ ì € Â· ${me.nick}`;
      } else {
        rolePill.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•´";
      }
      whoPill.className = rolePill.className;
      whoPill.textContent = rolePill.textContent;
      btnLogout.style.display = signedIn() ? "" : "none";

      $("#btnCmt").disabled = !signedIn();
      $("#cmt").disabled = !signedIn();
      $("#cmt").placeholder = signedIn() ? "ëŒ“ê¸€ì„ ì…ë ¥í•´ì¤˜" : "ëŒ“ê¸€ì€ ë¡œê·¸ì¸ í›„ ì‘ì„± ê°€ëŠ¥";

      $("#adminCatBox").style.display = isAdmin() ? "" : "none";
    }

    // ===== ì¹´í…Œê³ ë¦¬: Firestoreì—ì„œ ë¡œë”© =====
    async function fetchCategories(){
      const qq = query(collection(db,"boardCategories"),
        where("isDeleted","==",false),
        orderBy("order","asc"),
        limit(200)
      );
      const snap = await getDocs(qq);

      cats = snap.docs.map(d=>{
        const x = d.data();
        return {
          id:d.id,
          name:x.name || "(ì´ë¦„ì—†ìŒ)",
          writePolicy: x.writePolicy || "user", // user | admin
          order: x.order ?? 0,
          isDeleted: !!x.isDeleted
        };
      });

      catMap = new Map();
      for (const c of cats) catMap.set(c.id, c);

      // ìµœì´ˆ ì¹´í…Œê³ ë¦¬ ì—†ìœ¼ë©´: ê´€ë¦¬ìë©´ ê¸°ë³¸ 3ê°œ ìë™ ìƒì„±(ì•ˆì „)
      if (cats.length === 0 && isAdmin()){
        await seedDefaultCategories();
        return await fetchCategories();
      }
      return cats;
    }

    async function seedDefaultCategories(){
      const base = [
        {name:"ë°©ì†¡ê³µì§€", writePolicy:"admin", order:10},
        {name:"DJê²Œì‹œíŒ", writePolicy:"admin", order:20},
        {name:"ìœ ì €ê²Œì‹œíŒ", writePolicy:"user",  order:30},
        {name:"TMI",      writePolicy:"admin", order:40},
      ];
      for (const c of base){
        await addDoc(collection(db,"boardCategories"), {
          name: c.name,
          writePolicy: c.writePolicy,
          order: c.order,
          isDeleted:false,
          createdAt: serverTimestamp(),
          updatedAt: null
        });
      }
    }

    // ì¹´í…Œê³ ë¦¬ë³„ ê¸€ ìˆ˜ (ìµœê·¼ 500ê°œ ê¸°ì¤€ ê°„ì´ ì¹´ìš´íŠ¸)
    async function rebuildCounts(){
      countsCache = new Map();
      countsCache.set("all", 0);

      const qq = query(collection(db,"posts"),
        where("isDeleted","==",false),
        orderBy("createdAt","desc"),
        limit(500)
      );
      const snap = await getDocs(qq);
      snap.forEach(d=>{
        const p = d.data();
        const cid = p.categoryId || "unknown";
        countsCache.set("all", (countsCache.get("all")||0) + 1);
        countsCache.set(cid, (countsCache.get(cid)||0) + 1);
      });
    }

    function renderSidebar(){
      const catList = $("#catList");
      catList.innerHTML = "";

      // ì „ì²´
      const allBtn = document.createElement("button");
      allBtn.className = "catBtn" + (currentCatId==="all" ? " active" : "");
      allBtn.dataset.cat = "all";
      allBtn.innerHTML = `
        <span class="catName"><span class="dot"></span><span class="catLabel">ì „ì²´</span></span>
        <span class="catCount nums">${countsCache.get("all")||0}</span>
      `;
      allBtn.addEventListener("click", async ()=>{
        currentCatId = "all";
        viewMode = "list";
        selectedPostId = null;
        syncHeader();
        await render();
      });
      catList.appendChild(allBtn);

      // ì‹¤ì œ ì¹´í…Œê³ ë¦¬
      for (const c of cats){
        const btn = document.createElement("button");
        btn.className = "catBtn" + (c.id===currentCatId ? " active" : "");
        btn.dataset.cat = c.id;
        btn.innerHTML = `
          <span class="catName">
            <span class="dot"></span>
            <span class="catLabel">${c.name}</span>
          </span>
          <span class="catCount nums">${countsCache.get(c.id)||0}</span>
        `;
        btn.addEventListener("click", async ()=>{
          currentCatId = c.id;
          viewMode = "list";
          selectedPostId = null;
          syncHeader();
          await render();
        });
        catList.appendChild(btn);
      }
    }

    function renderAdminCatManager(){
      if (!isAdmin()) return;
      const list = $("#adminCatList");
      list.innerHTML = "";

      const sorted = [...cats].sort((a,b)=> (a.order-b.order) || a.name.localeCompare(b.name,'ko'));

      for (let i=0;i<sorted.length;i++){
        const c = sorted[i];

        const item = document.createElement("div");
        item.className = "adminItem";
        item.innerHTML = `
          <div class="adminItemTop">
            <div style="font-weight:900;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span>${c.name}</span>
              ${c.writePolicy==="admin" ? `<span class="lock">ğŸ”’ ê´€ë¦¬ìì „ìš©</span>` : `<span class="tag">ì „ì²´</span>`}
              <span class="badge">order: <span class="nums">${c.order}</span></span>
            </div>
            <div class="row" style="gap:6px">
              <button class="miniBtn" data-act="up">â–²</button>
              <button class="miniBtn" data-act="down">â–¼</button>
              <button class="miniBtn primary" data-act="edit">ìˆ˜ì •</button>
              <button class="miniBtn danger" data-act="del">ì‚­ì œ</button>
            </div>
          </div>
        `;

        item.querySelector('[data-act="up"]').addEventListener("click", async ()=>{
          if (i===0) return toast("ì´ë¯¸ ë§¨ ìœ„ì•¼");
          await swapCatOrder(sorted[i], sorted[i-1]);
          toast("ìˆœì„œ ë³€ê²½");
          await refreshCats();
        });
        item.querySelector('[data-act="down"]').addEventListener("click", async ()=>{
          if (i===sorted.length-1) return toast("ì´ë¯¸ ë§¨ ì•„ë˜ì•¼");
          await swapCatOrder(sorted[i], sorted[i+1]);
          toast("ìˆœì„œ ë³€ê²½");
          await refreshCats();
        });
        item.querySelector('[data-act="edit"]').addEventListener("click", async ()=>{
          const newName = prompt("ì¹´í…Œê³ ë¦¬ ì´ë¦„", c.name);
          if (newName === null) return;
          const name = newName.trim();
          if (!name) return toast("ì´ë¦„ì´ ë¹„ì—ˆì–´");

          const pol = prompt('ê¶Œí•œ: "user"(ì „ì²´ ê¸€ì“°ê¸°) ë˜ëŠ” "admin"(ê´€ë¦¬ìì „ìš©)', c.writePolicy);
          if (pol === null) return;
          const writePolicy = (pol.trim()==="admin") ? "admin" : "user";

          await updateDoc(doc(db,"boardCategories",c.id), {
            name,
            writePolicy,
            updatedAt: serverTimestamp()
          });
          toast("ìˆ˜ì • ì™„ë£Œ");
          await refreshCats();
        });
        item.querySelector('[data-act="del"]').addEventListener("click", async ()=>{
          if (!confirm(`"${c.name}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí• ê¹Œ?\n(ê¸°ì¡´ ê¸€ì€ ë‚¨ì•„ìˆì§€ë§Œ, ì¹´í…Œê³ ë¦¬ ëª©ë¡ì—ì„œëŠ” ì‚¬ë¼ì ¸)`)) return;
          await updateDoc(doc(db,"boardCategories",c.id), { isDeleted:true, updatedAt: serverTimestamp() });
          if (currentCatId === c.id) currentCatId = "all";
          toast("ì‚­ì œ ì™„ë£Œ");
          await refreshCats();
        });

        list.appendChild(item);
      }
    }

    async function swapCatOrder(a,b){
      const aRef = doc(db,"boardCategories",a.id);
      const bRef = doc(db,"boardCategories",b.id);
      await runTransaction(db, async (tx)=>{
        const as = await tx.get(aRef);
        const bs = await tx.get(bRef);
        if (!as.exists() || !bs.exists()) return;
        const ao = as.data().order ?? 0;
        const bo = bs.data().order ?? 0;
        tx.update(aRef, { order: bo, updatedAt: serverTimestamp() });
        tx.update(bRef, { order: ao, updatedAt: serverTimestamp() });
      });
    }

    async function refreshCats(){
      await fetchCategories();
      await rebuildCounts();
      renderSidebar();
      renderAdminCatManager();
      syncHeader();
      await render();
    }

    // ===== ê¸€ ëª©ë¡/ë³¸ë¬¸ =====
    async function fetchPosts(){
      const qtxt = ($("#q").value||"").trim().toLowerCase();
      const sort = $("#sort").value;

      const filters = [ where("isDeleted","==",false) ];
      if (currentCatId !== "all"){
        filters.push(where("categoryId","==",currentCatId));
      }

      const orders = [];
      if (sort === "popular"){
        orders.push(orderBy("likeCount","desc"), orderBy("createdAt","desc"));
      } else if (sort === "pinThenNew"){
        orders.push(orderBy("pin","desc"), orderBy("createdAt","desc"));
      } else {
        orders.push(orderBy("createdAt","desc"));
      }

      const qq = query(collection(db,"posts"), ...filters, ...orders, limit(50));
      const snap = await getDocs(qq);

      let arr = snap.docs.map(d=>{
        const p = d.data();
        return {
          id: d.id,
          ...p,
          createdAt: p.createdAt?.toMillis ? p.createdAt.toMillis() : p.createdAt,
          updatedAt: p.updatedAt?.toMillis ? p.updatedAt.toMillis() : p.updatedAt
        };
      });

      // ê²€ìƒ‰ì€ í´ë¼ì´ì–¸íŠ¸ í•„í„°(ê°€ë³ê²Œ)
      if (qtxt){
        arr = arr.filter(p =>
          (p.title||"").toLowerCase().includes(qtxt) ||
          (p.content||"").toLowerCase().includes(qtxt) ||
          (p.authorNick||"").toLowerCase().includes(qtxt)
        );
      }
      return arr;
    }

    async function fetchPost(postId){
      const snap = await getDoc(doc(db,"posts",postId));
      if (!snap.exists()) return null;
      const p = snap.data();
      return {
        id:snap.id,
        ...p,
        createdAt: p.createdAt?.toMillis ? p.createdAt.toMillis() : p.createdAt,
        updatedAt: p.updatedAt?.toMillis ? p.updatedAt.toMillis() : p.updatedAt
      };
    }

    async function fetchComments(postId){
      const qq = query(
        collection(db,"posts",postId,"comments"),
        where("isDeleted","==",false),
        orderBy("createdAt","asc"),
        limit(200)
      );
      const snap = await getDocs(qq);
      return snap.docs.map(d=>{
        const c = d.data();
        return {
          id:d.id,
          ...c,
          createdAt: c.createdAt?.toMillis ? c.createdAt.toMillis() : c.createdAt
        };
      });
    }

    async function hasLiked(postId){
      if (!signedIn()) return false;
      const s = await getDoc(doc(db,"posts",postId,"likes",me.uid));
      return s.exists();
    }

    function currentCatObj(){
      if (currentCatId==="all") return null;
      return catMap.get(currentCatId) || null;
    }

    function syncHeader(){
      const mainTitle = $("#mainTitle");
      const mainSub = $("#mainSub");
      const btnBack = $("#btnBack");
      const searchBar = $("#searchBar");

      if (viewMode === "list"){
        const c = currentCatObj();
        mainTitle.textContent = (currentCatId==="all") ? "ì „ì²´ ê¸€" : (c ? c.name : "ì¹´í…Œê³ ë¦¬");
        mainSub.textContent = "ìš°ì¸¡ ì¹´í…Œê³ ë¦¬ì—ì„œ ì´ë™í•˜ê³ , ê¸€ì„ ëˆ„ë¥´ë©´ ë³¸ë¬¸ìœ¼ë¡œ ë“¤ì–´ê°€.";
        btnBack.style.display = "none";
        searchBar.style.display = "";
      } else {
        mainTitle.textContent = "ë³¸ë¬¸ ë³´ê¸°";
        mainSub.textContent = "ëª©ë¡ ëŒ€ì‹  ë³¸ë¬¸ í™”ë©´ì´ ë‚˜ì˜¤ëŠ” êµ¬ì¡°ì•¼.";
        btnBack.style.display = "";
        searchBar.style.display = "none";
      }

      // ê¸€ì“°ê¸° ë²„íŠ¼
      const c = currentCatObj();
      $("#btnNew").disabled = !(c && canWriteInCat(c));
    }

    async function renderList(){
      const listEl = $("#list");
      const emptyEl = $("#listEmpty");
      listEl.innerHTML = "";

      const items = await fetchPosts();
      emptyEl.style.display = items.length ? "none" : "";

      for (const p of items){
        // ìµœì‹  ì¹´í…Œê³ ë¦¬ ì´ë¦„/ê¶Œí•œì„ catMapìœ¼ë¡œ ìš°ì„  ì ìš©
        const cat = p.categoryId ? catMap.get(p.categoryId) : null;
        const catName = cat ? cat.name : (p.categoryName || "-");
        const lock = cat ? (cat.writePolicy==="admin") : !!p.categoryAdminOnly;

        const div = document.createElement("div");
        div.className = "postItem";
        div.innerHTML = `
          <h3 class="postTitle">${p.title || "(ì œëª© ì—†ìŒ)"}</h3>
          <div class="postMeta">
            <span class="tag">${catName}</span>
            ${lock ? `<span class="lock">ğŸ”’ ê´€ë¦¬ìì „ìš©</span>` : ``}
            ${p.pin ? `<span class="pin">ğŸ“Œ ê³ ì •</span>` : ``}
            <span class="badge">ì‘ì„±: ${p.authorNick || "-"}</span>
            <span class="badge">${p.createdAt ? fmtTime(p.createdAt) : "-"}</span>
            <span class="badge">â¤ï¸ <span class="nums">${p.likeCount||0}</span></span>
            <span class="badge">ğŸ‘ï¸ <span class="nums">${p.viewCount||0}</span></span>
            <span class="badge">ğŸ’¬ <span class="nums">${p.commentCount||0}</span></span>
          </div>
          <div class="preview">${snippet(p.content)}</div>
        `;
        div.addEventListener("click", () => openPost(p.id));
        listEl.appendChild(div);
      }
    }

    async function renderDetail(p){
      const cat = p.categoryId ? catMap.get(p.categoryId) : null;
      const catName = cat ? cat.name : (p.categoryName || "-");
      const lock = cat ? (cat.writePolicy==="admin") : false;

      $("#dCat").textContent = catName;
      $("#dLock").style.display = lock ? "" : "none";
      $("#dPin").style.display = p.pin ? "" : "none";
      $("#dMeta").textContent = `${p.authorNick||"-"} Â· ${p.createdAt ? fmtTime(p.createdAt):"-"}${p.updatedAt ? " Â· ìˆ˜ì • "+fmtTime(p.updatedAt):""}`;
      $("#dTitle").textContent = p.title || "";
      $("#dContent").textContent = p.content || "";

      const cmts = await fetchComments(p.id);
      $("#dLike").textContent = String(p.likeCount||0);
      $("#dView").textContent = String(p.viewCount||0);
      $("#dCmtCnt").textContent = String(cmts.length);
      $("#commentCount").textContent = String(cmts.length);

      $("#btnEdit").disabled = !canEditPost(p);
      $("#btnDelete").disabled = !canEditPost(p);
      $("#btnPin").disabled = !isAdmin();
      $("#btnPin").textContent = p.pin ? "ê³ ì •í•´ì œ" : "ê³ ì •";

      const liked = await hasLiked(p.id);
      $("#btnLike").className = "likeBtn" + (liked ? " on" : "");

      const commentsEl = $("#comments");
      const emptyEl = $("#commentsEmpty");
      commentsEl.innerHTML = "";
      emptyEl.style.display = cmts.length ? "none" : "";

      for (const c of cmts){
        const box = document.createElement("div");
        box.className = "cmtItem";
        box.innerHTML = `
          <p class="cmtText">${c.content || ""}</p>
          <div class="cmtMeta">${c.authorNick || "-"} Â· ${c.createdAt ? fmtTime(c.createdAt) : "-"}</div>
        `;
        commentsEl.appendChild(box);
      }
    }

    async function render(){
      setPills();
      syncHeader();

      // ì¹´í…Œê³ ë¦¬ ì—†ìœ¼ë©´(ê²ŒìŠ¤íŠ¸ë„) ì‚¬ì´ë“œ ë Œë”ëŠ” ê°€ëŠ¥í•´ì•¼ í•¨
      if (cats.length === 0){
        try{
          await fetchCategories();
          await rebuildCounts();
        }catch(e){}
      }
      renderSidebar();
      renderAdminCatManager();

      const listView = $("#listView");
      const detailView = $("#detailView");

      if (viewMode === "list"){
        listView.style.display = "";
        detailView.style.display = "none";
        await renderList();
      } else {
        listView.style.display = "none";
        detailView.style.display = "";
        const p = await fetchPost(selectedPostId);
        if (!p || p.isDeleted){
          viewMode = "list";
          selectedPostId = null;
          syncHeader();
          await render();
          return;
        }
        await renderDetail(p);
      }
    }

    // ===== ì•¡ì…˜ =====
    async function openPost(id){
      selectedPostId = id;
      viewMode = "detail";
      syncHeader();

      // ì¡°íšŒìˆ˜ +1 (íƒ­ ì¤‘ë³µ ë°©ì§€)
      if (!viewed.has(id)){
        try{
          await updateDoc(doc(db,"posts",id), { viewCount: increment(1) });
          viewed.add(id);
          sessionStorage.setItem(viewedKey, JSON.stringify([...viewed]));
        }catch(e){}
      }

      location.hash = `post=${encodeURIComponent(id)}`;
      await render();
    }

    async function toggleLike(){
      if (!signedIn()) return toast("ë¡œê·¸ì¸ í›„ ì¢‹ì•„ìš” ê°€ëŠ¥");
      const postId = selectedPostId;
      if (!postId) return;

      const postRef = doc(db,"posts",postId);
      const likeRef = doc(db,"posts",postId,"likes",me.uid);

      try{
        await runTransaction(db, async (tx)=>{
          const likeSnap = await tx.get(likeRef);
          if (likeSnap.exists()){
            tx.delete(likeRef);
            tx.update(postRef, { likeCount: increment(-1) });
          } else {
            tx.set(likeRef, { uid: me.uid, createdAt: serverTimestamp() });
            tx.update(postRef, { likeCount: increment(1) });
          }
        });
        await render();
      }catch(e){
        toast("ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨");
      }
    }

    async function addComment(){
      if (!signedIn()) return toast("ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ ê°€ëŠ¥");
      const txt = ($("#cmt").value||"").trim();
      if (!txt) return toast("ëŒ“ê¸€ì„ ì…ë ¥í•´ì¤˜");
      const postId = selectedPostId;

      try{
        await addDoc(collection(db,"posts",postId,"comments"), {
          content: txt,
          authorUid: me.uid,
          authorNick: me.nick,
          isDeleted: false,
          createdAt: serverTimestamp()
        });
        await updateDoc(doc(db,"posts",postId), { commentCount: increment(1) });
        $("#cmt").value = "";
        toast("ëŒ“ê¸€ ë“±ë¡!");
        await render();
      }catch(e){
        toast("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
      }
    }

    async function softDeletePost(){
      const p = await fetchPost(selectedPostId);
      if (!canEditPost(p)) return toast("ì‚­ì œ ê¶Œí•œì´ ì—†ì–´");
      if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œ?")) return;

      try{
        await updateDoc(doc(db,"posts",p.id), { isDeleted:true, updatedAt: serverTimestamp() });
        toast("ì‚­ì œ ì™„ë£Œ");
        viewMode = "list";
        selectedPostId = null;
        location.hash = "";
        syncHeader();
        await render();
      }catch(e){
        toast("ì‚­ì œ ì‹¤íŒ¨");
      }
    }

    async function togglePin(){
      if (!isAdmin()) return toast("ê´€ë¦¬ìë§Œ ê³ ì • ê°€ëŠ¥");
      const p = await fetchPost(selectedPostId);
      if (!p) return;
      try{
        await updateDoc(doc(db,"posts",p.id), { pin: !p.pin, updatedAt: serverTimestamp() });
        toast(p.pin ? "ê³ ì • í•´ì œ" : "ê³ ì •");
        await render();
      }catch(e){
        toast("ê³ ì • ì‹¤íŒ¨");
      }
    }

    // ===== ê¸€ì“°ê¸°/ìˆ˜ì • ëª¨ë‹¬ =====
    const modalBg = $("#modalBg");
    const modalClose = $("#modalClose");
    const modalSave = $("#modalSave");
    const modalTitle = $("#modalTitle");
    const fCat = $("#fCat");
    const fTitle = $("#fTitle");
    const fContent = $("#fContent");
    const fPin = $("#fPin");
    let modalMode = "new"; // new | edit

    function openModal(mode){
      modalMode = mode;
      modalTitle.textContent = (mode==="new") ? "ê¸€ì“°ê¸°" : "ê¸€ ìˆ˜ì •";
      modalBg.classList.add("show");
      modalBg.setAttribute("aria-hidden","false");

      // ì¹´í…Œê³ ë¦¬ ì˜µì…˜(ì „ì²´ ì œì™¸)
      fCat.innerHTML = "";
      for (const c of cats){
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = `${c.name}${c.writePolicy==="admin" ? " (ê´€ë¦¬ìì „ìš©)" : ""}`;
        fCat.appendChild(opt);
      }

      // ê¸°ë³¸ ì„ íƒ: í˜„ì¬ ì¹´í…Œê³ ë¦¬(ì „ì²´ë©´ ì²« ì¹´í…Œê³ ë¦¬)
      if (currentCatId !== "all" && catMap.get(currentCatId)){
        fCat.value = currentCatId;
      } else if (cats[0]) {
        fCat.value = cats[0].id;
      }

      // pinì€ ê´€ë¦¬ìë§Œ
      fPin.disabled = !isAdmin();
      if (!isAdmin()) fPin.checked = false;

      if (mode==="new"){
        fTitle.value = "";
        fContent.value = "";
        fPin.checked = false;
      } else {
        fetchPost(selectedPostId).then(p=>{
          if (!p) return;
          fCat.value = p.categoryId || (cats[0]?.id || "");
          fTitle.value = p.title || "";
          fContent.value = p.content || "";
          fPin.checked = !!p.pin && isAdmin();
        });
      }

      updateCatHelp();
      fCat.onchange = updateCatHelp;
    }

    function updateCatHelp(){
      const c = catMap.get(fCat.value);
      if (!c) return $("#fCatHelp").textContent = "ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì¤˜";
      if (c.writePolicy === "admin"){
        $("#fCatHelp").textContent = "ğŸ”’ ê´€ë¦¬ìì „ìš© ì¹´í…Œê³ ë¦¬: ê´€ë¦¬ìë§Œ ê¸€ì“°ê¸° ê°€ëŠ¥";
      } else {
        $("#fCatHelp").textContent = "ì „ì²´ ê¸€ì“°ê¸° ê°€ëŠ¥(ë¡œê·¸ì¸ í•„ìš”)";
      }
    }

    function closeModal(){
      modalBg.classList.remove("show");
      modalBg.setAttribute("aria-hidden","true");
    }
    modalClose.addEventListener("click", closeModal);
    modalBg.addEventListener("click", (e)=>{ if(e.target===modalBg) closeModal(); });

    async function savePost(){
      const catId = fCat.value;
      const cat = catMap.get(catId);
      if (!cat) return toast("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì¤˜");

      if (!canWriteInCat(cat)) return toast("ì´ ì¹´í…Œê³ ë¦¬ëŠ” ê¸€ì“°ê¸° ê¶Œí•œì´ ì—†ì–´");

      const title = (fTitle.value||"").trim();
      const content = (fContent.value||"").trim();
      if (!title) return toast("ì œëª©ì„ ì…ë ¥í•´ì¤˜");
      if (!content) return toast("ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜");

      try{
        const pin = isAdmin() ? !!fPin.checked : false;

        if (modalMode === "new"){
          const ref = await addDoc(collection(db,"posts"), {
            categoryId: cat.id,
            categoryName: cat.name,           // ìŠ¤ëƒ…ìƒ·(ì—†ì–´ë„ ë˜ì§€ë§Œ í‘œì‹œ ì•ˆì •ìš©)
            categoryAdminOnly: cat.writePolicy==="admin",
            pin,
            title,
            content,
            authorUid: me.uid,
            authorNick: me.nick,
            isDeleted: false,
            likeCount: 0,
            viewCount: 0,
            commentCount: 0,
            createdAt: serverTimestamp(),
            updatedAt: null
          });
          closeModal();
          toast("ì‘ì„± ì™„ë£Œ!");
          await rebuildCounts();
          await openPost(ref.id);
        } else {
          const p = await fetchPost(selectedPostId);
          if (!canEditPost(p)) return toast("ìˆ˜ì • ê¶Œí•œì´ ì—†ì–´");

          await updateDoc(doc(db,"posts",p.id), {
            categoryId: cat.id,
            categoryName: cat.name,
            categoryAdminOnly: cat.writePolicy==="admin",
            pin,
            title,
            content,
            updatedAt: serverTimestamp()
          });
          closeModal();
          toast("ìˆ˜ì • ì™„ë£Œ!");
          await rebuildCounts();
          await render();
        }
      }catch(e){
        toast("ì €ì¥ ì‹¤íŒ¨");
      }
    }

    // ===== ì¹´í…Œê³ ë¦¬ ì¶”ê°€(ê´€ë¦¬ì) =====
    $("#btnAddCat").addEventListener("click", async ()=>{
      if (!isAdmin()) return toast("ê´€ë¦¬ìë§Œ ê°€ëŠ¥");
      const name = ($("#newCatName").value||"").trim();
      const writePolicy = ($("#newCatPolicy").value||"user") === "admin" ? "admin" : "user";
      if (!name) return toast("ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì¤˜");

      // order = max + 10
      const maxOrder = cats.reduce((m,c)=>Math.max(m, c.order ?? 0), 0);
      try{
        await addDoc(collection(db,"boardCategories"), {
          name,
          writePolicy,
          order: maxOrder + 10,
          isDeleted:false,
          createdAt: serverTimestamp(),
          updatedAt: null
        });
        $("#newCatName").value = "";
        toast("ì¹´í…Œê³ ë¦¬ ì¶”ê°€ë¨");
        await refreshCats();
      }catch(e){
        toast("ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì‹¤íŒ¨");
      }
    });

    // ===== ì´ë²¤íŠ¸ =====
    $("#btnRefresh").addEventListener("click", async () => { await refreshCats(); });
    $("#q").addEventListener("input", async () => { if(viewMode==="list") await renderList(); });
    $("#sort").addEventListener("change", async () => { await render(); });

    $("#btnBack").addEventListener("click", async ()=>{
      viewMode = "list";
      selectedPostId = null;
      location.hash = "";
      syncHeader();
      await render();
    });

    $("#btnLike").addEventListener("click", toggleLike);
    $("#btnCmt").addEventListener("click", addComment);
    $("#btnDelete").addEventListener("click", softDeletePost);
    $("#btnPin").addEventListener("click", togglePin);

    $("#btnCopy").addEventListener("click", async ()=>{
      const link = location.origin + location.pathname + `#post=${encodeURIComponent(selectedPostId||"")}`;
      try{ await navigator.clipboard.writeText(link); toast("ë§í¬ ë³µì‚¬ ì™„ë£Œ"); }
      catch(e){ toast("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ)"); }
    });

    $("#btnLogout").addEventListener("click", async ()=>{
      try{ await signOut(auth); toast("ë¡œê·¸ì•„ì›ƒ"); }
      catch(e){ toast("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨"); }
    });

    $("#btnNew").addEventListener("click", ()=>{
      const c = currentCatObj();
      if (!c) return toast("ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜");
      if (!canWriteInCat(c)) return toast("ì´ ì¹´í…Œê³ ë¦¬ëŠ” ê¸€ì“°ê¸° ê¶Œí•œì´ ì—†ì–´");
      openModal("new");
    });

    $("#btnEdit").addEventListener("click", async ()=>{
      const p = await fetchPost(selectedPostId);
      if (!canEditPost(p)) return toast("ìˆ˜ì • ê¶Œí•œì´ ì—†ì–´");
      openModal("edit");
    });

    modalSave.addEventListener("click", savePost);

    // ===== í•´ì‹œ ë¼ìš°íŒ… =====
    async function applyHash(){
      const h = (location.hash||"").replace(/^#/,"");
      if (!h) return;
      const [k,v] = h.split("=");
      if (k === "post" && v){
        const id = decodeURIComponent(v);
        const p = await fetchPost(id);
        if (p && !p.isDeleted){
          selectedPostId = id;
          viewMode = "detail";
          currentCatId = p.categoryId || "all";
          syncHeader();
        }
      }
    }
    window.addEventListener("hashchange", async ()=>{ await applyHash(); await render(); });

    // ===== ì´ˆê¸° + ë¡œê·¸ì¸ ê°ì§€ =====
    onAuthStateChanged(auth, async (u)=>{
      if (!u){
        me = { uid:null, nick:"ê²ŒìŠ¤íŠ¸", role:"guest" };
        setPills();
        // ë¡œê·¸ì¸ í•„ìš” ì •ì±…: ëª©ë¡/ì½ê¸°ëŠ” ë¡œê·¸ì¸ í•„ìš”ë©´ rulesì—ì„œ ë§‰í˜. UIëŠ” ê·¸ëƒ¥ ë³´ì—¬ì£¼ë˜ ë°ì´í„°ëŠ” ì•ˆ ëœ° ìˆ˜ ìˆìŒ.
        try{
          await fetchCategories();
          await rebuildCounts();
        }catch(e){}
        syncHeader();
        await applyHash();
        await render();
        return;
      }

      await loadMe(u.uid, u.email || null);
      setPills();

      await fetchCategories();
      await rebuildCounts();

      // ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆëŠ”ë° ì„ íƒë¼ ìˆìœ¼ë©´ allë¡œ
      if (currentCatId !== "all" && !catMap.get(currentCatId)){
        currentCatId = "all";
      }

      syncHeader();
      await applyHash();
      await render();
    });
  </script>
</body>
</html>
