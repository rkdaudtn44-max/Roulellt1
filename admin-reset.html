<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê´€ë¦¬ì ì „ì²´ ì´ˆê¸°í™”</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--pri:#5b7cff;--danger:#ef4444;--ok:#10b981;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
    .top{position:sticky;top:0;background:rgba(246,247,251,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line);z-index:10}
    .topin{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;gap:10px}
    .brand{font-weight:900}
    .wrap{max-width:980px;margin:16px auto;padding:0 16px 30px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin-bottom:12px}
    .h{margin:0 0 8px;font-weight:900}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    input{border:1px solid var(--line);border-radius:10px;padding:10px 12px;min-width:260px}
    pre{background:#0b1020;color:#d7e3ff;border-radius:12px;padding:12px;overflow:auto;font-size:12px;min-height:140px}
    .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:#fff}
    .lock{opacity:.5;pointer-events:none;filter:grayscale(1)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="top">
    <div class="topin">
      <div class="brand">ğŸ›¡ï¸ ê´€ë¦¬ì ì „ì²´ ì´ˆê¸°í™”</div>
      <div class="row">
        <button class="btn" id="homeBtn">í™ˆ</button>
        <button class="btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <p class="h">ì£¼ì˜</p>
      <p class="muted">
        ì•„ë˜ ì‘ì—…ì€ <b>ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</b><br>
        ì‹¤í–‰í•˜ë ¤ë©´ í™•ì¸ë¬¸êµ¬ì— <b>"ì´ˆê¸°í™”"</b>ë¥¼ ì…ë ¥í•œ ë’¤ ì§„í–‰í•˜ì„¸ìš”.<br>
        (ê¶Œí•œì´ adminì´ ì•„ë‹ˆë©´ ë²„íŠ¼ì´ ì ê¸°ê³ , Firestore Rulesì—ì„œë„ ì°¨ë‹¨ë©ë‹ˆë‹¤.)
      </p>

      <div class="row" style="margin-top:10px">
        <span class="tag">ë¡œê·¸ì¸: <b id="me">-</b></span>
        <span class="tag">ê¶Œí•œ: <b id="role">-</b></span>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="confirmWord" placeholder='ì—¬ê¸°ì— "ì´ˆê¸°í™”" ì…ë ¥' />
        <button class="btn ok" id="checkBtn">ê¶Œí•œ/ì—°ê²° í™•ì¸</button>
      </div>

      <p class="muted small" style="margin-top:10px">
        ì´ˆê¸°í™” ë²”ìœ„:
        <b>logs, counts, lottoPlays, publicUsers</b> ì „ì²´ ì‚­ì œ +
        <b>users</b> ì „ì²´ ìœ ì €ì˜ <b>xp/level/lottoTickets</b>ë§Œ ì´ˆê¸°í™” (role/nickname/email ìœ ì§€)
      </p>
    </div>

    <div class="grid">
      <div class="card" id="panelDelete">
        <p class="h">ê¸°ë¡ ì „ì²´ ì‚­ì œ</p>
        <div class="row" style="margin-bottom:10px">
          <button class="btn danger" id="resetRouletteBtn">ë£°ë › ê¸°ë¡ ì „ì²´ ì´ˆê¸°í™” (logs + counts)</button>
          <button class="btn danger" id="resetLottoBtn">ë³µê¶Œ ê¸°ë¡ ì „ì²´ ì´ˆê¸°í™” (lottoPlays)</button>
          <button class="btn danger" id="resetPublicBtn">publicUsers ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
        <p class="muted small">ë°ì´í„°ê°€ ë§ì•„ë„ ë°°ì¹˜ë¡œ ë‚˜ëˆ ì„œ ì‚­ì œí•©ë‹ˆë‹¤.</p>
      </div>

      <div class="card" id="panelUsers">
        <p class="h">ì „ì²´ ìœ ì € ì´ˆê¸°í™”</p>
        <p class="muted small">
          ëª¨ë“  users ë¬¸ì„œì˜ <b>xp=0, level=1, lottoTickets=0</b>ë¡œ ë¦¬ì…‹í•©ë‹ˆë‹¤.<br>
          <b>role/nickname/email/createdAt</b>ì€ ìœ ì§€í•©ë‹ˆë‹¤.
        </p>
        <div class="row" style="margin-top:10px">
          <button class="btn danger" id="resetUsersBtn">ì „ì²´ ìœ ì € xp/level/lottoTickets ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <div class="card">
      <p class="h">ì§„í–‰ ë¡œê·¸</p>
      <pre id="out">ëŒ€ê¸°ì¤‘...</pre>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, query, orderBy, limit, getDocs,
      startAfter, writeBatch
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // âœ… ë„¤ Firebase ì„¤ì •ìœ¼ë¡œ êµì²´
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const meEl = document.getElementById("me");
    const roleEl = document.getElementById("role");
    const confirmWord = document.getElementById("confirmWord");
    const out = document.getElementById("out");

    const panelDelete = document.getElementById("panelDelete");
    const panelUsers = document.getElementById("panelUsers");

    const log = (msg) => { out.textContent += "\\n" + msg; out.scrollTop = out.scrollHeight; };
    const setOut = (msg) => { out.textContent = msg; };

    let currentUser = null;
    let currentIsAdmin = false;

    function guardOrThrow(){
      if(!currentUser) throw new Error("ë¡œê·¸ì¸ í•„ìš”");
      if(!currentIsAdmin) throw new Error("admin ê¶Œí•œì´ ì•„ë‹™ë‹ˆë‹¤.");
      if(confirmWord.value.trim() !== "ì´ˆê¸°í™”") throw new Error('í™•ì¸ ë¬¸êµ¬ì— "ì´ˆê¸°í™”"ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    }

    async function checkAdmin(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      return snap.exists() && snap.data()?.role === "admin";
    }

    function confirmDanger(){
      // 2ì¤‘ í™•ì¸
      const ok1 = confirm("ì •ë§ ì§„í–‰í• ê¹Œìš”? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      if(!ok1) return false;
      const ok2 = confirm("ë§ˆì§€ë§‰ í™•ì¸: ì •ë§ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.");
      return ok2;
    }

    // ì»¬ë ‰ì…˜ ì „ì²´ ì‚­ì œ (ë°°ì¹˜ ë°˜ë³µ)
    async function deleteCollection(collName, pageSize=450){
      setOut(`[${collName}] ì‚­ì œ ì‹œì‘...`);
      let last = null;
      let total = 0;

      while(true){
        const qy = query(
          collection(db, collName),
          orderBy("__name__"),
          limit(pageSize),
          ...(last ? [startAfter(last)] : [])
        );

        const snap = await getDocs(qy);
        if(snap.empty) break;

        const batch = writeBatch(db);
        snap.docs.forEach(d => batch.delete(d.ref));
        await batch.commit();

        total += snap.size;
        last = snap.docs[snap.docs.length - 1];
        log(`[${collName}] ${total}ê°œ ì‚­ì œ ì™„ë£Œ...`);
      }

      log(`[${collName}] ì‚­ì œ ë. ì´ ${total}ê°œ`);
    }

    // users ì „ì²´ ì´ˆê¸°í™” (role/nickname/email/createdAt ìœ ì§€)
    async function resetAllUsers(pageSize=450){
      setOut(`[users] ì „ì²´ ìœ ì € ì´ˆê¸°í™” ì‹œì‘... (xp/level/lottoTickets)`);
      let last = null;
      let total = 0;

      while(true){
        const qy = query(
          collection(db, "users"),
          orderBy("__name__"),
          limit(pageSize),
          ...(last ? [startAfter(last)] : [])
        );

        const snap = await getDocs(qy);
        if(snap.empty) break;

        const batch = writeBatch(db);
        snap.docs.forEach(d => {
          batch.update(d.ref, {
            xp: 0,
            level: 1,
            lottoTickets: 0,
          });
        });

        await batch.commit();

        total += snap.size;
        last = snap.docs[snap.docs.length - 1];
        log(`[users] ${total}ëª… ì´ˆê¸°í™” ì™„ë£Œ...`);
      }

      log(`[users] ì´ˆê¸°í™” ë. ì´ ${total}ëª…`);
    }

    function lockPanels(lock){
      [panelDelete, panelUsers].forEach(p => {
        if(lock) p.classList.add("lock");
        else p.classList.remove("lock");
      });
    }

    // ë²„íŠ¼ë“¤
    document.getElementById("homeBtn").onclick = () => location.href = "./index.html";
    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      location.href = "./index.html";
    };

    document.getElementById("checkBtn").onclick = async () => {
      if(!currentUser){
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }
      currentIsAdmin = await checkAdmin(currentUser.uid);
      roleEl.textContent = currentIsAdmin ? "admin" : "user";
      lockPanels(!currentIsAdmin);
      setOut(currentIsAdmin ? "âœ… admin í™•ì¸ ì™„ë£Œ. í™•ì¸ë¬¸êµ¬ì— 'ì´ˆê¸°í™”' ì…ë ¥ í›„ ì‹¤í–‰í•˜ì„¸ìš”." : "âŒ admin ê¶Œí•œì´ ì•„ë‹™ë‹ˆë‹¤.");
    };

    document.getElementById("resetRouletteBtn").onclick = async () => {
      try{
        guardOrThrow();
        if(!confirmDanger()) return;
        await deleteCollection("logs");
        await deleteCollection("counts");
        alert("ë£°ë › ê¸°ë¡(logs) + ì¹´ìš´íŠ¸(counts) ì´ˆê¸°í™” ì™„ë£Œ");
      }catch(e){
        alert(e.message || String(e));
      }
    };

    document.getElementById("resetLottoBtn").onclick = async () => {
      try{
        guardOrThrow();
        if(!confirmDanger()) return;
        await deleteCollection("lottoPlays");
        alert("ë³µê¶Œ ê¸°ë¡(lottoPlays) ì´ˆê¸°í™” ì™„ë£Œ");
      }catch(e){
        alert(e.message || String(e));
      }
    };

    document.getElementById("resetPublicBtn").onclick = async () => {
      try{
        guardOrThrow();
        if(!confirmDanger()) return;
        await deleteCollection("publicUsers");
        alert("publicUsers ì´ˆê¸°í™” ì™„ë£Œ");
      }catch(e){
        alert(e.message || String(e));
      }
    };

    document.getElementById("resetUsersBtn").onclick = async () => {
      try{
        guardOrThrow();
        if(!confirmDanger()) return;
        await resetAllUsers();
        alert("ì „ì²´ ìœ ì € ì´ˆê¸°í™” ì™„ë£Œ (xp/level/lottoTickets)");
      }catch(e){
        alert(e.message || String(e));
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        location.href = "./index.html";
        return;
      }
      currentUser = user;
      meEl.textContent = user.email || user.uid;

      currentIsAdmin = await checkAdmin(user.uid);
      roleEl.textContent = currentIsAdmin ? "admin" : "user";
      lockPanels(!currentIsAdmin);

      setOut(currentIsAdmin
        ? "âœ… adminìœ¼ë¡œ ë¡œê·¸ì¸ë¨. í™•ì¸ë¬¸êµ¬ì— 'ì´ˆê¸°í™”' ì…ë ¥ í›„ ì‹¤í–‰í•˜ì„¸ìš”."
        : "âŒ admin ê¶Œí•œì´ ì•„ë‹™ë‹ˆë‹¤. ì‹¤í–‰ ë¶ˆê°€"
      );
    });
  </script>
</body>
</html>
