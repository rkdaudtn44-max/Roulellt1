<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë£°ë ›</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--pri:#5b7cff;--good:#10b981;--bad:#ef4444;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}

    /* âœ… ê³µí†µ ìƒë‹¨ë°”: ì–´ë””ì„œë“  ë™ì¼í•˜ê²Œ ë³´ì´ë„ë¡ wrap í—ˆìš© */
    .top{
      position:sticky;top:0;background:rgba(246,247,251,.9);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex;gap:10px;align-items:center;z-index:10;
      flex-wrap:wrap;
    }

    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .wrap{max-width:820px;margin:0 auto;padding:14px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 8px 30px rgba(16,24,40,.06);}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .seg{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;font-weight:900;cursor:pointer}
    .pill.on{background:#111827;color:#fff;border-color:#111827}
    h2{margin:0 0 10px;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .list{border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .li{display:flex;justify-content:space-between;gap:10px;padding:10px 12px;border-top:1px solid var(--line);background:#fff}
    .li:first-child{border-top:none}
    .li b{font-size:14px}
    .li span{color:var(--muted);font-weight:800}
    .result{font-size:18px;font-weight:900}
    .small{font-size:12px;color:var(--muted)}

    .spinBox{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spinCount, .nickInput, .ticketInput{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      font-weight:900;
      font-size:15px;
      background:#fff;
    }
    .spinCount{width:86px;text-align:center}
    .nickInput{width:160px}
    .ticketInput{width:120px;text-align:center}
    .spinHint{font-size:12px;color:var(--muted)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .ok{color:var(--good);font-weight:900;font-size:13px}
    .bad{color:var(--bad);font-weight:900;font-size:13px;white-space:pre-wrap}

    /* í°í™”ë©´ ë°©ì§€ìš© ì¹˜ëª…ì  ì˜¤ë¥˜ ë°•ìŠ¤ */
    .fatal{
      max-width:820px;margin:14px auto 0;padding:12px 14px;
      background:#fff1f2;border:1px solid #fecdd3;border-radius:14px;
      color:#9f1239;font-weight:900;display:none;white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div id="fatal" class="fatal"></div>

  <!-- âœ… ìƒë‹¨ ê³µí†µë°”(ë£°ë ›/ê¸°ë¡/ë³µê¶Œ) + ë‹‰ë„¤ì„/ë¡œê·¸ì•„ì›ƒ ìœ ì§€ -->
  <div class="top">
    <button class="btn" onclick="location.href='roulette.html'">ğŸ¯ ë£°ë ›</button>
    <button class="btn" onclick="location.href='log.html'">ğŸ“’ ê¸°ë¡</button>
    <button class="btn" onclick="location.href='lotto.html'">ğŸŸï¸ ë³µê¶Œ</button>

    <div style="flex:1"></div>
    <div class="muted" id="who"></div>
    <button class="btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h2>ë£°ë › í˜ì´ì§€</h2>
          <div class="muted">ê´€ë¦¬ìë§Œ ë£°ë ›ì„ ëŒë¦´ ìˆ˜ ìˆì–´ìš”. (ì €ì¥ì€ Firestoreë¡œ ê³µìœ ë©ë‹ˆë‹¤)</div>
        </div>

        <div class="spinBox">
          <button class="btn pri" id="spinBtn">ë£°ë › ëŒë¦¬ê¸°</button>
          <input class="spinCount" id="spinCount" type="number" min="1" max="999" value="1" inputmode="numeric" />
          <input class="nickInput" id="targetNick" placeholder="ê¸°ë¡ë  ë‹‰ë„¤ì„(ê´€ë¦¬ì)" />
        </div>
      </div>

      <div class="spinHint" id="hintText">
        * ìˆ«ì ì…ë ¥ í›„ ë²„íŠ¼ ëˆ„ë¥´ë©´ ê·¸ íšŸìˆ˜ë§Œí¼ ì—°ì†ìœ¼ë¡œ ì €ì¥ë¼ìš”.
      </div>

      <!-- ê´€ë¦¬ì ìˆ˜ë™ ì§€ê¸‰ UI -->
      <div id="grantBox" style="display:none">
        <div class="hr"></div>
        <div class="row" style="align-items:flex-start">
          <div>
            <div style="font-weight:900">ğŸŸï¸ ë³µê¶Œ í‹°ì¼“ ìˆ˜ë™ì§€ê¸‰(ê´€ë¦¬ì)</div>
            <div class="muted">ì „ì²´ ì§€ê¸‰ ë˜ëŠ” ë‹‰ë„¤ì„ 1ëª…ì—ê²Œ ì§€ê¸‰í•  ìˆ˜ ìˆì–´ìš”.</div>
          </div>
          <div class="spinBox">
            <input class="ticketInput" id="grantAmount" type="number" min="1" max="1000000" value="1" inputmode="numeric" />
            <button class="btn pri" id="grantToNickBtn">ë‹‰ë„¤ì„ ì§€ê¸‰</button>
            <button class="btn danger" id="grantAllBtn">ì „ì²´ ì§€ê¸‰</button>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">
          - ë‹‰ë„¤ì„ ì§€ê¸‰: ìœ„ìª½ â€œê¸°ë¡ë  ë‹‰ë„¤ì„â€ ì¹¸ ê¸°ì¤€ìœ¼ë¡œ ì§€ê¸‰<br/>
          - ì „ì²´ ì§€ê¸‰: ê°€ì…ëœ ì „ì²´ ìœ ì €(= nicknames ì»¬ë ‰ì…˜ ê¸°ì¤€)ì—ê²Œ ë™ì¼ ìˆ˜ëŸ‰ ì§€ê¸‰
        </div>
        <div style="height:8px"></div>
        <div class="ok" id="grantOk" style="display:none"></div>
        <div class="bad" id="grantErr" style="display:none"></div>
      </div>

      <div style="height:10px"></div>

      <div class="seg" id="typeSeg"></div>

      <div style="height:12px"></div>

      <div class="muted">í˜„ì¬ ë£°ë › í•­ëª©</div>
      <div class="list" id="itemsBox"></div>

      <div style="height:12px"></div>
      <div class="result" id="resultText">ê²°ê³¼: -</div>
      <div class="small" id="resultMeta"></div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    const fatalEl = document.getElementById("fatal");
    function fatal(msg){
      fatalEl.style.display = "block";
      fatalEl.textContent = String(msg || "ì˜¤ë¥˜");
    }

    // í°í™”ë©´ ë°©ì§€: ì „ì—­ ì˜¤ë¥˜ í‘œì‹œ
    window.addEventListener("error", (e)=> {
      fatal("JS ì˜¤ë¥˜: " + (e.message || e.error || e));
    });
    window.addEventListener("unhandledrejection", (e)=>{
      fatal("Promise ì˜¤ë¥˜: " + (e.reason?.message || e.reason || e));
    });

    try {
      const firebaseConfig = {
        apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
        authDomain: "roulette-b5455.firebaseapp.com",
        projectId: "roulette-b5455",
        storageBucket: "roulette-b5455.firebasestorage.app",
        messagingSenderId: "728191308035",
        appId: "1:728191308035:web:b14b46c38bbe0261969936"
      };

      if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

      const auth = firebase.auth();
      const db = firebase.firestore();
      const $ = (id)=>document.getElementById(id);

      // ê´€ë¦¬ì ì´ë©”ì¼
      const ADMIN_EMAILS = ["dori0223@gmail.com"];

      function escapeHtml(s){
        return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }

      // âœ… í•µì‹¬ ìˆ˜ì •: unescape ì œê±° (iOS/Safari í°í™”ë©´ ì›ì¸ ì œê±°)
      function encodeKey(s){
        const bytes = new TextEncoder().encode(String(s ?? ""));
        let binary = "";
        for (let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
        const b64 = btoa(binary);
        return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      }

      function normNick(v){
        return String(v ?? "").normalize("NFC").trim().replace(/\s+/g, " ");
      }
      function validateNickForDocId(nick){
        if(!nick) return "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜.";
        if(/[\/\\]/.test(nick)) return "ë‹‰ë„¤ì„ì— / ë˜ëŠ” \\ ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ì–´.";
        return "";
      }

      function showGrantOk(m){
        const ok = $("grantOk"), er = $("grantErr");
        er.style.display="none"; er.textContent="";
        ok.style.display="block"; ok.textContent=m;
      }
      function showGrantErr(e){
        const ok = $("grantOk"), er = $("grantErr");
        ok.style.display="none"; ok.textContent="";
        er.style.display="block"; er.textContent="ì˜¤ë¥˜: " + (e?.message || e);
      }
      function clearGrantMsg(){
        $("grantOk").style.display="none"; $("grantOk").textContent="";
        $("grantErr").style.display="none"; $("grantErr").textContent="";
      }

      function readGrantAmount(){
        const el = $("grantAmount");
        let n = parseInt(el.value, 10);
        if(!Number.isFinite(n) || n < 1) n = 1;
        if(n > 1000000) n = 1000000;
        el.value = String(n);
        return n;
      }

      function readSpinCount(){
        const el = $("spinCount");
        let n = parseInt(el.value, 10);
        if(!Number.isFinite(n) || n < 1) n = 1;
        if(n > 999) n = 999;
        el.value = String(n);
        return n;
      }

      async function getProfile(uid){
        const snap = await db.collection("users").doc(uid).get();
        return snap.exists ? snap.data() : null;
      }

      async function nicknameExists(nickRaw){
        const nick = normNick(nickRaw);
        const err = validateNickForDocId(nick);
        if(err) throw new Error(err);
        const snap = await db.collection("nicknames").doc(nick).get();
        return snap.exists;
      }

      async function getUidByNickname(nickRaw){
        const nick = normNick(nickRaw);
        const err = validateNickForDocId(nick);
        if(err) throw new Error(err);
        const snap = await db.collection("nicknames").doc(nick).get();
        if(!snap.exists) return null;
        return snap.data()?.uid || null;
      }

      async function getAllUidsFromNicknames(){
        const snaps = await db.collection("nicknames").get();
        const uids = [];
        snaps.forEach(d=>{
          const uid = d.data()?.uid;
          if(uid) uids.push(uid);
        });
        return Array.from(new Set(uids));
      }

      function parseLottoTicketAmount(itemText){
        const s = String(itemText || "");
        if(!s.includes("ë³µê¶Œ")) return 0;
        const m = s.match(/(\d+)/);
        if(!m) return 1;
        const n = parseInt(m[1], 10);
        if(!Number.isFinite(n) || n <= 0) return 1;
        return n;
      }
      function isLottoItem(itemText){
        return String(itemText || "").includes("ë³µê¶Œ");
      }

      async function grantLottoTicketsToUid(uid, ticketsToAdd){
        ticketsToAdd = Number(ticketsToAdd || 0);
        if(!Number.isFinite(ticketsToAdd) || ticketsToAdd <= 0) return;

        const userRef = db.collection("users").doc(uid);
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(userRef);
          if(!snap.exists) throw new Error("í•´ë‹¹ ìœ ì € users ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
          const cur = Number(snap.data()?.lottoTickets || 0);
          tx.update(userRef, {
            lottoTickets: cur + ticketsToAdd,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
      }

      async function grantLottoTicketsToNickname(targetNickRaw, ticketsToAdd){
        const uid = await getUidByNickname(targetNickRaw);
        const targetNick = normNick(targetNickRaw);
        if(!uid) throw new Error(`ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‹‰ë„¤ì„: ${targetNick}`);
        await grantLottoTicketsToUid(uid, ticketsToAdd);
      }

      $("logoutBtn").addEventListener("click", async ()=>{
        await auth.signOut();
        location.replace("index.html");
      });

      // ë£°ë › ëª©ë¡
      const ROULETTES = {
        normal: { label: "ê¸°ë³¸", items: [
          { text: "ëƒ¥ë©ì²´[3ë¶„]", w: 1.7 },
          { text: "ì›í•˜ëŠ”ì²´[3ë¶„_5ê¸€ì]", w: 1.7 },
          { text: "ì§§ì€ì• êµëŒ€ì‚¬[5ì¤„ ì´í•˜]", w: 0.85 },
          { text: "íŒ¬ë³´ë“œ", w: 0.85 },
          { text: "í˜€ë´‰ì¸[1ë¶„]", w: 1.7 },
          { text: "ë°›ì¹¨ë´‰ì¸[1ë¶„]", w: 1.7 },
          { text: "ì˜ ì–´ê¸ˆì§€[3ë¶„]", w: 1.7 },
          { text: "ì¹¨ë±‰ê¸°", w: 1.7 },
          { text: "ì§§ì€íŒ¬ë³´ë“œ[1~2ì¤„]", w: 1.7 },
          { text: "ì‹¤ë“œ+100", w: 2.3 },
          { text: "ì‹¤ë“œ-100", w: 2.3 },
          { text: "ASMRë°©ì†¡[3ë¶„]", w: 1.7 },
          { text: "ë£°ë › ë‹¤ëŒê¶Œ", w: 3.4 },
          { text: "í—¬ê¸° ë¦¬ì•¡[í‚µx]", w: 1.7 },
          { text: "ã…‡ë°›ì¹¨ì²´[2ë¶„]", w: 1.7 },
          { text: "ì¶œì„ì²´í¬ ë¦¬ì•¡[í‚µx]", w: 3.4 },
          { text: "ë¸Œë¼ë³´[í‚µx]", w: 3.4 },
          { text: "3ì¸ì¹­[1ë¶„]", w: 3.4 },
          { text: "ë°©ì¢…ê¹Œì§€ ì‰´ë“œ 0ê°œ[í‚µx]", w: 0.85 },
          { text: "ë°œë°•ìˆ˜", w: 3.4 },
          { text: "ë°©ì œ ë³€ê²½ê¶Œ[10ë¶„/í‚µ ë¶ˆê°€]", w: 1.7 },
          { text: "ë°°ê²½ì‚¬ì§„ ë³€ê²½ê¶Œ[10ë¶„/í‚µ ë¶ˆê°€]", w: 1.7 },
          { text: "ì—°í•˜ì¶©ì• êµë„ë¦¬[1ë¶„]", w: 0.85 },
          { text: "ë´‰ì¸ì¶”ê°€", w: 1.7 },
          { text: "ë´‰ì¸ì œê±°", w: 1.7 },
          { text: "ì´ì‘¤ì‹œê°œ ë¦¬ì•¡ì…˜[í‚µx]", w: 1.7 },
          { text: "ë°°í†µí†µ[í‚µx]", w: 3.4 },
          { text: "ê³µì§€ë³€ê²½ê¶Œ[ë‹¤ìŒ ë°©ì†¡ê¹Œì§€]", w: 1.7 },
          { text: "ë°•ìˆ˜ 3ë²ˆ[í‚µx]", w: 3.4 },
          { text: "íˆ¬ëª…ì˜ì 1ë¶„[í‚µx]", w: 1.7 },
          { text: "ìŠ¤ì¿¼íŠ¸ 5ê°œ[í‚µx]", w: 1.7 },
          { text: "ë²½ì°[í‚µx]", w: 3.4 },
          { text: "TMI 1ê°œ ì˜¬ë¦¬ê¸°", w: 1.7 },
          { text: "ì´ë¦„ 3ë²ˆ ë¶ˆëŸ¬ì£¼ê¸°", w: 1.7 },
          { text: "ë³µê¶Œ 1ê°œ ì§€ê¸‰", w: 8 },
          { text: "ë³µê¶Œ 10ê°œ ì§€ê¸‰", w: 6 },
          { text: "ë³µê¶Œ 20ê°œ ì§€ê¸‰", w: 3 },
          { text: "ë³µê¶Œ 30ê°œ ì§€ê¸‰", w: 1.7 },
          { text: "ê½", w: 12.1 }
        ]},
        noble: { label: "ê·€ì¡±", items: [
          { text: "24ì‹œê°„ ë‹‰ë³€ê¶Œ", w: 5 },
          { text: "24ì‹œê°„ ì—­ë‹‰ë³€ê¶Œ", w: 5 },
          { text: "ì›í•˜ëŠ” ë…¹ìŒë³¸ ë³´ë‚´ì£¼ê¸°[ì§§ì€ ì• êµ/ì›í•˜ëŠ” ëŒ€ì‚¬/ë¦¬ì•¡ì…˜]", w: 4 },
          { text: "ë‹¨ë… ë°•ì œí¸ì§€", w: 4 },
          { text: "ë£°ë › ì„ íƒê¶Œ[ê¸°ë³¸ or ê·€ì¡± ì¤‘ ì›í•˜ëŠ” ê²ƒ í•˜ë‚˜ ê³ ë¥´ê¸°]", w: 4 },
          { text: "ìºìŠ¤íŠ¸ ì €ì¥ê¶Œ 2íšŒ", w: 13 },
          { text: "ì‹¤ë“œ 2ë°°", w: 5 },
          { text: "ì‹¤ë“œí‘ 2ë°°", w: 5 },
          { text: "ê·€ì¡±ë£°ë › í• ì¸ê¶Œ(250ìŠ¤í‘¼,3ë¶„/ë³¸ì¸ë§Œ ì‚¬ìš© ê°€ëŠ¥)", w: 4 },
          { text: "ê·€ì¡±ë£°ë › ë‹¤ëŒê¶Œ", w: 10 },
          { text: "ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ìºìŠ¤íŠ¸ ì €ì¥ê¶Œ", w: 5 },
          { text: "ì›í•˜ëŠ” ë…¹ìŒë³¸ ìºìŠ¤íŠ¸[ì§§ì€ ì• êµ/ì›í•˜ëŠ” ëŒ€ì‚¬/ë¦¬ì•¡ì…˜/1ì¼]", w: 4 },
          { text: "ì‹¤ë“œ ìŒìˆ˜ë¡œ ë³€ê²½", w: 4 },
          { text: "ì‹¤ë“œ ì–‘ìˆ˜ë¡œ ë³€ê²½", w: 4 },
          { text: "ê²Œì„ ë°ì´íŠ¸ê¶Œ[1ì‹œê°„/ë§ˆì´í¬ ì‚¬ìš©ì€ ìƒëŒ€ë°©ì— ë”°ë¼]", w: 4 },
          { text: "íŒ¬ë³´ë“œ 3ê°œ ì¶”ê°€", w: 5 },
          { text: "ë³µê¶Œ 100ì¥", w: 5 },
          { text: "ë³µê¶Œ 1000ì¥", w: 5 },
          { text: "ë„ë¦¬ ìš©ëˆ", w: 5 }
        ]},
        time: { label: "ì‹œê°„", items: [
          { text: "ë°©ì†¡ ì—°ì¥ê¶Œ +1ë¶„", w: 41 },
          { text: "ë°©ì†¡ ì—°ì¥ê¶Œ +10ë¶„", w: 5 },
          { text: "ë°©ì†¡ ì—°ì¥ê¶Œ +20ë¶„", w: 3 },
          { text: "ë°©ì†¡ ì—°ì¥ê¶Œ +30ë¶„", w: 1 },
          { text: "ë°©ì†¡ ë‹¨ì¶•ê¶Œ -1ë¶„", w: 41 },
          { text: "ë°©ì†¡ ë‹¨ì¶•ê¶Œ -10ë¶„", w: 5 },
          { text: "ë°©ì†¡ ë‹¨ì¶•ê¶Œ -20ë¶„", w: 3 },
          { text: "ë°©ì†¡ ë‹¨ì¶•ê¶Œ -30ë¶„", w: 1 }
        ]}
      };

      let profile = null;
      let isAdmin = false;

      // UI: íƒ€ì… íƒ­
      let currentType = "normal";
      const typeSeg = $("typeSeg");
      const itemsBox = $("itemsBox");

      function renderTypes(){
        typeSeg.innerHTML = "";
        Object.keys(ROULETTES).forEach(key=>{
          const b = document.createElement("button");
          b.className = "pill" + (key===currentType ? " on" : "");
          b.textContent = ROULETTES[key].label;
          b.onclick = ()=>{ currentType = key; renderTypes(); renderItems(); };
          typeSeg.appendChild(b);
        });
      }
      function renderItems(){
        const items = ROULETTES[currentType].items || [];
        itemsBox.innerHTML = "";
        items.forEach(it=>{
          const row = document.createElement("div");
          row.className = "li";
          row.innerHTML = `<b>${escapeHtml(it.text || "-")}</b><span>${Number(it.w||0)}%</span>`;
          itemsBox.appendChild(row);
        });
      }
      renderTypes(); renderItems();

      function pickWeighted(items){
        const cleaned = items
          .map(x=>({ text: String(x.text||"").trim(), w: Number(x.w||0) }))
          .filter(x=>x.text.length>0 && x.w>0);
        const total = cleaned.reduce((a,b)=>a+b.w,0);
        if(total<=0) return { text:"-" };
        let r = Math.random()*total;
        for(const it of cleaned){
          r -= it.w;
          if(r<=0) return it;
        }
        return cleaned[cleaned.length-1] || { text:"-" };
      }

      async function getTargetNick(){
        if(!isAdmin) return profile.nickname;

        const v = normNick(($("targetNick").value || ""));
        const target = v.length ? v : normNick(profile.nickname);

        const err = validateNickForDocId(target);
        if(err) throw new Error(err);

        const ok = await nicknameExists(target);
        if(!ok) throw new Error(`ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë‹‰ë„¤ì„: ${target}`);

        localStorage.setItem("lastTargetNick", target);
        return target;
      }

      async function applyDelta(nickRaw, type, itemText, delta){
        const nick = normNick(nickRaw);
        const err = validateNickForDocId(nick);
        if(err) throw new Error(err);

        const itemId = encodeKey(itemText);

        const nickRef = db.collection("counts").doc(nick);
        const typeRef = nickRef.collection("types").doc(type);
        const itemRef = typeRef.collection("items").doc(itemId);

        await nickRef.set({ nick, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
        await typeRef.set({ type, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });

        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(itemRef);
          if(!snap.exists){
            if(delta <= 0) return;
            tx.set(itemRef, { itemText, count: delta, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            return;
          }
          const cur = Number(snap.data().count || 0);
          const next = Math.max(0, cur + delta);
          if(next === 0) tx.delete(itemRef);
          else tx.update(itemRef, { count: next, itemText, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        });
      }

      // ìˆ˜ë™ ì§€ê¸‰ ë²„íŠ¼
      $("grantToNickBtn").addEventListener("click", async ()=>{
        clearGrantMsg();
        try{
          if(!isAdmin) return;
          const amount = readGrantAmount();
          const targetNick = await getTargetNick();
          $("grantToNickBtn").disabled = true;
          $("grantAllBtn").disabled = true;
          await grantLottoTicketsToNickname(targetNick, amount);
          showGrantOk(`âœ… '${targetNick}' ë‹˜ì—ê²Œ í‹°ì¼“ +${amount} ì§€ê¸‰ ì™„ë£Œ`);
        }catch(e){
          showGrantErr(e);
        }finally{
          $("grantToNickBtn").disabled = false;
          $("grantAllBtn").disabled = false;
        }
      });

      $("grantAllBtn").addEventListener("click", async ()=>{
        clearGrantMsg();
        try{
          if(!isAdmin) return;
          const amount = readGrantAmount();
          if(!confirm(`ì •ë§ë¡œ ì „ì²´ ìœ ì €ì—ê²Œ í‹°ì¼“ ${amount}ì¥ì”© ì§€ê¸‰í• ê¹Œìš”?`)) return;

          $("grantToNickBtn").disabled = true;
          $("grantAllBtn").disabled = true;

          const uids = await getAllUidsFromNicknames();
          if(uids.length === 0) throw new Error("ì „ì²´ ì§€ê¸‰ ì‹¤íŒ¨: nicknames ì»¬ë ‰ì…˜ì— ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.");

          let done = 0;
          for(const uid of uids){
            await grantLottoTicketsToUid(uid, amount);
            done++;
            if(done % 25 === 0) await new Promise(r=>setTimeout(r, 30));
          }
          showGrantOk(`âœ… ì „ì²´ ì§€ê¸‰ ì™„ë£Œ: ${uids.length}ëª… Ã— ${amount}ì¥`);
        }catch(e){
          showGrantErr(e);
        }finally{
          $("grantToNickBtn").disabled = false;
          $("grantAllBtn").disabled = false;
        }
      });

      // ë¡œê·¸ì¸ ìƒíƒœ
      auth.onAuthStateChanged(async (u)=>{
        if(!u){ location.replace("index.html"); return; }

        profile = await getProfile(u.uid);
        if(!profile){ location.replace("index.html"); return; }

        profile.nickname = normNick(profile.nickname);
        const email = String(u.email || "").toLowerCase();
        isAdmin = ADMIN_EMAILS.includes(email);

        $("who").textContent = `${profile.nickname} Â· ${isAdmin ? "admin" : "user"}`;
        $("grantBox").style.display = isAdmin ? "block" : "none";

        const spinBtn = $("spinBtn");
        const nickInput = $("targetNick");
        const hintText = $("hintText");

        if(!isAdmin){
          nickInput.style.display = "none";
          spinBtn.disabled = true;
          hintText.textContent = "* ì¼ë°˜ ìœ ì €ëŠ” ë£°ë ›ì„ ëŒë¦´ ìˆ˜ ì—†ì–´ìš”. (ê¸°ë¡ ë³´ê¸°ë§Œ ê°€ëŠ¥)";
        } else {
          nickInput.style.display = "";
          spinBtn.disabled = false;
          const last = localStorage.getItem("lastTargetNick") || "";
          nickInput.value = last;
          hintText.textContent = "* (ê´€ë¦¬ì) ê¸°ë¡ë  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ëŒë¦¬ë©´ ê·¸ ì‚¬ëŒ ê¸°ë¡ìœ¼ë¡œ ì €ì¥ë¼ìš”.";
        }
      });

      // ë£°ë › ì‹¤í–‰
      $("spinBtn").addEventListener("click", async ()=>{
        const spinBtn = $("spinBtn");
        try{
          if(!isAdmin){
            alert("ê´€ë¦¬ìë§Œ ë£°ë ›ì„ ëŒë¦´ ìˆ˜ ìˆì–´ìš”.");
            return;
          }

          const n = readSpinCount();
          const targetNick = await getTargetNick();
          spinBtn.disabled = true;

          const pack = ROULETTES[currentType];
          const tally = new Map();
          let lastItem = "-";
          let totalTicketsToGrant = 0;

          for(let i=0;i<n;i++){
            const picked = pickWeighted(pack.items || []);
            const itemText = (picked.text && picked.text.trim()) ? picked.text.trim() : "-";
            tally.set(itemText, (tally.get(itemText)||0) + 1);
            lastItem = itemText;

            const amt = parseLottoTicketAmount(itemText);
            if(amt > 0) totalTicketsToGrant += amt;

            if(i % 200 === 199) await new Promise(r=>setTimeout(r, 0));
          }

          // counts ì €ì¥ (ë³µê¶Œ í•­ëª©ì€ countsì— ì €ì¥ ì•ˆí•¨)
          for(const [itemText, cnt] of tally.entries()){
            if(isLottoItem(itemText)) continue;
            await applyDelta(targetNick, currentType, itemText, cnt);
          }

          // ë³µê¶Œ í‹°ì¼“ ìë™ ì§€ê¸‰
          if(totalTicketsToGrant > 0){
            await grantLottoTicketsToNickname(targetNick, totalTicketsToGrant);
          }

          const extra = totalTicketsToGrant > 0 ? ` Â· ìë™ë³µê¶Œ í‹°ì¼“ +${totalTicketsToGrant}` : "";
          $("resultText").textContent = `ê²°ê³¼: ${lastItem} (ì´ ${n}íšŒ ì²˜ë¦¬${extra})`;
          $("resultMeta").textContent =
            `${ROULETTES[currentType].label} Â· ëŒ€ìƒ: ${targetNick} Â· ${new Date().toLocaleString("ko-KR")}`;
        }catch(e){
          alert(e?.message || e);
        }finally{
          spinBtn.disabled = !isAdmin;
        }
      });

    } catch (e) {
      fatal("ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜:\n" + (e?.message || e));
    }
  })();
  </script>
</body>
</html>
