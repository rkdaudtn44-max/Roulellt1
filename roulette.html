<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>룰렛</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--pri:#5b7cff;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
    .top{position:sticky;top:0;background:rgba(246,247,251,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;z-index:10;}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .wrap{max-width:820px;margin:0 auto;padding:14px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 8px 30px rgba(16,24,40,.06);}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .seg{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;font-weight:900;cursor:pointer}
    .pill.on{background:#111827;color:#fff;border-color:#111827}
    h2{margin:0 0 10px;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .list{border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .li{display:flex;justify-content:space-between;gap:10px;padding:10px 12px;border-top:1px solid var(--line);background:#fff}
    .li:first-child{border-top:none}
    .li b{font-size:14px}
    .li span{color:var(--muted);font-weight:800}
    .result{font-size:18px;font-weight:900}
    .small{font-size:12px;color:var(--muted)}
    .spinBox{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spinCount, .nickInput{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      font-weight:900;
      font-size:15px;
      background:#fff;
    }
    .spinCount{width:86px;text-align:center}
    .nickInput{width:160px}
    .spinHint{font-size:12px;color:var(--muted)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="top">
    <button class="btn" onclick="location.href='log.html'">기록 보기</button>
    <div style="flex:1"></div>
    <div class="muted" id="who"></div>
    <button class="btn" id="logoutBtn">로그아웃</button>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h2>룰렛 페이지</h2>
          <div class="muted">관리자만 돌릴 수 있고, 결과는 모든 기기에서 공유돼요(Firestore).</div>
        </div>

        <div class="spinBox">
          <button class="btn pri" id="spinBtn">룰렛 돌리기</button>
          <input class="spinCount" id="spinCount" type="number" min="1" max="999" value="1" inputmode="numeric" />
          <input class="nickInput" id="targetNick" placeholder="기록될 닉네임(관리자)" />
        </div>
      </div>
      <div class="spinHint" id="hintText">* 숫자 입력 후 버튼 누르면 그 횟수만큼 연속으로 저장돼요.</div>

      <div style="height:10px"></div>

      <div class="seg" id="typeSeg"></div>

      <div style="height:12px"></div>

      <div class="muted">현재 룰렛 항목</div>
      <div class="list" id="itemsBox"></div>

      <div style="height:12px"></div>
      <div class="result" id="resultText">결과: -</div>
      <div class="small" id="resultMeta"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs, runTransaction, increment, setDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // ✅ 너 Firebase 콘솔 값으로 바꿔!
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function encodeKey(s){
    // 문서ID 안전하게 만들기 (base64url)
    const b64 = btoa(unescape(encodeURIComponent(String(s))));
    return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }

  async function getProfile(uid){
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if(!snap.exists()) return null;
    return snap.data();
  }

  async function nicknameExists(nick){
    const q = query(collection(db,"users"), where("nickname","==", nick));
    const s = await getDocs(q);
    return !s.empty;
  }

  /** ✅ 최종: 룰렛 목록/확률 반영(네가 올린 그대로) */
  const ROULETTES = {
    normal: { label:"일반", items:[
      { text:"냥멍체[3분]", w:3.4 },{ text:"원하는체[3분_5글자]", w:3.4 },
      { text:"짧은애교대사[5줄 이하]", w:1.7 },{ text:"팬보드", w:1.7 },
      { text:"혀봉인[1분]", w:3.4 },{ text:"받침봉인[1분]", w:3.4 },
      { text:"영 어금지[3분]", w:3.4 },{ text:"침뱉기", w:3.4 },
      { text:"짧은팬보드[1~2줄]", w:3.4 },{ text:"실드+100", w:2.3 },
      { text:"실드-100", w:2.3 },{ text:"ASMR방송[3분]", w:1.7 },
      { text:"룰렛 다돌권", w:3.4 },{ text:"헬기 리액[킵x]", w:1.7 },
      { text:"ㅇ받침체[2분]", w:3.4 },{ text:"출석체크 리액[킵x]", w:3.4 },
      { text:"브라보[킵x]", w:3.4 },{ text:"3인칭[1분]", w:3.4 },
      { text:"방종까지 쉴드 0개[킵x]", w:1.7 },{ text:"발박수", w:3.4 },
      { text:"방제 변경권[10분/킵 불가]", w:1.7 },{ text:"배경사진 변경권[10분/킵 불가]", w:1.7 },
      { text:"연하충애교도리[1분]", w:1.7 },{ text:"봉인추가", w:1.7 },
      { text:"봉인제거", w:1.7 },{ text:"이쑤시개 리액션[킵x]", w:1.7 },
      { text:"배통통[킵x]", w:3.4 },{ text:"공지변경권[다음 방송까지]", w:1.7 },
      { text:"박수 3번[킵x]", w:3.4 },{ text:"투명의자 1분[킵x]", w:1.7 },
      { text:"스쿼트 5개[킵x]", w:1.7 },{ text:"벽찍[킵x]", w:3.4 },
      { text:"TMI 1개 올리기", w:3.4 },{ text:"이름 3번 불러주기", w:1.7 },
      { text:"꽝", w:12.1 }
    ]},
    noble: { label:"귀족", items:[
      { text:"24시간 닉변권", w:10 },{ text:"24시간 역닉변권", w:10 },
      { text:"원하는 녹음본 보내주기[짧은 애교/원하는 대사/리액션]", w:4 },
      { text:"단독 박제편지", w:4 },
      { text:"룰렛 선택권[기본 or 귀족 중 원하는 것 하나 고르기]", w:4 },
      { text:"캐스트 저장권 2회", w:13 },
      { text:"실드 2배", w:5 },{ text:"실드펑 2배", w:5 },
      { text:"귀족룰렛 할인권(250스푼,3분/본인만 사용 가능)", w:4 },
      { text:"귀족룰렛 다돌권", w:10 },
      { text:"원하는 이름으로 캐스트 저장권", w:5 },
      { text:"원하는 녹음본 캐스트[짧은 애교/원하는 대사/리액션/1일]", w:4 },
      { text:"실드 음수로 변경", w:4 },{ text:"실드 양수로 변경", w:4 },
      { text:"게임 데이트권[1시간/마이크 사용은 상대방에 따라]", w:4 },
      { text:"팬보드 3개 추가", w:5 },
      { text:"도리 용돈", w:5 }
    ]},
    time: { label:"시간", items:[
      { text:"방송 연장권 +1분", w:41 },{ text:"방송 연장권 +10분", w:5 },
      { text:"방송 연장권 +20분", w:3 },{ text:"방송 연장권 +30분", w:1 },
      { text:"방송 단축권 -1분", w:41 },{ text:"방송 단축권 -10분", w:5 },
      { text:"방송 단축권 -20분", w:3 },{ text:"방송 단축권 -30분", w:1 }
    ]}
  };

  let currentType = "normal";
  const typeSeg = $("typeSeg");
  const itemsBox = $("itemsBox");

  function renderTypes(){
    typeSeg.innerHTML = "";
    Object.keys(ROULETTES).forEach(key=>{
      const b = document.createElement("button");
      b.className = "pill" + (key===currentType ? " on" : "");
      b.textContent = ROULETTES[key].label;
      b.onclick = ()=>{ currentType = key; renderTypes(); renderItems(); };
      typeSeg.appendChild(b);
    });
  }
  function renderItems(){
    const items = ROULETTES[currentType].items || [];
    itemsBox.innerHTML = "";
    items.forEach(it=>{
      const row = document.createElement("div");
      row.className = "li";
      row.innerHTML = `<b>${escapeHtml(it.text || "-")}</b><span>${Number(it.w||0)}%</span>`;
      itemsBox.appendChild(row);
    });
  }
  renderTypes(); renderItems();

  function pickWeighted(items){
    const cleaned = items
      .map(x=>({ text: String(x.text||"").trim(), w: Number(x.w||0) }))
      .filter(x=>x.text.length>0 && x.w>0);
    const total = cleaned.reduce((a,b)=>a+b.w,0);
    if(total<=0) return { text:"-" };
    let r = Math.random()*total;
    for(const it of cleaned){
      r -= it.w;
      if(r<=0) return it;
    }
    return cleaned[cleaned.length-1] || { text:"-" };
  }

  function readSpinCount(){
    let n = parseInt($("spinCount").value, 10);
    if(!Number.isFinite(n) || n < 1) n = 1;
    if(n > 999) n = 999;
    $("spinCount").value = String(n);
    return n;
  }

  const nickInput = $("targetNick");
  const hintText  = $("hintText");
  const spinBtn   = $("spinBtn");

  let profile = null;
  let isAdmin = false;

  $("logoutBtn").onclick = async ()=>{
    await signOut(auth);
    location.replace("index.html");
  };

  onAuthStateChanged(auth, async (u)=>{
    if(!u){ location.replace("index.html"); return; }
    profile = await getProfile(u.uid);
    if(!profile){ location.replace("index.html"); return; }

    isAdmin = (profile.role === "admin") || (String(profile.nickname).trim() === "도리");

    $("who").textContent = `${profile.nickname} · ${isAdmin ? "admin" : "user"}`;

    if(!isAdmin){
      nickInput.style.display = "none";
      spinBtn.disabled = true;                       // ✅ 일반유저 룰렛 버튼 OFF
      hintText.textContent = "* 일반 유저는 룰렛을 돌릴 수 없어요. (기록 보기만 가능)";
    } else {
      const last = localStorage.getItem("lastTargetNick") || "";
      nickInput.value = last;
      hintText.textContent = "* (관리자) 기록될 닉네임을 입력하고 돌리면 그 사람 기록으로 저장돼요.";
    }
  });

  async function getTargetNick(){
    const v = String(nickInput.value || "").trim();
    const target = v.length ? v : profile.nickname;
    localStorage.setItem("lastTargetNick", target);

    // ✅ 오타 닉네임 방지: 존재하는 닉네임만 저장되게
    if(!(await nicknameExists(target))){
      throw new Error(`존재하지 않는 닉네임: ${target}`);
    }
    return target;
  }

  async function incCountFS(nick, type, itemText, delta){
    const itemId = encodeKey(itemText);
    const itemRef = doc(db, "counts", nick, "types", type, "items", itemId);

    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(itemRef);
      if(!snap.exists()){
        if(delta < 0) return;
        tx.set(itemRef, { itemText, count: delta });
        return;
      }
      const cur = snap.data().count || 0;
      const next = Math.max(0, cur + delta);
      if(next === 0){
        tx.delete(itemRef);
      }else{
        tx.update(itemRef, { count: next, itemText });
      }
    });
  }

  spinBtn.onclick = async ()=>{
    try{
      if(!isAdmin){
        alert("관리자만 룰렛을 돌릴 수 있어요.");
        return;
      }

      const n = readSpinCount();
      const targetNick = await getTargetNick();

      spinBtn.disabled = true;

      let lastItem = "-";
      for(let i=0;i<n;i++){
        const pack = ROULETTES[currentType];
        const picked = pickWeighted(pack.items || []);
        const itemText = (picked.text && picked.text.trim()) ? picked.text.trim() : "-";
        await incCountFS(targetNick, currentType, itemText, 1);
        lastItem = itemText;

        if(i % 15 === 14) await new Promise(r=>setTimeout(r, 0));
      }

      $("resultText").textContent = `결과: ${lastItem} (총 ${n}회 저장)`;
      $("resultMeta").textContent =
        `${ROULETTES[currentType].label} · 대상: ${targetNick} · ${new Date().toLocaleString("ko-KR")}`;

    }catch(e){
      alert(e?.message || e);
    }finally{
      spinBtn.disabled = !isAdmin;
    }
  };
</script>
</body>
</html>
