<script type="module">
  // =========================
  // 0) Firebase SDK import
  // =========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // =========================
  // 1) firebaseConfig (너가 쓰는 걸 그대로 유지!)
  // =========================
  const firebaseConfig = {
    apiKey: "너의키",
    authDomain: "너의도메인",
    projectId: "roulette-b5455", // <- 지금 콘솔에서 본 Project ID와 같아야 함
    storageBucket: "너의버킷",
    messagingSenderId: "너의ID",
    appId: "너의앱ID",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // =========================
  // 2) (필수) 관리자 체크 함수  ★이게 핵심★
  // =========================
  async function checkAdmin(uid) {
    // users/{UID} 문서에서 role == "admin" 확인
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) return false;

    const data = snap.data() || {};
    const role = (data.role || "").toString().trim().toLowerCase();
    return role === "admin";
  }

  // =========================
  // 3) (필수) 로그인 상태 변화 시 관리자 여부 반영
  // =========================
  // 아래 id들은 너 페이지에 맞게 연결해줘:
  // - adminOnlyBox: "관리자만 룰렛 가능" 안내 박스(있으면)
  // - rouletteBox: 실제 룰렛 UI 전체 컨테이너(있으면)
  // - debugBox: 상태 표시(없으면 무시됨)
  const adminOnlyBox = document.getElementById("adminOnlyBox");
  const rouletteBox = document.getElementById("rouletteBox");
  const debugBox = document.getElementById("debugBox");

  function setVisible(el, on) {
    if (!el) return;
    el.style.display = on ? "" : "none";
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // 미로그인
      setVisible(adminOnlyBox, true);
      setVisible(rouletteBox, false);
      if (debugBox) debugBox.textContent = "상태: 미로그인";
      return;
    }

    // 로그인 됨 → 관리자 검사
    let isAdmin = false;
    try {
      isAdmin = await checkAdmin(user.uid);
    } catch (e) {
      console.error("admin check error:", e);
    }

    if (debugBox) {
      debugBox.textContent = `상태: 로그인됨 / UID=${user.uid} / admin=${isAdmin}`;
    }

    // 관리자면 룰렛 보여주기
    setVisible(adminOnlyBox, !isAdmin);
    setVisible(rouletteBox, isAdmin);
  });

  // =========================
  // 4) (선택) 로그인/로그아웃 버튼이 있으면 연결
  // =========================
  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const errorBox = document.getElementById("errorBox");

  if (loginBtn) {
    loginBtn.addEventListener("click", async () => {
      if (errorBox) errorBox.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
      } catch (e) {
        console.error(e);
        if (errorBox) errorBox.textContent = "로그인 실패: " + (e?.code || e?.message);
      }
    });
  }

  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });
  }

  // =========================
  // 여기 아래부터는 '원래 너 룰렛 로직' 그대로 두면 됨
  // (룰렛 돌리기 함수/저장 등)
  // =========================
</script>
