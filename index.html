<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¡œê·¸ì¸</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--pri:#5b7cff;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
    .wrap{max-width:520px;margin:0 auto;padding:18px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:14px 0;box-shadow:0 8px 30px rgba(16,24,40,.06);}
    h1{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;font-weight:900;margin:12px 0 6px}
    input{width:100%;box-sizing:border-box;border:1px solid var(--line);border-radius:12px;padding:12px 12px;font-weight:900;background:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;text-decoration:none;color:inherit;display:inline-flex;align-items:center;justify-content:center}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .note{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.45}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .badge{display:inline-block;border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h1>
      <div class="muted">í°/PC ì–´ë””ì„œë“  ë™ì¼ ê¸°ë¡ì„ ë³´ë ¤ë©´ Firebase ë¡œê·¸ì¸ìœ¼ë¡œ ë™ì‘í•´ìš”.</div>

      <label>ì´ë©”ì¼</label>
      <input id="email" placeholder="ì˜ˆ) example@gmail.com" autocomplete="username" inputmode="email" />

      <label>ë¹„ë°€ë²ˆí˜¸</label>
      <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />

      <label>ë‹‰ë„¤ì„(íšŒì›ê°€ì… ì‹œ)</label>
      <input id="nick" placeholder="ì˜ˆ) ë„ë¦¬" />

      <div class="row">
        <button class="btn pri" id="loginBtn">ë¡œê·¸ì¸</button>
        <button class="btn" id="signupBtn">íšŒì›ê°€ì…</button>
      </div>

      <div class="note">
        â€¢ ë‹‰ë„¤ì„/ì´ë©”ì¼ ì¤‘ë³µ ë¶ˆê°€<br/>
        â€¢ ê´€ë¦¬ìëŠ” ì´ë©”ì¼ ê¸°ì¤€ìœ¼ë¡œ êµ¬ë¶„í•˜ì„¸ìš”
      </div>

      <div class="muted" id="msg" style="margin-top:12px;"></div>

      <div class="hr"></div>

      <!-- ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ -->
      <div id="signedOut" class="muted">í˜„ì¬ ìƒíƒœ: ë¡œê·¸ì•„ì›ƒ</div>

      <div id="signedIn" style="display:none;">
        <div class="row">
          <span class="badge" id="who"></span>
        </div>

        <div class="row">
          <a class="btn pri" href="roulette.html">ğŸ¯ ë£°ë ›ìœ¼ë¡œ ê°€ê¸°</a>
          <a class="btn" href="lotto.html">ğŸŸï¸ ë³µê¶Œìœ¼ë¡œ ê°€ê¸°</a>
          <button class="btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    deleteUser,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  import {
    getFirestore,
    doc,
    getDoc,
    runTransaction,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
    authDomain: "roulette-b5455.firebaseapp.com",
    projectId: "roulette-b5455",
    storageBucket: "roulette-b5455.firebasestorage.app",
    messagingSenderId: "728191308035",
    appId: "1:728191308035:web:b14b46c38bbe0261969936",
    measurementId: "G-SPY41ZKXYQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);
  const msg = (t)=>{ $("msg").textContent = t; };

  const normEmail = (v)=> String(v || "").trim().toLowerCase();

  // âœ… ë‹‰ë„¤ì„ ì •ê·œí™”: ì•ë’¤ ê³µë°± ì œê±° + ì¤‘ê°„ ì—°ì† ê³µë°± 1ê°œë¡œ + ìœ ë‹ˆì½”ë“œ ì •ê·œí™”(ê²‰ë³´ê¸° ê°™ì€ë° ë‹¤ë¥¸ ê¸€ì ë°©ì§€)
  const normNick = (v)=> String(v || "")
    .normalize("NFC")
    .trim()
    .replace(/\s+/g, " ");

  // âœ… ë‹‰ë„¤ì„ ê¸°ë³¸ ê·œì¹™(ì›í•˜ë©´ ë” ë¹¡ì„¸ê²Œ ê°€ëŠ¥)
  function validateNickname(nick){
    if(!nick) return "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜.";
    if(nick.length < 2 || nick.length > 12) return "ë‹‰ë„¤ì„ì€ 2~12ê¸€ìë¡œ í•´ì¤˜.";
    // ê¸ˆì§€ ë¬¸ì: ìŠ¬ë˜ì‹œ(ë¬¸ì„œ ê²½ë¡œ ê¹¨ì§), ì•ë’¤ ì  ë“± ë¬¸ì œ ì†Œì§€
    if(/[\/\\]/.test(nick)) return "ë‹‰ë„¤ì„ì— / ë˜ëŠ” \\ ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ì–´.";
    return "";
  }

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      $("signedOut").style.display = "none";
      $("signedIn").style.display = "block";
      $("who").textContent = `ë¡œê·¸ì¸ë¨: ${user.email}`;
    }else{
      $("signedOut").style.display = "block";
      $("signedIn").style.display = "none";
      $("who").textContent = "";
    }
  });

  $("loginBtn").onclick = async ()=>{
    try{
      const email = normEmail($("email").value);
      const pw = $("pw").value;
      if(!email || !pw) return msg("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥í•´ì¤˜.");

      await signInWithEmailAndPassword(auth, email, pw);

      // âœ… ë¡œê·¸ì¸ í›„ì—ëŠ” ë°”ë¡œ ë£°ë ›ìœ¼ë¡œ ë³´ë‚´ê¸°(ê¸°ì¡´ ìœ ì§€)
      location.replace("roulette.html");
    }catch(e){
      msg("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (e?.message || e));
    }
  };

  $("signupBtn").onclick = async ()=>{
    try{
      const email = normEmail($("email").value);
      const pw = $("pw").value;
      const nickname = normNick($("nick").value);

      if(!email || !pw || !nickname) return msg("ëª¨ë‘ ì…ë ¥í•´ì¤˜.");

      const nickErr = validateNickname(nickname);
      if(nickErr) return msg(nickErr);

      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      const uid = cred.user.uid;

      try{
        await runTransaction(db, async (tx) => {
          const nickRef = doc(db, "nicknames", nickname);
          const nickSnap = await tx.get(nickRef);
          if (nickSnap.exists()) throw new Error("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„");

          // nicknames/{nickname} ì„ ì 
          tx.set(nickRef, { uid, createdAt: serverTimestamp() });

          // users/{uid} ì €ì¥
          tx.set(doc(db,"users",uid),{
            email,
            nickname,
            role:"user",
            createdAt: serverTimestamp()
          });
        });

        // âœ… â€œê°€ì…í–ˆëŠ”ë° nicknamesê°€ ì—†ë‹¤â€ ê°™ì€ ë¹„ì •ìƒ ë°©ì§€ìš© 2ì°¨ í™•ì¸(ì§§ê²Œ)
        const check = await getDoc(doc(db,"nicknames", nickname));
        if(!check.exists()){
          // ì´ ê²½ìš°ëŠ” ê±°ì˜ ì—†ì§€ë§Œ, ìƒê¸°ë©´ ì‚¬ìš©ì ì…ì¥ì—ì„  í° ë¬¸ì œë¼ì„œ ì•ˆì „í•˜ê²Œ ì¤‘ë‹¨
          throw new Error("ë‹‰ë„¤ì„ ì €ì¥ì´ í™•ì¸ë˜ì§€ ì•Šì•˜ì–´. ë‹¤ì‹œ ì‹œë„í•´ì¤˜.");
        }

      }catch(err){
        // íŠ¸ëœì­ì…˜ ì‹¤íŒ¨ë©´ Auth ê³„ì •ë„ ë¡¤ë°± ì‹œë„
        try{ await deleteUser(cred.user);}catch(_){}
        throw err;
      }

      location.replace("roulette.html");
    }catch(e){
      msg("íšŒì›ê°€ì… ì‹¤íŒ¨: " + (e?.message || e));
    }
  };

  $("logoutBtn").onclick = async ()=>{
    await signOut(auth);
  };
</script>
</body>
</html>
