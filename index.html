<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roulette Viewer</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header class="top">
    <h1>룰렛 결과(청취자)</h1>
    <p class="sub">자동으로 갱신돼요</p>
    <a class="link" href="./admin.html">관리자</a>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>최근 결과</h2>
      <div id="status" class="muted">불러오는 중...</div>
      <ul id="logList" class="list"></ul>
    </section>

    <section class="card">
      <h2>항목별 횟수</h2>
      <ul id="countList" class="list twoCol"></ul>
    </section>
  </main>

  <script type="module">
    // ✅ Firebase (CDN 모듈)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // ✅ 도리 Firebase 설정 (그대로)
    const firebaseConfig = {
      apiKey: "AIzaSyBUMDicEPJ8AtHHe0LRBviIsKbYQJ4U5LA",
      authDomain: "roulette-log.firebaseapp.com",
      projectId: "roulette-log",
      storageBucket: "roulette-log.firebasestorage.app",
      messagingSenderId: "848295448204",
      appId: "1:848295448204:web:1b1cd13bf800a8409bf5a9",
      measurementId: "G-3FBMRDXR74"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const statusEl = document.getElementById("status");
    const logList = document.getElementById("logList");
    const countList = document.getElementById("countList");

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function renderLogs(docs) {
      logList.innerHTML = "";
      const counts = new Map();

      if (docs.length === 0) {
        statusEl.textContent = "아직 기록이 없어요. (관리자가 한번 돌리면 생깁니다)";
        countList.innerHTML = "";
        return;
      }
      statusEl.textContent = "";

      for (const d of docs) {
        const result = d.result ?? "(알수없음)";
        counts.set(result, (counts.get(result) ?? 0) + 1);

        const when = d.ts?.toDate ? d.ts.toDate() : null;
        const whenText = when ? when.toLocaleString() : "";
        const by = d.byEmail ? ` · ${d.byEmail}` : "";

        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `
          <div class="big">${escapeHtml(result)}</div>
          <div class="muted small">${escapeHtml(whenText)}${escapeHtml(by)}</div>
        `;
        logList.appendChild(li);
      }

      // counts (내림차순)
      const sorted = [...counts.entries()].sort((a,b)=>b[1]-a[1]);

      countList.innerHTML = "";
      for (const [name, n] of sorted) {
        const li = document.createElement("li");
        li.className = "item";
        li.innerHTML = `<div>${escapeHtml(name)}</div><div class="badge">${n}회</div>`;
        countList.appendChild(li);
      }
    }

    // ✅ 최신 50개를 실시간 구독
    const q = query(collection(db, "rouletteLogs"), orderBy("ts", "desc"), limit(50));
    onSnapshot(q, (snap) => {
      const docs = snap.docs.map(x => x.data());
      renderLogs(docs);
    }, (err) => {
      statusEl.textContent = "읽기 오류: " + err.message;
    });
  </script>
</body>
</html>