<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>로그인</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--pri:#5b7cff;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
    .wrap{max-width:520px;margin:0 auto;padding:18px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:14px 0;box-shadow:0 8px 30px rgba(16,24,40,.06);}
    h1{margin:0 0 6px;font-size:22px}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;font-weight:900;margin:12px 0 6px}
    input{width:100%;box-sizing:border-box;border:1px solid var(--line);border-radius:12px;padding:12px 12px;font-weight:900;background:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .note{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.45}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>로그인 / 회원가입</h1>
      <div class="muted">폰/PC 어디서든 동일 기록을 보려면 Firebase 로그인으로 동작해요.</div>

      <label>이메일</label>
      <input id="email" placeholder="예) dori0223@gmail.com" autocomplete="username" inputmode="email" />

      <label>비밀번호</label>
      <input id="pw" type="password" placeholder="비밀번호" autocomplete="current-password" />

      <label>닉네임(회원가입 시)</label>
      <input id="nick" placeholder="예) 도리" />

      <div class="row">
        <button class="btn pri" id="loginBtn">로그인</button>
        <button class="btn" id="signupBtn">회원가입</button>
      </div>

      <div class="note">
        • 닉네임/이메일 중복 불가<br/>
        • (권장) 관리자는 닉네임이 아니라 “관리자 이메일”로 판별하세요
      </div>

      <div class="muted" id="msg" style="margin-top:12px;"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    deleteUser
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  import {
    getFirestore,
    doc,
    setDoc,
    runTransaction,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
    authDomain: "roulette-b5455.firebaseapp.com",
    projectId: "roulette-b5455",
    storageBucket: "roulette-b5455.firebasestorage.app",
    messagingSenderId: "728191308035",
    appId: "1:728191308035:web:b14b46c38bbe0261969936",
    measurementId: "G-SPY41ZKXYQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);
  const msg = (t)=>{ $("msg").textContent = t; };

  function normEmail(v){
    return String(v || "").trim().toLowerCase();
  }

  function normNick(v){
    return String(v || "").trim();
  }

  $("loginBtn").onclick = async ()=>{
    try{
      const email = normEmail($("email").value);
      const pw = $("pw").value;
      if(!email || !pw) return msg("이메일/비밀번호를 입력해줘.");

      await signInWithEmailAndPassword(auth, email, pw);
      location.replace("roulette.html");
    }catch(e){
      msg("로그인 실패: " + (e?.message || e));
    }
  };

  $("signupBtn").onclick = async ()=>{
    try{
      const email = normEmail($("email").value);
      const pw = $("pw").value;
      const nickname = normNick($("nick").value);

      if(!email || !pw || !nickname) return msg("이메일/비밀번호/닉네임을 모두 입력해줘.");

      // 1) Auth 계정 생성
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      const uid = cred.user.uid;

      // 2) Firestore: nicknames/{nickname} 선점 + users/{uid} 생성 (트랜잭션)
      //    - nicknames 문서가 이미 있으면 즉시 실패 → 닉네임 중복 완벽 차단
      try{
        await runTransaction(db, async (tx) => {
          const nickRef = doc(db, "nicknames", nickname);
          const nickSnap = await tx.get(nickRef);
          if (nickSnap.exists()) {
            throw new Error("이미 사용 중인 닉네임이야.");
          }

          // 닉네임 선점
          tx.set(nickRef, { uid, createdAt: serverTimestamp() });

          // 유저 프로필 생성 (role은 무조건 user로만 생성)
          const userRef = doc(db, "users", uid);
          tx.set(userRef, {
            email,
            nickname,
            role: "user",
            createdAt: serverTimestamp()
          });
        });
      } catch(err){
        // Firestore가 실패하면 방금 만든 Auth 계정도 삭제해서 깔끔하게 롤백
        try{ await deleteUser(cred.user); }catch(_){}
        throw err;
      }

      location.replace("roulette.html");
    }catch(e){
      msg("회원가입 실패: " + (e?.message || e));
    }
  };
</script>
</body>
</html>
