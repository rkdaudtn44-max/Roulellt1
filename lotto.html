<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë³µê¶Œ (3ìë¦¬)</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--pri:#5b7cff;--good:#10b981;--bad:#ef4444;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}

    /* âœ… ê³µí†µ ìƒë‹¨ë°”(ë£°ë ›/ê¸°ë¡/ë³µê¶Œ + ë‹‰/ë¡œê·¸ì•„ì›ƒ) */
    .top{
      position:sticky;top:0;background:rgba(246,247,251,.9);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex;gap:10px;align-items:center;z-index:10;
      flex-wrap:wrap;
    }

    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:900}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}

    .wrap{max-width:980px;margin:16px auto;padding:0 16px 30px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .h{font-size:16px;font-weight:800;margin:0 0 10px}
    .muted{color:var(--muted);font-size:13px}
    .danger{color:var(--bad);font-weight:900;font-size:13px;white-space:pre-wrap}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:15px;background:#fff}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:#fff;font-size:13px}
    .pill b{font-size:14px}
    .resultBox{display:grid;gap:10px}
    .nums{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .ball{width:42px;height:42px;border-radius:999px;border:1px solid var(--line);display:grid;place-items:center;background:#fff;font-weight:900;font-size:18px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:700}
    .right{text-align:right}

    .countInput{
      width:90px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      font-weight:900;
      font-size:15px;
      background:#fff;
      text-align:center;
    }
  </style>
</head>
<body>
  <!-- âœ… ìƒë‹¨ ê³µí†µ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="top">
    <button class="btn" onclick="location.href='roulette.html'">ğŸ¯ ë£°ë ›</button>
    <button class="btn" onclick="location.href='log.html'">ğŸ“’ ê¸°ë¡</button>
    <button class="btn" onclick="location.href='lotto.html'">ğŸŸï¸ ë³µê¶Œ</button>

    <div style="flex:1"></div>
    <div class="muted" id="who"></div>
    <button class="btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <p class="h">ë³µê¶Œ ëŒë¦¬ê¸°</p>
        <p class="muted">0~9 ìˆ«ì 3ê°œë¥¼ ì„ íƒ â†’ ì¶”ì²¨ 3ê°œì™€ ë¹„êµ â†’ ê²½í—˜ì¹˜ ì§€ê¸‰ (3ê°œ ì¼ì¹˜ 1,000 / 2ê°œ 500 / 1ê°œ 100 / 0ê°œ 10)</p>

        <div class="row" style="margin:12px 0 10px">
          <select id="d1"></select>
          <select id="d2"></select>
          <select id="d3"></select>

          <span class="pill">í‹°ì¼“ <b id="ticketCount">0</b></span>

          <span class="pill">ìë™íšŸìˆ˜ <b style="display:none"> </b></span>
          <input id="autoCount" class="countInput" type="number" min="1" max="999" value="1" inputmode="numeric" />

          <button class="btn pri" id="playBtn">1íšŒ</button>
          <button class="btn" id="autoBtn">ìë™</button>
        </div>

        <div class="muted" id="autoProgress" style="display:none;margin-top:6px;"></div>

        <div class="muted" id="ticketHint" style="display:none;margin-top:6px;">
          í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤. ë£°ë ›ì—ì„œ â€œë³µê¶Œâ€ í•­ëª©ì„ ë°›ì•„ì•¼ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>

        <div class="resultBox" id="resultBox" style="display:none">
          <div>
            <div class="muted">ë‚´ ì„ íƒ</div>
            <div class="nums" id="pickedView"></div>
          </div>
          <div>
            <div class="muted">ì¶”ì²¨ ê²°ê³¼</div>
            <div class="nums" id="drawnView"></div>
          </div>
          <div class="row">
            <span class="pill">ì¼ì¹˜ ê°œìˆ˜ <b id="matchCount">0</b></span>
            <span class="pill">íšë“ ê²½í—˜ì¹˜ <b id="xpEarned">0</b></span>
          </div>
        </div>

        <div id="errBox" class="danger" style="display:none;margin-top:12px;"></div>
      </div>

      <div class="card">
        <p class="h">ë‚´ ì •ë³´ / ë­í‚¹ TOP5</p>
        <div class="row" style="margin-bottom:10px">
          <span class="pill">ë‹‰ë„¤ì„ <b id="meNick">-</b></span>
          <span class="pill">ë ˆë²¨ <b id="meLevel">-</b></span>
          <span class="pill">ê²½í—˜ì¹˜ <b id="meXp">-</b></span>
        </div>

        <p class="muted" style="margin:10px 0 6px">TOP 5 (ë ˆë²¨ â†’ ê²½í—˜ì¹˜ ìˆœ)</p>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:42px">#</th>
                <th>ë‹‰ë„¤ì„</th>
                <th class="right">ë ˆë²¨</th>
                <th class="right">ê²½í—˜ì¹˜</th>
              </tr>
            </thead>
            <tbody id="rankBody"></tbody>
          </table>
        </div>

        <p class="muted" style="margin-top:10px">â€» ë³´ì•ˆ ê°•í•˜ê²Œ í•˜ë ¤ë©´(ê²½í—˜ì¹˜ ì¡°ì‘ ë°©ì§€) ë‚˜ì¤‘ì— Cloud Functionsë¡œ â€œì„œë²„ì—ì„œ ê³„ì‚°â€í•˜ëŠ” ë°©ì‹ ì¶”ì²œ.</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp, runTransaction,
      query, orderBy, limit, getDocs, collection
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
      authDomain: "roulette-b5455.firebaseapp.com",
      projectId: "roulette-b5455",
      storageBucket: "roulette-b5455.firebasestorage.app",
      messagingSenderId: "728191308035",
      appId: "1:728191308035:web:b14b46c38bbe0261969936",
      measurementId: "G-SPY41ZKXYQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const errBox = $("errBox");
    const showErr = (e)=>{
      errBox.style.display = "block";
      const code = e?.code ? `(${e.code}) ` : "";
      errBox.textContent = "ì˜¤ë¥˜: " + code + (e?.message || e);
    };
    const clearErr = ()=>{
      errBox.style.display = "none";
      errBox.textContent = "";
    };

    // âœ… ìƒë‹¨ë°” ë²„íŠ¼
    $("logoutBtn").onclick = async () => {
      await signOut(auth);
      location.replace("./index.html");
    };
    $("refreshBtn").onclick = () => location.reload();

    // âœ… ë‹‰ë„¤ì„ ì •ê·œí™” í†µì¼(ë£°ë ›/ë¡œê·¸/indexì™€ ë™ì¼)
    function normNick(v){
      return String(v ?? "")
        .normalize("NFC")
        .trim()
        .replace(/\s+/g, " ");
    }
    function validateNickForDocId(nick){
      if(!nick) return "ë‹‰ë„¤ì„ì´ ë¹„ì–´ìˆì–´ìš”.";
      if(/[\/\\]/.test(nick)) return "ë‹‰ë„¤ì„ì— / ë˜ëŠ” \\ ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ì–´.";
      return "";
    }

    // âœ… í‹°ì¼“ UI
    const ticketCountEl = $("ticketCount");
    const ticketHint = $("ticketHint");
    let myTickets = 0;

    const autoCountEl = $("autoCount");
    const autoBtn = $("autoBtn");
    const autoProgress = $("autoProgress");

    function readAutoCount(){
      let n = parseInt(autoCountEl.value, 10);
      if(!Number.isFinite(n) || n < 1) n = 1;
      if(n > 999) n = 999;
      autoCountEl.value = String(n);
      return n;
    }

    function setBusy(isBusy){
      $("playBtn").disabled = isBusy || (myTickets||0) <= 0;
      autoBtn.disabled = isBusy || (myTickets||0) <= 0;
      autoCountEl.disabled = isBusy;
    }

    function syncTicketUI(){
      ticketCountEl.textContent = String(myTickets || 0);
      if((myTickets||0) <= 0){
        setBusy(false);
        ticketHint.style.display = "block";
      }else{
        ticketHint.style.display = "none";
      }
    }

    // ----- ë ˆë²¨ ê³„ì‚°(ê¸°ì¡´ ìœ ì§€)
    function calcLevelFromXp(xp){
      xp = Math.max(0, Number(xp||0));
      const L = Math.floor((Math.sqrt(1 + 0.08 * xp) - 1) / 2);
      return Math.max(1, L);
    }

    function fillSelect(sel){
      for(let i=0;i<=9;i++){
        const op = document.createElement("option");
        op.value = String(i);
        op.textContent = String(i);
        sel.appendChild(op);
      }
    }

    const d1 = $("d1");
    const d2 = $("d2");
    const d3 = $("d3");
    [d1,d2,d3].forEach(fillSelect);

    const playBtn = $("playBtn");
    const resultBox = $("resultBox");
    const pickedView = $("pickedView");
    const drawnView = $("drawnView");
    const matchCountEl = $("matchCount");
    const xpEarnedEl = $("xpEarned");

    const meNick = $("meNick");
    const meLevel = $("meLevel");
    const meXp = $("meXp");
    const rankBody = $("rankBody");

    function makeBall(n){
      const div = document.createElement("div");
      div.className = "ball";
      div.textContent = String(n);
      return div;
    }

    function randomDigits3(){
      return [0,0,0].map(()=>Math.floor(Math.random()*10));
    }

    function countMatches(picked, drawn){
      const cntP = Array(10).fill(0);
      const cntD = Array(10).fill(0);
      picked.forEach(n=>cntP[n]++);
      drawn.forEach(n=>cntD[n]++);
      let m = 0;
      for(let i=0;i<=9;i++) m += Math.min(cntP[i], cntD[i]);
      return m;
    }

    // âœ… ê²½í—˜ì¹˜ ì§€ê¸‰í‘œ ë³€ê²½(ìš”ì²­ ë°˜ì˜)
    function xpByMatch(m){
      if(m===3) return 1000;
      if(m===2) return 500;
      if(m===1) return 100;
      return 10;
    }

    function safeStr(v){ return String(v ?? "").trim(); }

    // âœ… users + publicUsers ì¤€ë¹„ (+ lottoTickets ê¸°ë³¸ê°’ ë³´ì¥)
    async function ensureUserDoc(user){
      const userRef = doc(db, "users", user.uid);
      const pubRef  = doc(db, "publicUsers", user.uid);

      const snap = await getDoc(userRef);

      if(!snap.exists()){
        const email = safeStr(user.email);
        const nickGuessRaw = email ? email.split("@")[0] : (user.displayName || "ì‚¬ìš©ì");
        const nickGuess = normNick(nickGuessRaw);

        const err = validateNickForDocId(nickGuess);
        if(err) throw new Error("ë‹‰ë„¤ì„ ì˜¤ë¥˜: " + err);

        await setDoc(userRef, {
          uid: user.uid,
          email: user.email || null,
          nickname: nickGuess,
          role: "user",
          xp: 0,
          level: 1,
          lottoTickets: 0,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });

        await setDoc(pubRef, {
          uid: user.uid,
          nickname: nickGuess,
          xp: 0,
          level: 1,
          updatedAt: serverTimestamp()
        }, { merge: true });

        return { userRef, pubRef };
      }

      const data = snap.data() || {};
      const patch = {};

      if(data.xp === undefined) patch.xp = 0;
      if(data.level === undefined) patch.level = calcLevelFromXp(data.xp ?? 0);
      if(data.lottoTickets === undefined) patch.lottoTickets = 0;

      // âœ… nickname ì •ê·œí™”(ê²‰ë³´ê¸° ê°™ì€ë° ë‹¤ë¥¸ ë‹‰ë„¤ì„ ë°©ì§€)
      const normalizedNick = normNick(data.nickname || (user.email ? user.email.split("@")[0] : "ì‚¬ìš©ì"));
      const nickErr = validateNickForDocId(normalizedNick);
      if(nickErr) throw new Error("ë‹‰ë„¤ì„ ì˜¤ë¥˜: " + nickErr);

      if((data.nickname || "") !== normalizedNick) patch.nickname = normalizedNick;

      if(Object.keys(patch).length){
        patch.updatedAt = serverTimestamp();
        await setDoc(userRef, patch, { merge: true });
      }

      const xp = Number((data.xp ?? patch.xp) ?? 0);
      const level = Number((data.level ?? patch.level) ?? calcLevelFromXp(xp));

      await setDoc(pubRef, {
        uid: user.uid,
        nickname: normalizedNick,
        xp,
        level,
        updatedAt: serverTimestamp()
      }, { merge: true });

      return { userRef, pubRef };
    }

    async function loadMe(user){
      const { userRef } = await ensureUserDoc(user);
      const snap = await getDoc(userRef);
      const data = snap.data() || {};

      const nick = normNick(data.nickname || "-");
      meNick.textContent = nick;
      meXp.textContent = String(data.xp ?? 0);
      meLevel.textContent = String(data.level ?? calcLevelFromXp(data.xp ?? 0));

      // âœ… ìƒë‹¨ who í‘œì‹œ(ë‹‰ë„¤ì„ + ê¶Œí•œ)
      const role = String(data.role || "user").toLowerCase();
      const isAdmin = role === "admin";
      const whoEl = $("who");
      if(whoEl) whoEl.textContent = `${nick} Â· ${isAdmin ? "admin" : "user"}`;

      myTickets = Number(data.lottoTickets || 0);
      syncTicketUI();

      return { userRef, data: { ...data, nickname: nick } };
    }

    async function loadRanking(){
      rankBody.innerHTML = "";
      const q = query(
        collection(db, "publicUsers"),
        orderBy("level", "desc"),
        orderBy("xp", "desc"),
        limit(5)
      );
      const snaps = await getDocs(q);
      let i=1;
      snaps.forEach(s=>{
        const u = s.data() || {};
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i++}</td>
          <td>${normNick(u.nickname || "-")}</td>
          <td class="right">${(u.level ?? 1)}</td>
          <td class="right">${(u.xp ?? 0)}</td>
        `;
        rankBody.appendChild(tr);
      });
    }

    // âœ… ê³µí†µ: 1íšŒ ì‹¤í–‰(íŠ¸ëœì­ì…˜ í¬í•¨)
    async function playOnce(user){
      const picked = [Number(d1.value), Number(d2.value), Number(d3.value)];
      const drawn = randomDigits3();
      const m = countMatches(picked, drawn);
      const earned = xpByMatch(m);

      const userRef = doc(db, "users", user.uid);
      const pubRef  = doc(db, "publicUsers", user.uid);

      await runTransaction(db, async (tx) => {
        const snap = await tx.get(userRef);
        if(!snap.exists()) throw new Error("users ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. (ê°€ì…/ë¡œê·¸ì¸ë¶€í„° ë‹¤ì‹œ í™•ì¸)");
        const data = snap.data() || {};

        const tickets = Number(data.lottoTickets || 0);
        if(tickets <= 0){
          throw new Error("ë³µê¶Œ í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤. (ì§€ê¸‰ í›„ ì´ìš© ê°€ëŠ¥)");
        }

        const nick = normNick(data.nickname || (user.email ? user.email.split("@")[0] : "ì‚¬ìš©ì"));
        const err = validateNickForDocId(nick);
        if(err) throw new Error("ë‹‰ë„¤ì„ ì˜¤ë¥˜: " + err);

        const oldXp = Number(data.xp||0);
        const newXp = oldXp + earned;
        const newLevel = calcLevelFromXp(newXp);

        tx.update(userRef, {
          lottoTickets: tickets - 1,
          xp: newXp,
          level: newLevel,
          nickname: nick,
          updatedAt: serverTimestamp()
        });

        tx.set(pubRef, {
          uid: user.uid,
          nickname: nick,
          xp: newXp,
          level: newLevel,
          updatedAt: serverTimestamp()
        }, { merge: true });

        const playRef = doc(collection(db, "lottoPlays"));
        tx.set(playRef, {
          uid: user.uid,
          nickname: nick,
          picked,
          drawn,
          matchCount: m,
          xpEarned: earned,
          createdAt: serverTimestamp()
        });
      });

      return { picked, drawn, m, earned };
    }

    function renderResult(picked, drawn, m, earned){
      pickedView.innerHTML = "";
      drawnView.innerHTML = "";
      picked.forEach(n=>pickedView.appendChild(makeBall(n)));
      drawn.forEach(n=>drawnView.appendChild(makeBall(n)));
      matchCountEl.textContent = String(m);
      xpEarnedEl.textContent = String(earned);
      resultBox.style.display = "grid";
    }

    async function playLottoOnce(user){
      clearErr();

      if((myTickets||0) <= 0){
        syncTicketUI();
        throw new Error("ë³µê¶Œ í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤. ë£°ë ›ì—ì„œ â€œë³µê¶Œâ€ í•­ëª© ì§€ê¸‰ì„ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.");
      }

      setBusy(true);
      autoProgress.style.display = "none";
      autoProgress.textContent = "";

      try{
        const r = await playOnce(user);

        myTickets = Math.max(0, (myTickets||0) - 1);
        syncTicketUI();
        renderResult(r.picked, r.drawn, r.m, r.earned);

        await loadMe(user);
        await loadRanking();
      }catch(e){
        showErr(e);
      }finally{
        setBusy(false);
        syncTicketUI();
      }
    }

    async function playLottoAuto(user){
      clearErr();

      const want = readAutoCount();
      if(want <= 0) return;

      if((myTickets||0) <= 0){
        syncTicketUI();
        throw new Error("ë³µê¶Œ í‹°ì¼“ì´ ì—†ìŠµë‹ˆë‹¤. ë£°ë ›ì—ì„œ â€œë³µê¶Œâ€ í•­ëª© ì§€ê¸‰ì„ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.");
      }

      const canRun = Math.min(want, myTickets);
      setBusy(true);

      autoProgress.style.display = "block";
      autoProgress.textContent = `ì§„í–‰ ì¤‘... 0 / ${canRun}`;

      let done = 0;
      let totalEarned = 0;
      const dist = {0:0,1:0,2:0,3:0};

      let last = null;

      try{
        for(let i=0;i<canRun;i++){
          const r = await playOnce(user);

          done += 1;
          totalEarned += r.earned;
          dist[r.m] = (dist[r.m]||0) + 1;
          last = r;

          myTickets = Math.max(0, (myTickets||0) - 1);
          syncTicketUI();

          autoProgress.textContent =
            `ì§„í–‰ ì¤‘... ${done} / ${canRun} (ì´ ê²½í—˜ì¹˜ +${totalEarned}, ë‚¨ì€ í‹°ì¼“ ${myTickets})`;

          if(i % 25 === 24) await new Promise(r=>setTimeout(r, 0));
        }

        if(last){
          renderResult(last.picked, last.drawn, last.m, last.earned);
        }

        await loadMe(user);
        await loadRanking();

        autoProgress.textContent =
          `ì™„ë£Œ: ${done}íšŒ / ì´ ê²½í—˜ì¹˜ +${totalEarned} / ì¼ì¹˜(0:${dist[0]} 1:${dist[1]} 2:${dist[2]} 3:${dist[3]}) / ë‚¨ì€ í‹°ì¼“ ${myTickets}`;

      }catch(e){
        showErr(e);
      }finally{
        setBusy(false);
        syncTicketUI();
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        location.replace("./index.html?next=lotto.html");
        return;
      }

      clearErr();
      try{
        await loadMe(user);
        await loadRanking();

        playBtn.onclick = () => playLottoOnce(user);
        autoBtn.onclick = () => playLottoAuto(user);
      }catch(e){
        showErr(e);
      }
    });
  </script>
</body>
</html>
