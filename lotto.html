<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë³µê¶Œ (3ìë¦¬)</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--pri:#5b7cff;--good:#10b981;--bad:#ef4444;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
    .top{position:sticky;top:0;background:rgba(246,247,251,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line);z-index:10}
    .topin{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;gap:10px}
    .brand{font-weight:800}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:900}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
    .wrap{max-width:980px;margin:16px auto;padding:0 16px 30px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .h{font-size:16px;font-weight:800;margin:0 0 10px}
    .muted{color:var(--muted);font-size:13px}
    .danger{color:var(--bad);font-weight:900;font-size:13px;white-space:pre-wrap}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select{border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:15px;background:#fff}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:#fff;font-size:13px}
    .pill b{font-size:14px}
    .resultBox{display:grid;gap:10px}
    .nums{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .ball{width:42px;height:42px;border-radius:999px;border:1px solid var(--line);display:grid;place-items:center;background:#fff;font-weight:900;font-size:18px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:700}
    .right{text-align:right}
  </style>
</head>
<body>
  <div class="top">
    <div class="topin">
      <div class="brand">ğŸŸï¸ ë³µê¶Œ (3ìë¦¬)</div>
      <div class="row">
        <button class="btn" id="goHomeBtn">í™ˆ</button>
        <button class="btn" id="goRouletteBtn">ë£°ë ›</button>
        <button class="btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <p class="h">ë³µê¶Œ ëŒë¦¬ê¸°</p>
        <p class="muted">0~9 ìˆ«ì 3ê°œë¥¼ ì„ íƒ â†’ ì¶”ì²¨ 3ê°œì™€ ë¹„êµ â†’ ê²½í—˜ì¹˜ ì§€ê¸‰ (3ê°œ ì¼ì¹˜ 50,000 / 2ê°œ 10,000 / 1ê°œ 5,000 / 0ê°œ 1,000)</p>

        <div class="row" style="margin:12px 0 10px">
          <select id="d1"></select>
          <select id="d2"></select>
          <select id="d3"></select>
          <button class="btn pri" id="playBtn">ëŒë¦¬ê¸°</button>
        </div>

        <div class="resultBox" id="resultBox" style="display:none">
          <div>
            <div class="muted">ë‚´ ì„ íƒ</div>
            <div class="nums" id="pickedView"></div>
          </div>
          <div>
            <div class="muted">ì¶”ì²¨ ê²°ê³¼</div>
            <div class="nums" id="drawnView"></div>
          </div>
          <div class="row">
            <span class="pill">ì¼ì¹˜ ê°œìˆ˜ <b id="matchCount">0</b></span>
            <span class="pill">íšë“ ê²½í—˜ì¹˜ <b id="xpEarned">0</b></span>
          </div>
        </div>

        <div id="errBox" class="danger" style="display:none;margin-top:12px;"></div>
      </div>

      <div class="card">
        <p class="h">ë‚´ ì •ë³´ / ë­í‚¹ TOP5</p>
        <div class="row" style="margin-bottom:10px">
          <span class="pill">ë‹‰ë„¤ì„ <b id="meNick">-</b></span>
          <span class="pill">ë ˆë²¨ <b id="meLevel">-</b></span>
          <span class="pill">ê²½í—˜ì¹˜ <b id="meXp">-</b></span>
        </div>

        <p class="muted" style="margin:10px 0 6px">TOP 5 (ë ˆë²¨ â†’ ê²½í—˜ì¹˜ ìˆœ)</p>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:42px">#</th>
                <th>ë‹‰ë„¤ì„</th>
                <th class="right">ë ˆë²¨</th>
                <th class="right">ê²½í—˜ì¹˜</th>
              </tr>
            </thead>
            <tbody id="rankBody"></tbody>
          </table>
        </div>

        <p class="muted" style="margin-top:10px">â€» ë³´ì•ˆ ê°•í•˜ê²Œ í•˜ë ¤ë©´(ê²½í—˜ì¹˜ ì¡°ì‘ ë°©ì§€) ë‚˜ì¤‘ì— Cloud Functionsë¡œ â€œì„œë²„ì—ì„œ ê³„ì‚°â€í•˜ëŠ” ë°©ì‹ ì¶”ì²œ.</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp, runTransaction,
      query, orderBy, limit, getDocs, collection
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // âœ… index.html / roulette.html / log.html ê³¼ ë°˜ë“œì‹œ ë™ì¼í•´ì•¼ í•¨
    const firebaseConfig = {
      apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
      authDomain: "roulette-b5455.firebaseapp.com",
      projectId: "roulette-b5455",
      storageBucket: "roulette-b5455.firebasestorage.app",
      messagingSenderId: "728191308035",
      appId: "1:728191308035:web:b14b46c38bbe0261969936",
      measurementId: "G-SPY41ZKXYQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const errBox = $("errBox");
    const showErr = (e)=>{
      errBox.style.display = "block";
      const code = e?.code ? `(${e.code}) ` : "";
      errBox.textContent = "ì˜¤ë¥˜: " + code + (e?.message || e);
    };
    const clearErr = ()=>{
      errBox.style.display = "none";
      errBox.textContent = "";
    };

    // ----- ë ˆë²¨ ê³„ì‚°: 1ë ˆë²¨=100, ë ™ì—…ë§ˆë‹¤ +100 (ëˆ„ì  ìš”êµ¬ì¹˜: 100 + 200 + 300 + ...)
    function calcLevelFromXp(xp){
      xp = Math.max(0, Number(xp||0));
      // sum_{k=1..L} 100k = 50*L*(L+1)
      // L = floor((sqrt(1 + 0.08*xp) - 1)/2)
      const L = Math.floor((Math.sqrt(1 + 0.08 * xp) - 1) / 2);
      return Math.max(1, L);
    }

    function fillSelect(sel){
      for(let i=0;i<=9;i++){
        const op = document.createElement("option");
        op.value = String(i);
        op.textContent = String(i);
        sel.appendChild(op);
      }
    }

    const d1 = $("d1");
    const d2 = $("d2");
    const d3 = $("d3");
    [d1,d2,d3].forEach(fillSelect);

    const playBtn = $("playBtn");
    const resultBox = $("resultBox");
    const pickedView = $("pickedView");
    const drawnView = $("drawnView");
    const matchCountEl = $("matchCount");
    const xpEarnedEl = $("xpEarned");

    const meNick = $("meNick");
    const meLevel = $("meLevel");
    const meXp = $("meXp");
    const rankBody = $("rankBody");

    $("logoutBtn").onclick = async () => {
      await signOut(auth);
      location.replace("./index.html");
    };

    $("goHomeBtn").onclick = () => {
      location.href = "./index.html";
    };

    $("goRouletteBtn").onclick = () => {
      location.href = "./roulette.html";
    };

    function makeBall(n){
      const div = document.createElement("div");
      div.className = "ball";
      div.textContent = String(n);
      return div;
    }

    function randomDigits3(){
      return [0,0,0].map(()=>Math.floor(Math.random()*10));
    }

    // â€œê°œìˆ˜ ì¼ì¹˜â€ë¥¼ ì¤‘ë³µ í¬í•¨ìœ¼ë¡œ ê³„ì‚° (ìˆœì„œ ìƒê´€ì—†ì´ 0~3ê°œ)
    function countMatches(picked, drawn){
      const cntP = Array(10).fill(0);
      const cntD = Array(10).fill(0);
      picked.forEach(n=>cntP[n]++);
      drawn.forEach(n=>cntD[n]++);
      let m = 0;
      for(let i=0;i<=9;i++) m += Math.min(cntP[i], cntD[i]);
      return m; // 0~3
    }

    function xpByMatch(m){
      if(m===3) return 50000;
      if(m===2) return 10000;
      if(m===1) return 5000;
      return 1000;
    }

    function safeStr(v){ return String(v ?? "").trim(); }

    async function ensureUserDoc(user){
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      if(!snap.exists()){
        // ì‹ ê·œ ìœ ì € ë¬¸ì„œ ìƒì„± (ë‹‰ë„¤ì„ì€ ì´ë©”ì¼ ì•ë¶€ë¶„ìœ¼ë¡œ ì„ì‹œ)
        const email = safeStr(user.email);
        const nickGuess = email ? email.split("@")[0] : (user.displayName || "ì‚¬ìš©ì");

        await setDoc(ref, {
          uid: user.uid,
          email: user.email || null,
          nickname: nickGuess,
          role: "user",
          xp: 0,
          level: 1,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });

        return ref;
      }

      // ì´ë¯¸ ì¡´ì¬í•˜ë©´: nickname/role ë“± ê¸°ì¡´ê°’ ìœ ì§€, xp/level ì—†ìœ¼ë©´ë§Œ ì±„ì›€
      const data = snap.data() || {};
      const patch = {};
      if(data.xp === undefined) patch.xp = 0;
      if(data.level === undefined) patch.level = calcLevelFromXp(data.xp ?? 0);
      if(Object.keys(patch).length){
        patch.updatedAt = serverTimestamp();
        await setDoc(ref, patch, { merge: true });
      }
      return ref;
    }

    async function loadMe(user){
      const ref = await ensureUserDoc(user);
      const snap = await getDoc(ref);
      const data = snap.data() || {};

      meNick.textContent = data.nickname || "-";
      meXp.textContent = String(data.xp ?? 0);
      meLevel.textContent = String(data.level ?? calcLevelFromXp(data.xp ?? 0));

      return { ref, data };
    }

    async function loadRanking(){
      rankBody.innerHTML = "";
      const q = query(collection(db, "users"), orderBy("level", "desc"), orderBy("xp", "desc"), limit(5));
      const snaps = await getDocs(q);
      let i=1;
      snaps.forEach(s=>{
        const u = s.data() || {};
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i++}</td>
          <td>${(u.nickname || "-")}</td>
          <td class="right">${(u.level ?? 1)}</td>
          <td class="right">${(u.xp ?? 0)}</td>
        `;
        rankBody.appendChild(tr);
      });
    }

    async function playLotto(user){
      clearErr();
      playBtn.disabled = true;

      try{
        const picked = [Number(d1.value), Number(d2.value), Number(d3.value)];
        const drawn = randomDigits3();
        const m = countMatches(picked, drawn);
        const earned = xpByMatch(m);

        // UI í‘œì‹œ
        pickedView.innerHTML = "";
        drawnView.innerHTML = "";
        picked.forEach(n=>pickedView.appendChild(makeBall(n)));
        drawn.forEach(n=>drawnView.appendChild(makeBall(n)));
        matchCountEl.textContent = String(m);
        xpEarnedEl.textContent = String(earned);
        resultBox.style.display = "grid";

        const userRef = doc(db, "users", user.uid);

        // DB ì €ì¥ + ê²½í—˜ì¹˜ ì—…ë°ì´íŠ¸ (íŠ¸ëœì­ì…˜)
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(userRef);
          if(!snap.exists()) throw new Error("users ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. (ê°€ì…/ë¡œê·¸ì¸ë¶€í„° ë‹¤ì‹œ í™•ì¸)");
          const data = snap.data() || {};

          const newXp = (Number(data.xp||0) + earned);
          const newLevel = calcLevelFromXp(newXp);

          tx.update(userRef, { xp: newXp, level: newLevel, updatedAt: serverTimestamp() });

          const playRef = doc(collection(db, "lottoPlays"));
          tx.set(playRef, {
            uid: user.uid,
            nickname: data.nickname || (user.email ? user.email.split("@")[0] : "ì‚¬ìš©ì"),
            picked,
            drawn,
            matchCount: m,
            xpEarned: earned,
            createdAt: serverTimestamp()
          });
        });

        await loadMe(user);
        await loadRanking();
      }catch(e){
        showErr(e);
      }finally{
        playBtn.disabled = false;
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        // âœ… ë¬´í•œë°˜ë³µ ë°©ì§€: ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ lotto.htmlë¡œ ë³µê·€
        location.replace("./index.html?next=lotto.html");
        return;
      }

      clearErr();
      try{
        await loadMe(user);
        await loadRanking();
        playBtn.onclick = () => playLotto(user);
      }catch(e){
        showErr(e);
      }
    });
  </script>
</body>
</html>
