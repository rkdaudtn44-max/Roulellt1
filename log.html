<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Í∏∞Î°ù</title>

<style>
:root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--danger:#ef4444;}
body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
.top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px;display:flex;gap:10px;align-items:center;}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
.wrap{max-width:900px;margin:0 auto;padding:14px;}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0;}
.muted{color:var(--muted);font-size:13px}
.danger{color:var(--danger);font-weight:700;font-size:13px}
.badge{border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700}
.itemRow{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:8px;background:#fff}
.itemBtns{display:flex;gap:6px}
.smallBtn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 8px;font-weight:700;cursor:pointer}
</style>
</head>
<body>

<div class="top">
<button class="btn" onclick="location.href='roulette.html'">‚Üê Î£∞Î†õ</button>
<button class="btn" onclick="location.href='lotto.html'">üéüÔ∏è Î≥µÍ∂å</button>
<div style="flex:1"></div>
<div id="who" class="muted"></div>
<button class="btn" onclick="loadData()">ÏÉàÎ°úÍ≥†Ïπ®</button>
</div>

<div class="wrap">
<div class="card">
<h3>Í∏∞Î°ù (Ìï≠Î™©Î≥Ñ Ïπ¥Ïö¥Ìä∏)</h3>
<div id="loadState" class="muted">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
<div id="errBox" class="danger" style="display:none;"></div>
</div>

<div id="dataBox"></div>
</div>

<!-- Firebase compat (Safari ÏïàÏ†ïÌòï) -->
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
  authDomain: "roulette-b5455.firebaseapp.com",
  projectId: "roulette-b5455"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAILS = ["dori0223@gmail.com"];

let currentUser = null;
let isAdmin = false;

function showError(e){
  console.error(e);
  const box = document.getElementById("errBox");
  box.style.display = "block";
  box.textContent = "Ïò§Î•ò: " + (e.message || e);
}

function clearError(){
  const box = document.getElementById("errBox");
  box.style.display = "none";
  box.textContent = "";
}

auth.onAuthStateChanged(async user=>{
  if(!user){
    location.replace("index.html");
    return;
  }

  currentUser = user;
  isAdmin = ADMIN_EMAILS.includes((user.email||"").toLowerCase());

  document.getElementById("who").textContent =
    (user.email || "") + (isAdmin ? " ¬∑ admin" : "");

  loadData();
});

async function loadData(){
  clearError();
  document.getElementById("loadState").textContent = "Î∂àÎü¨Ïò§Îäî Ï§ë...";
  document.getElementById("dataBox").innerHTML = "";

  try{
    const userSnap = await db.collection("users").doc(currentUser.uid).get();
    if(!userSnap.exists){
      document.getElementById("loadState").textContent = "Ïú†Ï†Ä Î¨∏ÏÑú ÏóÜÏùå";
      return;
    }

    const myNick = userSnap.data().nickname;

    let nickList = [];

    if(isAdmin){
      const snap = await db.collection("counts").get();
      snap.forEach(d=>nickList.push(d.id));
    }else{
      nickList = [myNick];
    }

    if(nickList.length===0){
      document.getElementById("loadState").textContent="Í∏∞Î°ù ÏóÜÏùå";
      return;
    }

    let totalSum = 0;

    for(const nick of nickList){
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `<b>${nick}</b>`;
      document.getElementById("dataBox").appendChild(card);

      const typesSnap = await db.collection("counts").doc(nick).collection("types").get();

      for(const typeDoc of typesSnap.docs){
        const type = typeDoc.id;

        const itemsSnap = await db.collection("counts")
          .doc(nick).collection("types")
          .doc(type).collection("items").get();

        itemsSnap.forEach(itemDoc=>{
          const data = itemDoc.data();
          const count = data.count || 0;
          totalSum += count;

          const row = document.createElement("div");
          row.className="itemRow";
          row.innerHTML=`
            <div>${data.itemText} (${type})</div>
            <div class="itemBtns">
              <span>${count}</span>
              ${isAdmin ? `
              <button class="smallBtn" onclick="updateCount('${nick}','${type}','${itemDoc.id}','${data.itemText}',1)">+</button>
              <button class="smallBtn" onclick="updateCount('${nick}','${type}','${itemDoc.id}','${data.itemText}',-1)">-</button>
              ` : ""}
            </div>
          `;
          card.appendChild(row);
        });
      }
    }

    document.getElementById("loadState").textContent =
      "Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å ‚úÖ (Ìï©ÏÇ∞ Ï¥ù " + totalSum + "Ìöå)";
  }
  catch(e){
    document.getElementById("loadState").textContent="Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®";
    showError(e);
  }
}

async function updateCount(nick,type,itemId,itemText,delta){
  try{
    const ref = db.collection("counts")
      .doc(nick).collection("types")
      .doc(type).collection("items").doc(itemId);

    await db.runTransaction(async tx=>{
      const snap = await tx.get(ref);
      if(!snap.exists && delta>0){
        tx.set(ref,{itemText,count:delta});
      }else if(snap.exists){
        const next = Math.max(0,(snap.data().count||0)+delta);
        if(next===0) tx.delete(ref);
        else tx.update(ref,{count:next});
      }
    });

    loadData();
  }
  catch(e){
    showError(e);
  }
}
</script>
</body>
</html>
