<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë£°ë › ë¡œê·¸</title>

<style>
  :root{--bg:#f4f5f7;--card:#fff;--text:#111;--muted:#666;--line:#e8e8e8;--main:#111;--blue:#2f6fed;}
  body{margin:0;font-family:system-ui,-apple-system,Arial;background:var(--bg);color:var(--text);}
  header{position:sticky;top:0;z-index:5;background:rgba(244,245,247,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);}
  .topbar{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;}
  .title{font-size:20px;font-weight:900;display:flex;gap:8px;align-items:center;}
  .right{display:flex;align-items:center;gap:10px;}
  .nick{font-size:12px;padding:7px 10px;border-radius:999px;background:#fff;border:1px solid var(--line);display:none;}
  .btn{border:none;cursor:pointer;padding:10px 12px;border-radius:12px;background:var(--main);color:#fff;font-weight:900;font-size:13px;}
  .btn.secondary{background:#fff;color:#111;border:1px solid var(--line);}
  .btn.danger{background:#e53935;}
  .btn:active{transform:translateY(1px);}
  main{max-width:980px;margin:0 auto;padding:16px;}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;}
  .loginBar{display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .loginLeft{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  input{padding:11px 12px;border-radius:12px;border:1px solid var(--line);font-size:14px;}
  .hint{font-size:12px;color:var(--muted);line-height:1.4;margin:10px 2px 0;}
  a{color:var(--blue);text-decoration:none;font-weight:900;}
  #log{margin-top:12px;display:flex;flex-direction:column;gap:10px;}
  .row{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .row .left{display:flex;flex-direction:column;gap:5px;}
  .row b{font-size:14px;}
  .meta{font-size:12px;color:var(--muted);}
  .ctrl{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .hidden{display:none !important;}

  /* íšŒì›ê°€ì… ëª¨ë‹¬ */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10;padding:18px;}
  .modal{width:min(420px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.18);overflow:hidden;}
  .modalHead{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--line);font-weight:900;}
  .xbtn{border:none;background:#f2f2f2;border-radius:10px;width:36px;height:36px;cursor:pointer;font-size:18px;}
  .modalBody{padding:14px;display:flex;flex-direction:column;gap:10px;}
  .modalFoot{padding:14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end;}
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">ğŸ“Š ë£°ë › ë¡œê·¸</div>
    <div class="right">
      <span id="nickBadge" class="nick"></span>
      <button id="wipeAllBtn" class="btn danger" style="display:none;">ì „ì²´ì‚­ì œ</button>
      <button id="logoutBtn" class="btn secondary" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</header>

<main>
  <!-- âœ… ë¡œê·¸ì¸í•˜ë©´ ì´ ì¹´ë“œê°€ í†µì§¸ë¡œ ì‚¬ë¼ì§ -->
  <div id="authBox" class="card">
    <div class="loginBar">
      <div class="loginLeft">
        <input id="email" placeholder="ì´ë©”ì¼" autocomplete="email" />
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì+)" autocomplete="current-password" />
        <button class="btn" id="loginBtn">ë¡œê·¸ì¸</button>
        <button class="btn secondary" id="openSignupBtn">íšŒì›ê°€ì…</button>
      </div>
      <div class="meta" id="status">ë¯¸ë¡œê·¸ì¸</div>
    </div>
  </div>

  <div class="hint">
    - ë¡œê·¸ì¸í•˜ë©´ ì…ë ¥ì°½ì´ ì‚¬ë¼ì§€ê³ , ìš°ì¸¡ ìƒë‹¨ì— ë‹‰ë„¤ì„ë§Œ ë– .<br>
    - ê°€ìš´ë°ëŠ” ê¸°ë¡ë§Œ ë³´ì—¬.<br>
    - ê´€ë¦¬ìë§Œ +/âˆ’/ì‚­ì œ/ì „ì²´ì‚­ì œ ë²„íŠ¼ì´ ë³´ì—¬.<br>
    - <a href="index.html">â† ë£°ë › í˜ì´ì§€</a>
  </div>

  <div id="log"></div>
</main>

<!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="signupBack" class="modalBack">
  <div class="modal">
    <div class="modalHead">
      <span>íšŒì›ê°€ì…(ë‹‰ë„¤ì„ í¬í•¨)</span>
      <button class="xbtn" id="closeSignupBtn">Ã—</button>
    </div>
    <div class="modalBody">
      <input id="suNick" placeholder="ë‹‰ë„¤ì„(ìµœëŒ€ 20ì)" maxlength="20" />
      <input id="suEmail" placeholder="ì´ë©”ì¼" autocomplete="email" />
      <input id="suPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì+)" autocomplete="new-password" />
      <div class="meta">* ê°€ì… í›„ ìš°ì¸¡ìƒë‹¨ì— ë‹‰ë„¤ì„ì´ í‘œì‹œë¼.</div>
    </div>
    <div class="modalFoot">
      <button class="btn secondary" id="cancelSignupBtn">ì·¨ì†Œ</button>
      <button class="btn" id="doSignupBtn">ê°€ì…í•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- âœ… DOM ì•„ë˜ì—ì„œ ì‹¤í–‰(ì¤‘ìš”) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, orderBy, increment, writeBatch, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
  authDomain: "roulette-b5455.firebaseapp.com",
  projectId: "roulette-b5455",
  storageBucket: "roulette-b5455.firebasestorage.app",
  messagingSenderId: "728191308035",
  appId: "1:728191308035:web:b14b46c38bbe0261969936"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = (id)=>document.getElementById(id);

let currentUser = null;
let isAdmin = false;

function openSignup(){ $("signupBack").style.display="flex"; }
function closeSignup(){ $("signupBack").style.display="none"; }

$("openSignupBtn").addEventListener("click", openSignup);
$("closeSignupBtn").addEventListener("click", closeSignup);
$("cancelSignupBtn").addEventListener("click", closeSignup);
$("signupBack").addEventListener("click",(e)=>{ if(e.target===$("signupBack")) closeSignup(); });

async function checkAdmin(uid){
  const s = await getDoc(doc(db,"admins",uid));
  return s.exists();
}

function showLoggedOut(){
  $("status").textContent = "ë¯¸ë¡œê·¸ì¸";
  $("authBox").classList.remove("hidden");
  $("logoutBtn").style.display = "none";
  $("nickBadge").style.display = "none";
  $("wipeAllBtn").style.display = "none";
  $("log").innerHTML = `<div class="row"><div class="left"><b>ë¡œê·¸ì¸ì´ í•„ìš”í•´</b><div class="meta">ë¡œê·¸ì¸í•˜ë©´ ê¸°ë¡ì´ ë³´ì—¬.</div></div></div>`;
}

function showLoggedIn(nickname){
  $("status").textContent = "ë¡œê·¸ì¸ë¨";
  // âœ… ë¡œê·¸ì¸ ì„±ê³µí•˜ë©´ ì…ë ¥ì°½ ì¹´ë“œ ì™„ì „ ìˆ¨ê¹€
  $("authBox").classList.add("hidden");

  $("logoutBtn").style.display = "inline-block";
  $("nickBadge").style.display = "inline-block";
  $("nickBadge").textContent = nickname ? `ë‹‰ë„¤ì„: ${nickname}${isAdmin ? " (ê´€ë¦¬ì)" : ""}` : `UID: ${currentUser.uid.slice(0,8)}â€¦${isAdmin ? " (ê´€ë¦¬ì)" : ""}`;
  $("wipeAllBtn").style.display = isAdmin ? "inline-block" : "none";
}

$("doSignupBtn").addEventListener("click", async ()=>{
  const nickname = $("suNick").value.trim();
  const email = $("suEmail").value.trim();
  const pw = $("suPw").value;

  if(!nickname){ alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜"); return; }
  if(!email){ alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì¤˜"); return; }
  if(!pw || pw.length < 6){ alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì•¼"); return; }

  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pw);
    await setDoc(doc(db,"users", cred.user.uid), { nickname, email, createdAt: new Date().toISOString() });
    alert("íšŒì›ê°€ì… ì™„ë£Œ! (ë¡œê·¸ì¸ë¨)");
    closeSignup();
  }catch(e){
    alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + (e.code || e.message));
  }
});

$("loginBtn").addEventListener("click", async ()=>{
  const email = $("email").value.trim();
  const pw = $("pw").value;
  try{
    await signInWithEmailAndPassword(auth, email, pw);
  }catch(e){
    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (e.code || e.message));
  }
});

$("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

async function loadLogs(){
  if(!currentUser) return;

  $("log").innerHTML = "";

  let snap;
  try{
    snap = await getDocs(query(collection(db,"logs"), orderBy("createdAt","desc"), limit(200)));
  }catch{
    snap = await getDocs(collection(db,"logs"));
  }

  if(snap.empty){
    $("log").innerHTML = `<div class="row"><div class="left"><b>ê¸°ë¡ì´ ì•„ì§ ì—†ì–´</b><div class="meta">ë£°ë ›ì„ ëŒë¦¬ë©´ ì—¬ê¸°ì— ìŒ“ì—¬.</div></div></div>`;
    return;
  }

  snap.forEach((docSnap)=>{
    const d = docSnap.data();
    const nick = d.nickname || "(ë‹‰ë„¤ì„ì—†ìŒ)";
    const roulette = d.roulette || "(ë£°ë ›)";
    const count = Number(d.count || 0);

    const row = document.createElement("div");
    row.className = "row";

    const adminButtons = isAdmin ? `
      <div class="ctrl">
        <button class="btn secondary" data-minus="${docSnap.id}">-</button>
        <button class="btn secondary" data-plus="${docSnap.id}">+</button>
        <button class="btn danger" data-del="${docSnap.id}">ì‚­ì œ</button>
      </div>
    ` : `<div class="meta">ì½ê¸° ì „ìš©</div>`;

    row.innerHTML = `
      <div class="left">
        <b>${escapeHtml(nick)} Â· ${escapeHtml(roulette)} (${count}íšŒ)</b>
        <div class="meta">id: ${docSnap.id}</div>
      </div>
      ${adminButtons}
    `;

    if(isAdmin){
      row.querySelector(`[data-plus="${docSnap.id}"]`)?.addEventListener("click", async ()=>{
        await updateDoc(doc(db,"logs",docSnap.id), { count: increment(1) });
        loadLogs();
      });

      row.querySelector(`[data-minus="${docSnap.id}"]`)?.addEventListener("click", async ()=>{
        const ref = doc(db,"logs",docSnap.id);
        const cur = Number(d.count || 0);
        if(cur <= 1) await deleteDoc(ref);
        else await updateDoc(ref, { count: increment(-1) });
        loadLogs();
      });

      row.querySelector(`[data-del="${docSnap.id}"]`)?.addEventListener("click", async ()=>{
        if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ?")) return;
        await deleteDoc(doc(db,"logs",docSnap.id));
        loadLogs();
      });
    }

    $("log").appendChild(row);
  });
}

$("wipeAllBtn").addEventListener("click", async ()=>{
  if(!isAdmin) return;
  if(!confirm("âš ï¸ ì „ì²´ ì‚­ì œí• ê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)")) return;

  const snap = await getDocs(collection(db,"logs"));
  const docs = [];
  snap.forEach(d=>docs.push(d));
  const batch = writeBatch(db);
  docs.slice(0,400).forEach(d=>{
    batch.delete(doc(db,"logs", d.id));
  });
  await batch.commit();
  alert("ì „ì²´ì‚­ì œ ì™„ë£Œ");
  loadLogs();
});

onAuthStateChanged(auth, async (user)=>{
  currentUser = user || null;

  if(!user){
    isAdmin = false;
    showLoggedOut();
    return;
  }

  isAdmin = await checkAdmin(user.uid);

  let nickname = "";
  try{
    const u = await getDoc(doc(db,"users", user.uid));
    nickname = u.exists() ? (u.data().nickname || "") : "";
  }catch{}

  showLoggedIn(nickname);
  loadLogs();
});
</script>

</body>
</html>
