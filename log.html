<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë£°ë › ë¡œê·¸</title>

<style>
  :root{--bg:#f4f5f7;--card:#fff;--text:#111;--muted:#666;--line:#e8e8e8;--main:#111;}
  body{margin:0;font-family:system-ui,-apple-system,Arial;background:var(--bg);color:var(--text);}
  header{position:sticky;top:0;z-index:5;background:rgba(244,245,247,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);}
  .topbar{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;}
  .title{font-size:20px;font-weight:900}
  .right{display:flex;align-items:center;gap:10px;}
  .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--line);}
  .btn{border:none;cursor:pointer;padding:10px 12px;border-radius:12px;background:var(--main);color:#fff;font-weight:900;font-size:13px;}
  .btn.secondary{background:#fff;color:#111;border:1px solid var(--line);}
  .btn.danger{background:#e53935;}
  .btn:active{transform:translateY(1px);}
  main{max-width:980px;margin:0 auto;padding:16px;}
  .loginBar{display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--card);border:1px solid var(--line);padding:12px;border-radius:16px;}
  .loginLeft{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  input{padding:11px 12px;border-radius:12px;border:1px solid var(--line);font-size:14px;}
  .hint{font-size:12px;color:var(--muted);line-height:1.4;margin:10px 2px 0;}
  #log{margin-top:12px;display:flex;flex-direction:column;gap:10px;}
  .row{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .row .left{display:flex;flex-direction:column;gap:5px;}
  .row b{font-size:14px;}
  .meta{font-size:12px;color:var(--muted);}
  .ctrl{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  a{color:#2f6fed;text-decoration:none;font-weight:900;}

  /* íšŒì›ê°€ì… ëª¨ë‹¬ */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10;padding:18px;}
  .modal{width:min(420px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.18);overflow:hidden;}
  .modalHead{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--line);font-weight:900;}
  .xbtn{border:none;background:#f2f2f2;border-radius:10px;width:36px;height:36px;cursor:pointer;font-size:18px;}
  .modalBody{padding:14px;display:flex;flex-direction:column;gap:10px;}
  .modalFoot{padding:14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end;}
  .hidden{display:none;}
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">ğŸ“Š ë£°ë › ë¡œê·¸</div>
    <div class="right">
      <span id="nickBadge" class="badge" style="display:none;"></span>
      <button id="wipeAllBtn" class="btn danger" style="display:none;">ì „ì²´ì‚­ì œ</button>
      <button id="logoutBtn" class="btn secondary" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</header>

<main>
  <div id="loginBar" class="loginBar">
    <div class="loginLeft">
      <input id="email" placeholder="ì´ë©”ì¼" autocomplete="email" />
      <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì+)" autocomplete="current-password" />
      <button class="btn" id="loginBtn">ë¡œê·¸ì¸</button>
      <button class="btn secondary" id="openSignupBtn">íšŒì›ê°€ì…</button>
    </div>
    <div class="meta" id="status">ë¯¸ë¡œê·¸ì¸</div>
  </div>

  <div class="hint">
    - ë¡œê·¸ì¸í•˜ë©´ ê°€ìš´ë°ì— ê¸°ë¡ì´ ë³´ì—¬.<br>
    - <b>ê´€ë¦¬ìë§Œ</b> + / âˆ’ / ì‚­ì œ / ì „ì²´ì‚­ì œê°€ ë³´ì´ê³  ì‘ë™í•´.<br>
    - <a href="index.html">â† ë£°ë › í˜ì´ì§€</a>
  </div>

  <div id="log"></div>
</main>

<!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="signupBack" class="modalBack">
  <div class="modal">
    <div class="modalHead">
      <span>íšŒì›ê°€ì…(ë‹‰ë„¤ì„ í¬í•¨)</span>
      <button class="xbtn" id="closeSignupBtn">Ã—</button>
    </div>
    <div class="modalBody">
      <input id="suNick" placeholder="ë‹‰ë„¤ì„(ìµœëŒ€ 20ì)" maxlength="20" />
      <input id="suEmail" placeholder="ì´ë©”ì¼" autocomplete="email" />
      <input id="suPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì+)" autocomplete="new-password" />
      <div class="meta">* ê°€ì… í›„ ìš°ì¸¡ìƒë‹¨ì— ë‹‰ë„¤ì„ì´ í‘œì‹œë¼.</div>
    </div>
    <div class="modalFoot">
      <button class="btn secondary" id="cancelSignupBtn">ì·¨ì†Œ</button>
      <button class="btn" id="doSignupBtn">ê°€ì…í•˜ê¸°</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  increment,
  writeBatch,
  limit
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
  authDomain: "roulette-b5455.firebaseapp.com",
  projectId: "roulette-b5455",
  storageBucket: "roulette-b5455.firebasestorage.app",
  messagingSenderId: "728191308035",
  appId: "1:728191308035:web:b14b46c38bbe0261969936"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = (id)=>document.getElementById(id);

let currentUser = null;
let isAdmin = false;

function openSignup(){ $("signupBack").style.display="flex"; }
function closeSignup(){ $("signupBack").style.display="none"; }

$("openSignupBtn").addEventListener("click", openSignup);
$("closeSignupBtn").addEventListener("click", closeSignup);
$("cancelSignupBtn").addEventListener("click", closeSignup);
$("signupBack").addEventListener("click",(e)=>{ if(e.target===$("signupBack")) closeSignup(); });

async function checkAdmin(uid){
  const s = await getDoc(doc(db,"admins",uid));
  return s.exists();
}

function showLoggedOut(){
  $("status").textContent = "ë¯¸ë¡œê·¸ì¸";
  $("loginBar").style.display = "flex";
  $("logoutBtn").style.display = "none";
  $("nickBadge").style.display = "none";
  $("wipeAllBtn").style.display = "none";
  $("log").innerHTML = `<div class="row"><div class="left"><b>ë¡œê·¸ì¸ì´ í•„ìš”í•´</b><div class="meta">ë¡œê·¸ì¸í•˜ë©´ ê¸°ë¡ì´ ë³´ì—¬.</div></div></div>`;
}

function showLoggedIn(nickname){
  $("status").textContent = "ë¡œê·¸ì¸ë¨";
  $("loginBar").style.display = "none";
  $("logoutBtn").style.display = "inline-block";
  $("nickBadge").style.display = "inline-block";
  $("nickBadge").textContent = nickname ? `ë‹‰ë„¤ì„: ${nickname}${isAdmin ? " (ê´€ë¦¬ì)" : ""}` : `UID: ${currentUser.uid.slice(0,8)}â€¦${isAdmin ? " (ê´€ë¦¬ì)" : ""}`;
  $("wipeAllBtn").style.display = isAdmin ? "inline-block" : "none";
}

$("doSignupBtn").addEventListener("click", async ()=>{
  const nickname = $("suNick").value.trim();
  const email = $("suEmail").value.trim();
  const pw = $("suPw").value;

  if(!nickname){ alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜"); return; }
  if(!email){ alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì¤˜"); return; }
  if(!pw || pw.length < 6){ alert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì•¼"); return; }

  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pw);
    await setDoc(doc(db,"users", cred.user.uid), { nickname, email, createdAt: new Date().toISOString() });
    alert("íšŒì›ê°€ì… ì™„ë£Œ! (ë¡œê·¸ì¸ë¨)");
    closeSignup();
  }catch(e){
    alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + (e.code || e.message));
  }
});

$("loginBtn").addEventListener("click", async ()=>{
  const email = $("email").value.trim();
  const pw = $("pw").value;
  try{
    await signInWithEmailAndPassword(auth, email, pw);
  }catch(e){
    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (e.code || e.message));
  }
});

$("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

async function loadLogs(){
  if(!currentUser) return;

  $("log").innerHTML = "";

  // ìµœê·¼ 200ê°œë§Œ (ë§ì•„ì§€ë©´ ì„±ëŠ¥ ë•Œë¬¸)
  let snap;
  try{
    snap = await getDocs(query(collection(db,"logs"), orderBy("createdAt","desc"), limit(200)));
  }catch{
    snap = await getDocs(collection(db,"logs"));
  }

  if(snap.empty){
    $("log").innerHTML = `<div class="row"><div class="left"><b>ê¸°ë¡ì´ ì•„ì§ ì—†ì–´</b><div class="meta">ë£°ë ›ì„ ëŒë¦¬ë©´ ì—¬ê¸°ì— ìŒ“ì—¬.</div></div></div>`;
    return;
  }

  snap.forEach((docSnap)=>{
    const d = docSnap.data();
    const nick = d.nickname || "(ë‹‰ë„¤ì„ì—†ìŒ)";
    const roulette = d.roulette || "(ë£°ë ›)";
    const count = Number(d.count || 0);

    const row = document.createElement("div");
    row.className = "row";

    const adminButtons = isAdmin ? `
      <div class="ctrl">
        <button class="btn secondary" data-minus="${docSnap.id}">-</button>
        <button class="btn secondary" data-plus="${docSnap.id}">+</button>
        <button class="btn danger" data-del="${docSnap.id}">ì‚­ì œ</button>
      </div>
    ` : `<div class="meta">ì½ê¸° ì „ìš©</div>`;

    row.innerHTML = `
      <div class="left">
        <b>${escapeHtml(nick)} Â· ${escapeHtml(roulette)} (${count}íšŒ)</b>
        <div class="meta">id: ${docSnap.id}</div>
      </div>
      ${adminButtons}
    `;

    if(isAdmin){
      row.querySelector(`[data-plus="${docSnap.id}"]`)?.addEventListener("click", async ()=>{
        try{
          await updateDoc(doc(db,"logs",docSnap.id), { count: increment(1) });
          loadLogs();
        }catch(e){
          alert("ìˆ˜ì • ì‹¤íŒ¨(ê´€ë¦¬ì ê¶Œí•œ í•„ìš”): " + (e.code || e.message));
        }
      });

      row.querySelector(`[data-minus="${docSnap.id}"]`)?.addEventListener("click", async ()=>{
        try{
          const ref = doc(db,"logs",docSnap.id);
          // - ëˆŒëŸ¬ì„œ 0 ì´í•˜ê°€ ë˜ë©´ ì‚­ì œ
          const cur = Number(d.count || 0);
          if(cur <= 1){
            await deleteDoc(ref);
          }else{
            await updateDoc(ref, { count: increment(-1) });
          }
          loadLogs();
        }catch(e){
          alert("ìˆ˜ì • ì‹¤íŒ¨(ê´€ë¦¬ì ê¶Œí•œ í•„ìš”): " + (e.code || e.message));
        }
      });

      row.querySelector(`[data-del="${docSnap.id}"]`)?.addEventListener("click", async ()=>{
        if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ?")) return;
        try{
          await deleteDoc(doc(db,"logs",docSnap.id));
          loadLogs();
        }catch(e){
          alert("ì‚­ì œ ì‹¤íŒ¨(ê´€ë¦¬ì ê¶Œí•œ í•„ìš”): " + (e.code || e.message));
        }
      });
    }

    $("log").appendChild(row);
  });
}

$("wipeAllBtn").addEventListener("click", async ()=>{
  if(!isAdmin){ return; }
  if(!confirm("âš ï¸ ì „ì²´ ì‚­ì œí• ê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)")) return;

  try{
    const snap = await getDocs(collection(db,"logs"));

    // ë°°ì¹˜ ì œí•œ(500) ë•Œë¬¸ì— ì•ˆì „í•˜ê²Œ 400ê°œê¹Œì§€ë§Œ
    const docs = [];
    snap.forEach(d=>docs.push(d));
    if(docs.length > 400){
      alert("ê¸°ë¡ì´ ë„ˆë¬´ ë§ì•„ì„œ í•œ ë²ˆì— 400ê°œê¹Œì§€ë§Œ ì‚­ì œí•´. (ì—¬ëŸ¬ ë²ˆ ëˆŒëŸ¬ì£¼ë©´ ë¨)");
    }

    const batch = writeBatch(db);
    docs.slice(0,400).forEach(d=>{
      batch.delete(doc(db,"logs", d.id));
    });
    await batch.commit();
    alert("ì „ì²´ì‚­ì œ ì™„ë£Œ");
    loadLogs();
  }catch(e){
    alert("ì „ì²´ì‚­ì œ ì‹¤íŒ¨(ê´€ë¦¬ì ê¶Œí•œ í•„ìš”): " + (e.code || e.message));
  }
});

onAuthStateChanged(auth, async (user)=>{
  currentUser = user || null;

  if(!user){
    isAdmin = false;
    showLoggedOut();
    return;
  }

  isAdmin = await checkAdmin(user.uid);

  // ë‹‰ë„¤ì„ ë¶ˆëŸ¬ì˜¤ê¸°
  let nickname = "";
  try{
    const u = await getDoc(doc(db,"users", user.uid));
    nickname = u.exists() ? (u.data().nickname || "") : "";
  }catch{}

  showLoggedIn(nickname);
  loadLogs();
});
</script>

</body>
</html>
