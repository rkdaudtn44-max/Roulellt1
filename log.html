<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ë£°ë › ê¸°ë¡ ê´€ë¦¬</title>
<style>
body { font-family: Arial, sans-serif; background:#f0f0f0; padding:30px; }
.control { background:#fff; padding:15px; border-radius:10px; margin-bottom:16px; }
.small { color:#666; font-size:12px; margin-top:8px; line-height:1.35; }
button { font-size:12px; cursor:pointer; }
.delete-all { background:#e53935; color:white; border:none; padding:8px 12px; border-radius:8px; margin-left:10px; }
.delete-all:hover { background:#c62828; }
.list { display:flex; flex-direction:column; gap:10px; }
.user-card{ background:#fff; border-radius:12px; overflow:hidden; box-shadow: 0 1px 0 rgba(0,0,0,0.04); }
.user-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 14px; cursor:pointer; user-select:none; }
.user-head:hover{ background:#fafafa; }
.user-name{ font-weight:700; font-size:15px; }
.user-meta{ display:flex; align-items:center; gap:10px; color:#666; font-size:12px; }
.pill{ background:#f0f0f0; border-radius:999px; padding:4px 8px; }
.chev{ font-size:16px; width:26px; height:26px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:#f3f3f3; }
.user-body{ display:none; padding:12px 14px 14px; border-top:1px solid #eee; }
.user-body.open{ display:block; }
.roulette-title{ margin-top:12px; font-weight:700; font-size:13px; }
.grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:8px 12px; margin-top:10px; }
.cell { background:#e9e9e9; padding:8px 10px; border-radius:8px; font-size:13px; display:flex; justify-content:space-between; align-items:center; gap: 10px; }
.cell .label { text-align:left; }
.cell .btns { white-space:nowrap; }
.cell button { font-size:11px; margin-left:4px; }
.hr{ height:1px; background:#eee; margin:12px 0; }
a{color:#3b6ff5;text-decoration:none}
</style>
</head>
<body>

<h1>ğŸ“Š ë£°ë › ê¸°ë¡ ê´€ë¦¬</h1>

<div class="control">
  ğŸ” <input id="search" placeholder="ë‹‰ë„¤ì„ / ë£°ë ›ëª…" style="padding:8px; border-radius:8px; border:1px solid #ddd; width:220px;">
  <button id="searchBtn" style="padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fff;">ê²€ìƒ‰</button>

  <button class="delete-all" id="deleteAllBtn">ğŸš¨ ì „ì²´ ì‚­ì œ (í…ŒìŠ¤íŠ¸ìš©)</button>

  <div class="small">
    - ì²˜ìŒì—” ë‹‰ë„¤ì„ë§Œ ë³´ì—¬ìš”. ë‹‰ë„¤ì„ì„ ëˆ„ë¥´ë©´ ê·¸ ì‚¬ëŒ ê¸°ë¡ì´ í¼ì³ì§‘ë‹ˆë‹¤.<br>
    - +/âˆ’ ë²„íŠ¼ìœ¼ë¡œ ì¹´ìš´íŠ¸ ìˆ˜ì • ê°€ëŠ¥(0 ì´í•˜ë©´ ìë™ ì‚­ì œ).<br>
    - ì „ì²´ ì‚­ì œ ë²„íŠ¼ì€ í…ŒìŠ¤íŠ¸ìš©ì…ë‹ˆë‹¤(ìµœì¢…ë³¸ì—ì„œëŠ” ì œê±°).<br>
    - <a href="index.html">â† ë£°ë ›ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>
</div>

<div id="log" class="list"></div>

<script>
(function(){
  window.addEventListener("error", () => {
    const log = document.getElementById("log");
    if(log){
      log.innerHTML = "";
      const card = document.createElement("div");
      card.className = "user-card";
      const head = document.createElement("div");
      head.className = "user-head";
      head.innerHTML = "<b>â— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</b>";
      const body = document.createElement("div");
      body.className = "user-body open";
      body.innerHTML = "ì½˜ì†”ì˜ ë¹¨ê°„ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ìº¡ì²˜í•´ì„œ ë³´ë‚´ì£¼ë©´ ë°”ë¡œ ê³ ì³ì¤„ê²Œ.";
      card.appendChild(head);
      card.appendChild(body);
      log.appendChild(card);
    }
  });

  function getData(){
    try { return JSON.parse(localStorage.getItem("rouletteLog")) || {}; }
    catch { return {}; }
  }
  function saveData(d){ localStorage.setItem("rouletteLog", JSON.stringify(d)); }

  function deleteAll(){
    if(!confirm("âš ï¸ ì •ë§ë¡œ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?\n(ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;
    localStorage.removeItem("rouletteLog");
    alert("ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    render();
  }

  const normalOrder = [
    "ëƒ¥ë©ì²´[3ë¶„]","ì›í•˜ëŠ”ì²´[3ë¶„_5ê¸€ì]","ì§§ì€ì• êµëŒ€ì‚¬[5ì¤„ ì´í•˜]","íŒ¬ë³´ë“œ",
    "í˜€ë´‰ì¸[1ë¶„]","ë°›ì¹¨ë´‰ì¸[1ë¶„]","ì˜ ì–´ê¸ˆì§€[3ë¶„]","ì¹¨ë±‰ê¸°",
    "ì§§ì€íŒ¬ë³´ë“œ[1~2ì¤„]","ì‹¤ë“œ+100","ì‹¤ë“œ-100","ASMRë°©ì†¡[3ë¶„]",
    "ë£°ë › ë‹¤ëŒê¶Œ","í—¬ê¸° ë¦¬ì•¡[í‚µx]","ã…‡ë°›ì¹¨ì²´[2ë¶„]","ì¶œì„ì²´í¬ ë¦¬ì•¡[í‚µx]",
    "ë¸Œë¼ë³´[í‚µx]","3ì¸ì¹­[1ë¶„]","ë°©ì¢…ê¹Œì§€ ì‰´ë“œ 0ê°œ[í‚µx]","ë°œë°•ìˆ˜",
    "ë°©ì œ ë³€ê²½ê¶Œ[10ë¶„/í‚µ ë¶ˆê°€]","ë°°ê²½ì‚¬ì§„ ë³€ê²½ê¶Œ[10ë¶„/í‚µ ë¶ˆê°€]",
    "ì—°í•˜ì¶©ì• êµë„ë¦¬[1ë¶„]","ë´‰ì¸ì¶”ê°€","ë´‰ì¸ì œê±°",
    "ì´ì‘¤ì‹œê°œ ë¦¬ì•¡ì…˜[í‚µx]","ë°°í†µí†µ[í‚µx]",
    "ê³µì§€ë³€ê²½ê¶Œ[ë‹¤ìŒ ë°©ì†¡ê¹Œì§€]","ë°•ìˆ˜ 3ë²ˆ[í‚µx]",
    "íˆ¬ëª…ì˜ì 1ë¶„[í‚µx]","ìŠ¤ì¿¼íŠ¸ 5ê°œ[í‚µx]",
    "ë²½ì°[í‚µx]","TMI 1ê°œ ì˜¬ë¦¬ê¸°","ì´ë¦„ 3ë²ˆ ë¶ˆëŸ¬ì£¼ê¸°","ê½"
  ];

  const nobleOrder = [
    "24ì‹œê°„ ë‹‰ë³€ê¶Œ","24ì‹œê°„ ì—­ë‹‰ë³€ê¶Œ",
    "ì›í•˜ëŠ” ë…¹ìŒë³¸ ë³´ë‚´ì£¼ê¸°[ì§§ì€ ì• êµ/ì›í•˜ëŠ” ëŒ€ì‚¬/ë¦¬ì•¡ì…˜]",
    "ë‹¨ë… ë°•ì œí¸ì§€",
    "ë£°ë › ì„ íƒê¶Œ[ê¸°ë³¸ or ê·€ì¡± ì¤‘ ì›í•˜ëŠ” ê²ƒ í•˜ë‚˜ ê³ ë¥´ê¸°]",
    "ìºìŠ¤íŠ¸ ì €ì¥ê¶Œ 2íšŒ","ì‹¤ë“œ 2ë°°","ì‹¤ë“œí‘ 2ë°°",
    "ê·€ì¡±ë£°ë › í• ì¸ê¶Œ(250ìŠ¤í‘¼,3ë¶„/ë³¸ì¸ë§Œ ì‚¬ìš© ê°€ëŠ¥)",
    "ê·€ì¡±ë£°ë › ë‹¤ëŒê¶Œ",
    "ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ìºìŠ¤íŠ¸ ì €ì¥ê¶Œ",
    "ì›í•˜ëŠ” ë…¹ìŒë³¸ ìºìŠ¤íŠ¸[ì§§ì€ ì• êµ/ì›í•˜ëŠ” ëŒ€ì‚¬/ë¦¬ì•¡ì…˜/1ì¼]",
    "ì‹¤ë“œ ìŒìˆ˜ë¡œ ë³€ê²½","ì‹¤ë“œ ì–‘ìˆ˜ë¡œ ë³€ê²½",
    "ê²Œì„ ë°ì´íŠ¸ê¶Œ[1ì‹œê°„/ë§ˆì´í¬ ì‚¬ìš©ì€ ìƒëŒ€ë°©ì— ë”°ë¼]",
    "íŒ¬ë³´ë“œ 3ê°œ ì¶”ê°€","ë„ë¦¬ ìš©ëˆ"
  ];

  const timeOrder = [
    "ë°©ì†¡ ì—°ì¥ê¶Œ +1ë¶„","ë°©ì†¡ ì—°ì¥ê¶Œ +10ë¶„","ë°©ì†¡ ì—°ì¥ê¶Œ +20ë¶„","ë°©ì†¡ ì—°ì¥ê¶Œ +30ë¶„",
    "ë°©ì†¡ ë‹¨ì¶•ê¶Œ -1ë¶„","ë°©ì†¡ ë‹¨ì¶•ê¶Œ -10ë¶„","ë°©ì†¡ ë‹¨ì¶•ê¶Œ -20ë¶„","ë°©ì†¡ ë‹¨ì¶•ê¶Œ -30ë¶„"
  ];

  function sortKeys(keys){
    return keys.slice().sort((a,b)=>{
      const iaT = timeOrder.indexOf(a), ibT = timeOrder.indexOf(b);
      const iaG = nobleOrder.indexOf(a), ibG = nobleOrder.indexOf(b);
      const iaN = normalOrder.indexOf(a), ibN = normalOrder.indexOf(b);

      const aIsTime = iaT !== -1, bIsTime = ibT !== -1;
      const aIsNoble = iaG !== -1, bIsNoble = ibG !== -1;
      const aIsNormal = iaN !== -1, bIsNormal = ibN !== -1;

      if(aIsTime && bIsTime) return iaT - ibT;
      if(aIsTime) return -1;
      if(bIsTime) return 1;

      if(aIsNoble && bIsNoble) return iaG - ibG;
      if(aIsNoble) return -1;
      if(bIsNoble) return 1;

      if(aIsNormal && bIsNormal) return iaN - ibN;
      if(aIsNormal) return -1;
      if(bIsNormal) return 1;

      const na = Number(a), nb = Number(b);
      const aNum = Number.isFinite(na) && String(na) === a;
      const bNum = Number.isFinite(nb) && String(nb) === b;
      if(aNum && bNum) return na - nb;

      return String(a).localeCompare(String(b));
    });
  }

  function changeCount(user, rIndex, key, delta){
    const data = getData();
    if(!data[user] || !data[user][rIndex]) return;

    const stats = data[user][rIndex].stats || {};
    const k = String(key);

    stats[k] = (stats[k] || 0) + delta;
    if(stats[k] <= 0) delete stats[k];

    data[user][rIndex].stats = stats;
    saveData(data);
    render(user);
  }

  function sumRuns(entries){
    return entries.reduce((s, r) => s + (Number(r.count)||0), 0);
  }

  function buildUserCard(user, entries, keyword, openUser){
    const card = document.createElement("div");
    card.className = "user-card";

    const head = document.createElement("div");
    head.className = "user-head";

    const left = document.createElement("div");
    left.className = "user-name";
    left.textContent = user;

    const right = document.createElement("div");
    right.className = "user-meta";

    const totalEntries = entries.length;
    const totalRuns = sumRuns(entries);

    const p1 = document.createElement("span");
    p1.className = "pill";
    p1.textContent = `ê¸°ë¡ ${totalEntries}ê°œ`;

    const p2 = document.createElement("span");
    p2.className = "pill";
    p2.textContent = `ì´ ${totalRuns}íšŒ`;

    const chev = document.createElement("span");
    chev.className = "chev";
    chev.textContent = "â–¾";

    right.appendChild(p1);
    right.appendChild(p2);
    right.appendChild(chev);

    head.appendChild(left);
    head.appendChild(right);

    const body = document.createElement("div");
    body.className = "user-body";

    const shouldOpen = (openUser && openUser === user);
    if(shouldOpen){
      body.classList.add("open");
      chev.textContent = "â–´";
    }

    head.addEventListener("click", () => {
      const isOpen = body.classList.contains("open");
      document.querySelectorAll(".user-body.open").forEach(el => { if(el !== body) el.classList.remove("open"); });
      document.querySelectorAll(".chev").forEach(c => { if(c !== chev) c.textContent = "â–¾"; });

      if(isOpen){
        body.classList.remove("open");
        chev.textContent = "â–¾";
      } else {
        body.classList.add("open");
        chev.textContent = "â–´";
      }
    });

    entries.forEach((r, rIndex) => {
      const rouletteName = r.roulette || "(ì´ë¦„ì—†ìŒ)";
      if(keyword && !user.includes(keyword) && !rouletteName.includes(keyword)) return;

      const title = document.createElement("div");
      title.className = "roulette-title";
      title.textContent = `â–¶ ${rouletteName} (${r.count}íšŒ)`;
      body.appendChild(title);

      const grid = document.createElement("div");
      grid.className = "grid";

      const stats = r.stats || {};
      const keys = sortKeys(Object.keys(stats));

      if(keys.length === 0){
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.textContent = "í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.";
        grid.appendChild(cell);
      } else {
        keys.forEach((k) => {
          const v = stats[k];

          const cell = document.createElement("div");
          cell.className = "cell";

          const label = document.createElement("span");
          label.className = "label";
          label.textContent = `${k} : ${v}íšŒ`;

          const btnBox = document.createElement("span");
          btnBox.className = "btns";

          const plus = document.createElement("button");
          plus.textContent = "ï¼‹";
          plus.onclick = (e) => { e.stopPropagation(); changeCount(user, rIndex, k, 1); };

          const minus = document.createElement("button");
          minus.textContent = "ï¼";
          minus.onclick = (e) => { e.stopPropagation(); changeCount(user, rIndex, k, -1); };

          btnBox.appendChild(plus);
          btnBox.appendChild(minus);

          cell.appendChild(label);
          cell.appendChild(btnBox);
          grid.appendChild(cell);
        });
      }

      body.appendChild(grid);
      const hr = document.createElement("div");
      hr.className = "hr";
      body.appendChild(hr);
    });

    card.appendChild(head);
    card.appendChild(body);
    return card;
  }

  function render(openUser){
    const keyword = (document.getElementById("search").value || "").trim();
    const data = getData();
    const log = document.getElementById("log");
    log.innerHTML = "";

    const users = Object.keys(data);

    if(users.length === 0){
      const card = document.createElement("div");
      card.className = "user-card";
      const head = document.createElement("div");
      head.className = "user-head";
      head.innerHTML = "<b>ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</b>";
      card.appendChild(head);
      log.appendChild(card);
      return;
    }

    const filteredUsers = users.filter((user) => {
      const entries = data[user] || [];
      if(!keyword) return true;
      if(user.includes(keyword)) return true;
      return entries.some(r => (r.roulette || "").includes(keyword));
    });

    if(filteredUsers.length === 0){
      const card = document.createElement("div");
      card.className = "user-card";
      const head = document.createElement("div");
      head.className = "user-head";
      head.innerHTML = "<b>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</b>";
      card.appendChild(head);
      log.appendChild(card);
      return;
    }

    filteredUsers.sort((a,b)=> a.localeCompare(b, "ko"));

    filteredUsers.forEach((user) => {
      const entries = data[user] || [];
      const card = buildUserCard(user, entries, keyword, openUser);
      log.appendChild(card);
    });
  }

  document.getElementById("searchBtn").addEventListener("click", () => render());
  document.getElementById("deleteAllBtn").addEventListener("click", deleteAll);
  document.getElementById("search").addEventListener("keydown", (e) => { if(e.key === "Enter") render(); });

  render();
})();
</script>

</body>
</html>