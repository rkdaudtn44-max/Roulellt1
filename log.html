<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê¸°ë¡</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--danger:#ef4444;--pri:#5b7cff;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
    .top{
      position:sticky;top:0;background:rgba(246,247,251,.92);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;display:flex;gap:10px;align-items:center;z-index:10;
      flex-wrap:wrap;
    }
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .wrap{max-width:900px;margin:0 auto;padding:14px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 8px 30px rgba(16,24,40,.06);}
    h2{margin:0 0 10px;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .danger{color:var(--danger);font-weight:900;font-size:13px}

    .fatal{
      max-width:900px;margin:12px auto 0;padding:12px 14px;
      background:#fff1f2;border:1px solid #fecdd3;border-radius:14px;
      color:#9f1239;font-weight:900;display:none;white-space:pre-wrap;font-size:13px;
    }

    .accHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff;cursor:pointer}
    .accHead b{font-size:16px}

    /* âœ… ìˆ«ì í­ ê³ ì •(tabular nums) ìœ í‹¸ */
    .tnum{
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
    }

    /* âœ… ë°°ì§€ ìˆ«ì ìš°ì¸¡ì •ë ¬ + í­ ê³ ì • */
    .badge{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      color:#2563eb;
      background:#eef2ff;
      display:inline-block;
      min-width:78px;
      text-align:right;
    }

    .panel{margin-top:10px;display:none}
    .panel.on{display:block}

    .table{border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .tr{display:grid;grid-template-columns:1fr 90px 120px;gap:10px;padding:10px 12px;border-top:1px solid var(--line);background:#fff;align-items:center}
    .tr:first-child{border-top:none;background:#f9fafb;font-weight:900}
    .tdRight{text-align:right}
    .mini{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;font-weight:900;cursor:pointer}
    .mini:disabled{opacity:.4;cursor:not-allowed}
    .small{font-size:12px;color:var(--muted)}

    .rowsGrid{display:grid;grid-template-columns:1fr;gap:10px;padding:10px;background:#fff}
    @media (min-width: 740px){ .rowsGrid{grid-template-columns:1fr 1fr;} }

    /* âœ… itemCardë¥¼ gridë¡œ: í•­ëª©/ìˆ˜ëŸ‰/ë²„íŠ¼ ì¤„ë§ì¶¤ */
    .itemCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:grid;
      grid-template-columns: 1fr 88px 112px;
      gap:10px;
      align-items:center;
    }
    .itemLeft b{display:block;font-size:14px}

    /* âœ… ìˆ˜ëŸ‰: tabular-nums + ìš°ì¸¡ì •ë ¬ + ê³ ì •í­ */
    .itemMid{
      width:88px;
      justify-self:end;
      text-align:right;
      font-weight:900;
      font-size:16px;
    }

    .itemRight{
      justify-self:end;
      display:flex;
      gap:8px;
    }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tab{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .tab.on{ background:#111827; border-color:#111827; color:#fff; }

    /* âœ… íƒ­ ì¹´ìš´íŠ¸: tabular + ìš°ì¸¡ì •ë ¬ ëŠë‚Œ */
    .tab .tcount{
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.12);
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      min-width:34px;
      text-align:right;
      display:inline-block;
    }
    .tab:not(.on) .tcount{
      border-color:var(--line);
      background:#f3f4f6;
      color:#111827;
    }
  </style>
</head>
<body>
  <div id="fatal" class="fatal"></div>

  <div class="top">
    <button class="btn" onclick="location.href='roulette.html'">â† ë£°ë › í˜ì´ì§€</button>
    <button class="btn" onclick="location.href='lotto.html'">ğŸŸï¸ ë³µê¶Œ</button>

    <button class="btn" id="resetRouletteBtn" style="display:none">ğŸ§¨ ë£°ë ›ê¸°ë¡ ì´ˆê¸°í™”</button>
    <button class="btn" id="resetLottoBtn" style="display:none">ğŸ§¨ ë³µê¶Œ ì „ì²´ ì´ˆê¸°í™”</button>

    <div style="flex:1"></div>
    <div class="muted" id="who"></div>
    <button class="btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <div class="wrap">
    <div class="card">
      <h2>ê¸°ë¡(í•­ëª©ë³„ ì¹´ìš´íŠ¸)</h2>
      <div class="muted" id="modeText"></div>
      <div style="height:10px"></div>
      <div class="muted" id="loadState">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      <div class="danger" id="errBox" style="margin-top:8px; display:none;"></div>
    </div>

    <div id="accBox"></div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc,
    collection, getDocs,
    runTransaction,
    query, orderBy, limit, startAfter, writeBatch
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const fatalEl = document.getElementById("fatal");
  function fatal(msg){
    fatalEl.style.display = "block";
    fatalEl.textContent = String(msg || "ì˜¤ë¥˜");
  }
  window.addEventListener("error", (e)=>{
    fatal("JS ì˜¤ë¥˜: " + (e.message || e.error || e));
  });
  window.addEventListener("unhandledrejection", (e)=>{
    fatal("Promise ì˜¤ë¥˜: " + (e.reason?.message || e.reason || e));
  });

  const firebaseConfig = {
    apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
    authDomain: "roulette-b5455.firebaseapp.com",
    projectId: "roulette-b5455",
    storageBucket: "roulette-b5455.firebasestorage.app",
    messagingSenderId: "728191308035",
    appId: "1:728191308035:web:b14b46c38bbe0261969936",
    measurementId: "G-SPY41ZKXYQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function showError(e){
    const box = $("errBox");
    box.style.display = "block";
    const code = e?.code ? `(${e.code}) ` : "";
    box.textContent = "ì˜¤ë¥˜: " + code + (e?.message || e);
  }
  function clearError(){
    const box = $("errBox");
    box.style.display = "none";
    box.textContent = "";
  }

  function normNick(v){
    return String(v ?? "")
      .normalize("NFC")
      .trim()
      .replace(/\s+/g, " ");
  }

  function validateNickForDocId(nick){
    if(!nick) return "ë‹‰ë„¤ì„ì´ ë¹„ì–´ìˆì–´ìš”.";
    if(/[\/\\]/.test(nick)) return "ë‹‰ë„¤ì„ì— / ë˜ëŠ” \\ ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ì–´.";
    if(nick.length > 30) return "ë‹‰ë„¤ì„ì´ ë„ˆë¬´ ê¸¸ì–´ìš”. (ìµœëŒ€ 30ì)";
    return "";
  }

  const TIMEOUT_MS = 12000;

  function withTimeout(promise, ms, label){
    return Promise.race([
      promise,
      new Promise((_, rej)=>setTimeout(()=>{
        const err = new Error(`${label} : ì‘ë‹µì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë ¤ì„œ ì¤‘ë‹¨í–ˆì–´ìš”(íƒ€ì„ì•„ì›ƒ ${ms}ms)`);
        err.code = "timeout";
        rej(err);
      }, ms))
    ]);
  }

  async function safeGetDoc(ref, label){
    return await withTimeout(getDoc(ref), TIMEOUT_MS, label);
  }

  async function safeGetDocs(refOrQuery, label){
    return await withTimeout(getDocs(refOrQuery), TIMEOUT_MS, label);
  }

  function setState(msg){
    $("loadState").textContent = msg;
  }

  async function getProfile(uid){
    setState("í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");
    const snap = await safeGetDoc(doc(db, "users", uid), "users/{uid} getDoc");
    return snap.exists() ? snap.data() : null;
  }

  async function getNickListFallbackFromUsers(){
    setState("ë‹‰ë„¤ì„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦(fallback: users)");
    const snap = await safeGetDocs(collection(db, "users"), "users getDocs(list)");
    return snap.docs
      .map(d => normNick(d.data()?.nickname || ""))
      .filter(n => !validateNickForDocId(n));
  }

  async function getNickList(isAdmin, myNick){
    if(isAdmin){
      setState("ë‹‰ë„¤ì„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦(ê´€ë¦¬ì)");
      const snap = await safeGetDocs(collection(db, "counts"), "counts getDocs(list)");
      const ids = snap.docs.map(d=>d.id).map(normNick).filter(n=>!validateNickForDocId(n));
      if(ids.length === 0){
        return await getNickListFallbackFromUsers();
      }
      return ids;
    }
    return [myNick];
  }

  async function getRowsForNickByType(nickRaw){
    const nick = normNick(nickRaw);
    const err = validateNickForDocId(nick);
    if(err) throw new Error(err);

    const byType = { normal: [], noble: [], time: [] };

    setState(`${nick} Â· íƒ€ì… ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`);
    const typesSnap = await safeGetDocs(collection(db, "counts", nick, "types"), `counts/${nick}/types getDocs(list)`);

    for(const tDoc of typesSnap.docs){
      const type = tDoc.id;

      setState(`${nick} Â· ${type} í•­ëª© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`);
      const itemsSnap = await safeGetDocs(
        collection(db, "counts", nick, "types", type, "items"),
        `counts/${nick}/types/${type}/items getDocs(list)`
      );

      for(const it of itemsSnap.docs){
        const d = it.data() || {};
        const row = {
          type,
          item: d.itemText || "-",
          v: Number(d.count || 0),
          itemId: it.id
        };
        if(!byType[type]) byType[type] = [];
        byType[type].push(row);
      }
    }

    Object.keys(byType).forEach(t => byType[t].sort((a,b)=>b.v-a.v));
    return byType;
  }

  async function applyDelta(nickRaw, type, itemId, itemText, delta){
    const nick = normNick(nickRaw);
    const err = validateNickForDocId(nick);
    if(err) throw new Error(err);

    const itemRef = doc(db, "counts", nick, "types", type, "items", itemId);

    await withTimeout(
      runTransaction(db, async (tx)=>{
        const snap = await tx.get(itemRef);

        if(!snap.exists()){
          if(delta <= 0) return;
          tx.set(itemRef, { itemText, count: delta });
          return;
        }

        const cur = Number(snap.data()?.count || 0);
        const next = Math.max(0, cur + delta);

        if(next === 0) tx.delete(itemRef);
        else tx.update(itemRef, { count: next, itemText });
      }),
      TIMEOUT_MS,
      "runTransaction"
    );
  }

  function sumRows(list){
    return (list||[]).reduce((a,b)=>a + (Number(b.v)||0), 0);
  }

  function safeTypeLabel(type){
    if(type==="normal") return "ì¼ë°˜";
    if(type==="noble") return "ê·€ì¡±";
    if(type==="time") return "ì‹œê°„";
    return type;
  }

  function typeOrder(){
    return ["normal","noble","time"];
  }

  const RESET_PAGE_SIZE = 450;

  function confirmDanger(title, detail){
    const ok1 = confirm(`${title}\n\n${detail}\n\nì§„ì§œ ì‹¤í–‰í• ê¹Œìš”? (ì˜ˆ/ì•„ë‹ˆì˜¤)`);
    if(!ok1) return false;
    const ok2 = confirm(`ë§ˆì§€ë§‰ í™•ì¸!\n\n${title}\n\në˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?`);
    return ok2;
  }

  async function deleteCollectionAll(collName, pageSize = RESET_PAGE_SIZE){
    setState(`[${collName}] ì‚­ì œ ì‹œì‘â€¦`);
    let last = null;
    let total = 0;

    while(true){
      const qy = query(
        collection(db, collName),
        orderBy("__name__"),
        limit(pageSize),
        ...(last ? [startAfter(last)] : [])
      );

      const snap = await safeGetDocs(qy, `${collName} getDocs(page)`);
      if(snap.empty) break;

      const batch = writeBatch(db);
      snap.docs.forEach(d => batch.delete(d.ref));
      await withTimeout(batch.commit(), TIMEOUT_MS, `${collName} batch.commit`);

      total += snap.size;
      last = snap.docs[snap.docs.length - 1];
      setState(`[${collName}] ${total}ê°œ ì‚­ì œ ì¤‘â€¦`);
    }

    setState(`[${collName}] ì‚­ì œ ì™„ë£Œ âœ… (ì´ ${total}ê°œ)`);
    return total;
  }

  async function resetAllUsersXPLevelTickets(pageSize = RESET_PAGE_SIZE){
    setState(`[users] xp/level/lottoTickets ì´ˆê¸°í™” ì‹œì‘â€¦`);
    let last = null;
    let total = 0;

    while(true){
      const qy = query(
        collection(db, "users"),
        orderBy("__name__"),
        limit(pageSize),
        ...(last ? [startAfter(last)] : [])
      );

      const snap = await safeGetDocs(qy, `users getDocs(page)`);
      if(snap.empty) break;

      const batch = writeBatch(db);
      snap.docs.forEach(d => {
        batch.update(d.ref, { xp: 0, level: 1, lottoTickets: 0 });
      });

      await withTimeout(batch.commit(), TIMEOUT_MS, `users batch.commit`);

      total += snap.size;
      last = snap.docs[snap.docs.length - 1];
      setState(`[users] ${total}ëª… ì´ˆê¸°í™” ì¤‘â€¦`);
    }

    setState(`[users] ì´ˆê¸°í™” ì™„ë£Œ âœ… (ì´ ${total}ëª…)`);
    return total;
  }

  let resetBusy = false;
  function setResetButtonsEnabled(enabled){
    const a = $("resetRouletteBtn");
    const b = $("resetLottoBtn");
    if(a) a.disabled = !enabled;
    if(b) b.disabled = !enabled;
  }

  let profile = null;
  let isAdmin = false;

  const openSet = new Set();
  const tabByNick = new Map();
  let grandTotal = 0;

  $("refreshBtn").onclick = ()=>render();
  $("logoutBtn").onclick = async ()=>{
    await signOut(auth);
    location.replace("index.html");
  };

  onAuthStateChanged(auth, async (u)=>{
    if(!u){
      location.replace("index.html");
      return;
    }

    try{
      clearError();
      setState("ì´ˆê¸°í™” ì¤‘â€¦");

      if(!navigator.onLine){
        showError({ message: "í˜„ì¬ ì˜¤í”„ë¼ì¸ ìƒíƒœì˜ˆìš”. ì¸í„°ë„· ì—°ê²° í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜." });
        setState("ì˜¤í”„ë¼ì¸");
        return;
      }

      profile = await getProfile(u.uid);
      if(!profile){
        setState("í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.");
        showError({ message: "users/{uid} ë¬¸ì„œê°€ ì—†ì–´ìš”. íšŒì›ê°€ì…ì´ ì •ìƒ ì™„ë£ŒëëŠ”ì§€ í™•ì¸í•´ì¤˜." });
        return;
      }

      const myNick = normNick(profile.nickname);
      const nickErr = validateNickForDocId(myNick);
      if(nickErr){
        setState("ë‹‰ë„¤ì„ì´ ë¹„ì •ìƒì´ì—ìš”.");
        showError({ message: "users/{uid}.nickname ê°’ì´ ë¹„ì–´ìˆê±°ë‚˜ ë¬¸ì„œIDë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¬¸ì(/, \\)ê°€ í¬í•¨ë˜ì–´ ìˆì–´ìš”." });
        return;
      }

      isAdmin = String(profile.role || "").toLowerCase() === "admin";

      $("who").textContent = `${myNick} Â· ${isAdmin ? "admin" : "user"}`;
      $("modeText").textContent =
        isAdmin ? "ê´€ë¦¬ì ëª¨ë“œ: ì „ì²´ ì¹´ìš´íŠ¸ (+/- ê°€ëŠ¥) Â· ì´ˆê¸°í™” ë²„íŠ¼ ì‚¬ìš© ê°€ëŠ¥" : "ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ: ë‚´ ì¹´ìš´íŠ¸ë§Œ í‘œì‹œ";

      profile.nickname = myNick;

      const top = document.querySelector(".top");
      if(top){
        if(!$("resetRouletteBtn")){
          const btn1 = document.createElement("button");
          btn1.className = "btn";
          btn1.id = "resetRouletteBtn";
          btn1.textContent = "ğŸ§¨ ë£°ë ›ê¸°ë¡ ì´ˆê¸°í™”";
          btn1.style.display = "none";
          top.insertBefore(btn1, top.querySelector("div[style*='flex:1']") || null);
        }
        if(!$("resetLottoBtn")){
          const btn2 = document.createElement("button");
          btn2.className = "btn";
          btn2.id = "resetLottoBtn";
          btn2.textContent = "ğŸ§¨ ë³µê¶Œ ì „ì²´ ì´ˆê¸°í™”";
          btn2.style.display = "none";
          top.insertBefore(btn2, top.querySelector("div[style*='flex:1']") || null);
        }
      }

      const resetRouletteBtn = $("resetRouletteBtn");
      const resetLottoBtn = $("resetLottoBtn");

      if(isAdmin){
        resetRouletteBtn.style.display = "inline-block";
        resetLottoBtn.style.display = "inline-block";

        resetRouletteBtn.onclick = async ()=>{
          if(resetBusy) return;
          try{
            clearError();
            const ok = confirmDanger(
              "ë£°ë › ê¸°ë¡ ì „ì²´ ì´ˆê¸°í™”",
              "- logs ì „ì²´ ì‚­ì œ\n- counts ì „ì²´ ì‚­ì œ\n\n(ë£°ë › ê¸°ë¡/ì¹´ìš´íŠ¸ê°€ ì „ë¶€ ì‚¬ë¼ì§‘ë‹ˆë‹¤)"
            );
            if(!ok) return;

            resetBusy = true;
            setResetButtonsEnabled(false);

            setState("ë£°ë › ì´ˆê¸°í™” ì‹¤í–‰ ì¤‘â€¦");
            await deleteCollectionAll("logs");
            await deleteCollectionAll("counts");

            alert("âœ… ë£°ë › ê¸°ë¡ ì´ˆê¸°í™” ì™„ë£Œ");
            await render();
          }catch(e){
            setState("ë£°ë › ì´ˆê¸°í™” ì‹¤íŒ¨");
            showError(e);
            fatal("ë£°ë › ì´ˆê¸°í™” ì˜¤ë¥˜:\n" + (e?.message || e));
          }finally{
            resetBusy = false;
            setResetButtonsEnabled(true);
          }
        };

        resetLottoBtn.onclick = async ()=>{
          if(resetBusy) return;
          try{
            clearError();
            const ok = confirmDanger(
              "ë³µê¶Œ ê´€ë ¨ ì „ì²´ ì´ˆê¸°í™”",
              "- lottoPlays ì „ì²´ ì‚­ì œ\n- publicUsers ì „ì²´ ì‚­ì œ(ë­í‚¹/ìºì‹œ)\n- usersì˜ xp/level/lottoTickets ì´ˆê¸°í™”\n\n(ë³µê¶Œ ê¸°ë¡ + ë ˆë²¨/ê²½í—˜ì¹˜/í‹°ì¼“/ë­í‚¹ ì´ˆê¸°í™”)"
            );
            if(!ok) return;

            resetBusy = true;
            setResetButtonsEnabled(false);

            setState("ë³µê¶Œ ì „ì²´ ì´ˆê¸°í™” ì‹¤í–‰ ì¤‘â€¦");
            await deleteCollectionAll("lottoPlays");
            await deleteCollectionAll("publicUsers");
            await resetAllUsersXPLevelTickets();

            alert("âœ… ë³µê¶Œ ê´€ë ¨ ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ");
            await render();
          }catch(e){
            setState("ë³µê¶Œ ì´ˆê¸°í™” ì‹¤íŒ¨");
            showError(e);
            fatal("ë³µê¶Œ ì „ì²´ ì´ˆê¸°í™” ì˜¤ë¥˜:\n" + (e?.message || e));
          }finally{
            resetBusy = false;
            setResetButtonsEnabled(true);
          }
        };

      } else {
        resetRouletteBtn.style.display = "none";
        resetLottoBtn.style.display = "none";
      }

      await render();
    }catch(e){
      setState("ì´ˆê¸°í™” ì‹¤íŒ¨");
      showError(e);
      fatal("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:\n" + (e?.message || e));
    }
  });

  async function render(){
    clearError();
    setState("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");
    const accBox = $("accBox");
    accBox.innerHTML = "";

    try{
      const myNick = normNick(profile?.nickname);
      const nicks = (await getNickList(isAdmin, myNick))
        .map(normNick)
        .filter(n=>!validateNickForDocId(n))
        .sort((a,b)=>a.localeCompare(b,"ko"));

      if(nicks.length === 0){
        setState("í‘œì‹œí•  ê¸°ë¡ì´ ì—†ì–´ìš”.");
        accBox.innerHTML = `<div class="card"><div class="muted">í‘œì‹œí•  ê¸°ë¡ì´ ì—†ì–´ìš”.</div></div>`;
        return;
      }

      grandTotal = 0;

      for(let idx=0; idx<nicks.length; idx++){
        const nick = nicks[idx];

        const byType = await getRowsForNickByType(nick);

        const sumNormal = sumRows(byType.normal);
        const sumNoble  = sumRows(byType.noble);
        const sumTime   = sumRows(byType.time);
        const nickSum = sumNormal + sumNoble + sumTime;
        grandTotal += nickSum;

        const currentTab = tabByNick.get(nick) || "normal";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="accHead">
            <b>${escapeHtml(nick)}</b>
            <span class="badge tnum" data-badge>${nickSum}íšŒ</span>
          </div>
          <div class="panel ${openSet.has(nick) ? "on" : ""}"></div>
        `;

        const panel = card.querySelector(".panel");
        const head = card.querySelector(".accHead");

        head.onclick = ()=>{
          const willOpen = !panel.classList.contains("on");
          panel.classList.toggle("on");
          if(willOpen) openSet.add(nick);
          else openSet.delete(nick);
        };

        const tabs = document.createElement("div");
        tabs.className = "tabs";

        const tabCounts = { normal: sumNormal, noble: sumNoble, time: sumTime };

        const headTable = document.createElement("div");
        headTable.className = "table";
        headTable.innerHTML = `
          <div class="tr">
            <div>í•­ëª© ì´ë¦„</div>
            <div class="tdRight tnum">ìˆ˜ëŸ‰</div>
            <div class="tdRight">(+/-)</div>
          </div>
        `;

        const grid = document.createElement("div");
        grid.className = "rowsGrid";

        const renderTypeGrid = (type)=>{
          tabByNick.set(nick, type);

          tabs.querySelectorAll(".tab").forEach(b=>{
            b.classList.toggle("on", b.dataset.type === type);
          });

          grid.innerHTML = "";
          const rows = (byType[type] || []).slice().sort((a,b)=>b.v-a.v);

          if(rows.length === 0){
            grid.innerHTML = `<div class="itemCard"><div class="muted">í•­ëª©ì´ ì—†ì–´ìš”</div></div>`;
            return;
          }

          for(const r of rows){
            const item = document.createElement("div");
            item.className = "itemCard";

            item.innerHTML = `
              <div class="itemLeft">
                <b>${escapeHtml(r.item)}</b>
                <div class="small">${escapeHtml(safeTypeLabel(type))}</div>
              </div>
              <div class="itemMid tnum" data-count>${r.v}</div>
              <div class="itemRight">
                <button class="mini" data-act="minus" ${isAdmin && r.v>0 ? "" : "disabled"}>-</button>
                <button class="mini" data-act="plus" ${isAdmin ? "" : "disabled"}>+</button>
              </div>
            `;

            const countEl = item.querySelector('[data-count]');
            const minusBtn = item.querySelector('[data-act="minus"]');
            const plusBtn  = item.querySelector('[data-act="plus"]');
            const badgeEl = card.querySelector("[data-badge]");

            plusBtn.onclick = async (ev)=>{
              ev.preventDefault(); ev.stopPropagation();
              if(!isAdmin) return;

              plusBtn.disabled = true;
              minusBtn.disabled = true;

              try{
                await applyDelta(nick, type, r.itemId, r.item, +1);

                r.v = Number(r.v||0) + 1;
                countEl.textContent = String(r.v);
                if(r.v > 0) minusBtn.disabled = false;

                tabCounts[type] = (tabCounts[type]||0) + 1;
                const newNickSum = (tabCounts.normal||0) + (tabCounts.noble||0) + (tabCounts.time||0);
                badgeEl.textContent = `${newNickSum}íšŒ`;

                grandTotal += 1;
                setState(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ âœ… (í•©ì‚° ì´ ${grandTotal}íšŒ)`);

                const tabCountSpan = tabs.querySelector(`.tab[data-type="${type}"] .tcount`);
                if(tabCountSpan) tabCountSpan.textContent = String(tabCounts[type]||0);

              }catch(e){
                showError(e);
              }finally{
                plusBtn.disabled = !isAdmin;
                minusBtn.disabled = !(isAdmin && r.v>0);
              }
            };

            minusBtn.onclick = async (ev)=>{
              ev.preventDefault(); ev.stopPropagation();
              if(!isAdmin) return;
              if(r.v <= 0) return;

              plusBtn.disabled = true;
              minusBtn.disabled = true;

              try{
                await applyDelta(nick, type, r.itemId, r.item, -1);

                r.v = Math.max(0, Number(r.v||0) - 1);

                if(r.v === 0){
                  item.remove();
                }else{
                  countEl.textContent = String(r.v);
                }

                tabCounts[type] = Math.max(0, (tabCounts[type]||0) - 1);
                const newNickSum = (tabCounts.normal||0) + (tabCounts.noble||0) + (tabCounts.time||0);
                badgeEl.textContent = `${newNickSum}íšŒ`;

                grandTotal = Math.max(0, grandTotal - 1);
                setState(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ âœ… (í•©ì‚° ì´ ${grandTotal}íšŒ)`);

                const tabCountSpan = tabs.querySelector(`.tab[data-type="${type}"] .tcount`);
                if(tabCountSpan) tabCountSpan.textContent = String(tabCounts[type]||0);

                if(grid.children.length === 0){
                  grid.innerHTML = `<div class="itemCard"><div class="muted">í•­ëª©ì´ ì—†ì–´ìš”</div></div>`;
                }

              }catch(e){
                showError(e);
              }finally{
                plusBtn.disabled = !isAdmin;
                if(item.isConnected){
                  minusBtn.disabled = !(isAdmin && r.v>0);
                }
              }
            };

            grid.appendChild(item);
          }
        };

        for(const t of typeOrder()){
          const b = document.createElement("button");
          b.className = "tab" + (t===currentTab ? " on" : "");
          b.dataset.type = t;
          b.type = "button";
          b.innerHTML = `${safeTypeLabel(t)} <span class="tcount tnum">${tabCounts[t]||0}</span>`;

          b.onclick = (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            renderTypeGrid(t);
          };

          tabs.appendChild(b);
        }

        panel.appendChild(tabs);
        panel.appendChild(headTable);
        panel.appendChild(grid);

        renderTypeGrid(currentTab);
        accBox.appendChild(card);

        if(idx % 15 === 14) await new Promise(r=>setTimeout(r, 0));
      }

      setState(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ âœ… (í•©ì‚° ì´ ${grandTotal}íšŒ)`);
    }catch(e){
      setState("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
      showError(e);

      const code = String(e?.code || "");
      const msg  = String(e?.message || e);

      if(code.includes("permission-denied") || msg.includes("permission-denied")){
        fatal(
`ê¶Œí•œ ì˜¤ë¥˜(permission-denied)

Firestore ê·œì¹™ì—ì„œ log.html ì½ê¸°ê°€ ë§‰í˜”ì–´ìš”.
- ê´€ë¦¬ì: counts ì „ì²´/í•˜ìœ„ ì½ê¸° í—ˆìš©
- ì¼ë°˜ìœ ì €: counts/{ë‚´ë‹‰} ì•„ë˜ë§Œ ì½ê¸° í—ˆìš©

ì§€ê¸ˆ ëœ¬ ì˜¤ë¥˜:
${code} ${msg}

ì¶”ê°€ ì²´í¬:
1) users/{ë‚´UID}.role ì´ "admin" ì¸ì§€
2) users/{ë‚´UID}.nickname ê³¼ counts ë¬¸ì„œIDê°€ ì™„ì „íˆ ê°™ì€ì§€ (ê³µë°±/íŠ¹ìˆ˜ë¬¸ì í¬í•¨)
3) rulesì— match /counts/{nick}/{document=**} ê°€ ìˆëŠ”ì§€`
        );
      }

      if(code === "timeout"){
        fatal(
`ë¬´í•œ ë¡œë”©(ì‘ë‹µ ì§€ì—°/ì°¨ë‹¨) ê°ì§€

ì§€ê¸ˆ ë©ˆì¶˜ ë‹¨ê³„:
${msg}

ê°€ëŠ¥í•œ ì›ì¸:
1) Firestore ê·œì¹™/ê¶Œí•œ ë¬¸ì œë¡œ ìš”ì²­ì´ ë§‰í˜
2) ë„¤íŠ¸ì›Œí¬/ì™€ì´íŒŒì´/ì°¨ë‹¨ ì•±ìœ¼ë¡œ gstatic ë˜ëŠ” firestore ìš”ì²­ì´ ì§€ì—°
3) counts ë¬¸ì„œ/ì„œë¸Œì»¬ë ‰ì…˜ì´ ë„ˆë¬´ ë§ì•„ ë¡œë”©ì´ ê³¼ë„

â†’ ìœ„ ë©”ì‹œì§€ì— "ì–´ë–¤ ë‹¨ê³„"ì—ì„œ ë©ˆì·„ëŠ”ì§€ ì í˜€ìˆì–´ìš”.`
        );
      }
    }
  }
</script>
</body>
</html>
