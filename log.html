<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë£°ë › ë¡œê·¸</title>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { 
  getFirestore, collection, doc, setDoc, getDoc,
  addDoc, serverTimestamp, onSnapshot, deleteDoc 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// ğŸ”½ ì—¬ê¸°ì— ë„¤ Firebase ì„¤ì •ì„ ê·¸ëŒ€ë¡œ ë„£ì–´
const firebaseConfig = {
  apiKey: "ë„ˆì˜APIKEY",
  authDomain: "ë„ˆì˜í”„ë¡œì íŠ¸.firebaseapp.com",
  projectId: "ë„ˆì˜í”„ë¡œì íŠ¸",
  storageBucket: "ë„ˆì˜í”„ë¡œì íŠ¸.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:xxxxxxxx"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM
const loginBox = document.getElementById("loginBox");
const nickBadge = document.getElementById("nickBadge");
const logoutBtn = document.getElementById("logoutBtn");
const wipeAllBtn = document.getElementById("wipeAllBtn");
const logList = document.getElementById("logList");

// ====== íšŒì›ê°€ì… (ìƒˆì°½ ëª¨ë‹¬) ======
window.openSignup = () => {
  document.getElementById("modalBack").style.display = "flex";
};

window.closeSignup = () => {
  document.getElementById("modalBack").style.display = "none";
};

window.signup = async () => {
  const email = document.getElementById("suEmail").value;
  const pw = document.getElementById("suPw").value;
  const nick = document.getElementById("suNick").value;

  if(!email || !pw || !nick){
    alert("ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ë‹‰ë„¤ì„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  const cred = await createUserWithEmailAndPassword(auth, email, pw);
  const uid = cred.user.uid;

  // ë‹‰ë„¤ì„ ì €ì¥
  await setDoc(doc(db, "users", uid), {
    email, nick, createdAt: serverTimestamp()
  });

  alert("íšŒì›ê°€ì… ì™„ë£Œ!");
  closeSignup();
};

// ====== ë¡œê·¸ì¸ ======
window.login = async () => {
  const email = document.getElementById("lgEmail").value;
  const pw = document.getElementById("lgPw").value;
  await signInWithEmailAndPassword(auth, email, pw);
};

// ====== ë¡œê·¸ì•„ì›ƒ ======
logoutBtn.onclick = async () => {
  await signOut(auth);
};

// ====== ì‹¤ì‹œê°„ ìƒíƒœ ê°ì§€ ======
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    loginBox.classList.remove("hidden");
    nickBadge.style.display = "none";
    logoutBtn.style.display = "none";
    wipeAllBtn.style.display = "none";
    return;
  }

  // ë¡œê·¸ì¸ ì„±ê³µ â†’ ë¡œê·¸ì¸ì°½ ìˆ¨ê¹€
  loginBox.classList.add("hidden");

  // ë‹‰ë„¤ì„ ë¶ˆëŸ¬ì˜¤ê¸°
  const snap = await getDoc(doc(db, "users", user.uid));
  const nick = snap.exists() ? snap.data().nick : "ì‚¬ìš©ì";

  nickBadge.innerText = nick;
  nickBadge.style.display = "inline-block";
  logoutBtn.style.display = "inline-block";

  // ê´€ë¦¬ì ì²´í¬
  const adminSnap = await getDoc(doc(db, "admins", user.uid));
  if(adminSnap.exists()){
    wipeAllBtn.style.display = "inline-block"; // ê´€ë¦¬ìë§Œ ì „ì²´ì‚­ì œ ë²„íŠ¼ ë³´ì´ê²Œ
  }
});

// ====== ë¡œê·¸ ì‹¤ì‹œê°„ í‘œì‹œ ======
onSnapshot(collection(db, "logs"), (snapshot)=>{
  logList.innerHTML = "";
  snapshot.forEach(doc=>{
    const d = doc.data();
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <b>${d.nickname || "ìµëª…"}</b>
        <div class="meta">${new Date(d.time?.toDate()).toLocaleString()}</div>
        <div>${d.result}</div>
      </div>
      <div class="ctrl">
        <button class="delBtn" data-id="${doc.id}">ì‚­ì œ</button>
      </div>
    `;
    logList.appendChild(row);
  });

  // ê´€ë¦¬ìë§Œ ì‚­ì œ ê°€ëŠ¥
  document.querySelectorAll(".delBtn").forEach(btn=>{
    btn.onclick = async () => {
      const user = auth.currentUser;
      if(!user) return;

      const adminSnap = await getDoc(doc(db, "admins", user.uid));
      if(!adminSnap.exists()){
        alert("ê´€ë¦¬ìë§Œ ì‚­ì œ ê°€ëŠ¥");
        return;
      }
      await deleteDoc(doc(db, "logs", btn.dataset.id));
    };
  });
});

// ====== ì „ì²´ì‚­ì œ(ê´€ë¦¬ì) ======
wipeAllBtn.onclick = async () => {
  const user = auth.currentUser;
  const adminSnap = await getDoc(doc(db, "admins", user.uid));
  if(!adminSnap.exists()){
    alert("ê´€ë¦¬ìë§Œ ì‚¬ìš© ê°€ëŠ¥");
    return;
  }
  if(!confirm("ì •ë§ ì „ì²´ ì‚­ì œ?")) return;

  const snap = await getDoc(collection(db, "logs"));
  snap.forEach(d => deleteDoc(doc(db, "logs", d.id)));
};
</script>

<style>
body{margin:0;font-family:system-ui;background:#f4f5f7;}
header{background:white;border-bottom:1px solid #ddd;}
.topbar{display:flex;justify-content:space-between;padding:12px;}
.nick{display:none;background:#fff;border:1px solid #ddd;padding:6px 10px;border-radius:999px;}
.hidden{display:none;}
.card{background:white;margin:12px;padding:12px;border-radius:12px;}
.row{border:1px solid #eee;padding:10px;border-radius:12px;margin-bottom:8px;}
.ctrl button{margin-left:6px;}
.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.3);display:none;align-items:center;justify-content:center;}
.modal{background:white;padding:16px;border-radius:16px;width:320px;}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <b>ğŸ“Š ë£°ë › ë¡œê·¸</b>
    <div>
      <span id="nickBadge" class="nick"></span>
      <button id="wipeAllBtn">ì „ì²´ì‚­ì œ</button>
      <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</header>

<div id="loginBox" class="card">
  <input id="lgEmail" placeholder="ì´ë©”ì¼">
  <input id="lgPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
  <button onclick="login()">ë¡œê·¸ì¸</button>
  <button onclick="openSignup()">íšŒì›ê°€ì…</button>
</div>

<div id="logList"></div>

<!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <h3>íšŒì›ê°€ì…</h3>
    <input id="suEmail" placeholder="ì´ë©”ì¼">
    <input id="suPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <input id="suNick" placeholder="ë‹‰ë„¤ì„">
    <button onclick="signup()">ê°€ì…</button>
    <button onclick="closeSignup()">ë‹«ê¸°</button>
  </div>
</div>

</body>
</html>
