<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë£°ë › ë¡œê·¸</title>

<style>
  :root{--bg:#f4f5f7;--card:#fff;--text:#111;--muted:#666;--line:#e8e8e8;--main:#111;--blue:#2f6fed;--danger:#e53935;}
  body{margin:0;font-family:system-ui,-apple-system,Arial;background:var(--bg);color:var(--text);}
  header{position:sticky;top:0;z-index:5;background:rgba(244,245,247,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);}
  .topbar{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;}
  .title{font-size:20px;font-weight:900}
  .right{display:flex;align-items:center;gap:10px;}
  .nick{font-size:12px;padding:7px 10px;border-radius:999px;background:#fff;border:1px solid var(--line);display:none;}
  .btn{border:none;cursor:pointer;padding:10px 12px;border-radius:12px;background:var(--main);color:#fff;font-weight:900;font-size:13px;}
  .btn.secondary{background:#fff;color:#111;border:1px solid var(--line);}
  .btn.danger{background:var(--danger);}
  .btn[disabled]{opacity:.6;cursor:not-allowed;}
  main{max-width:980px;margin:0 auto;padding:16px;}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;}
  .loginBar{display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .loginLeft{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  input{padding:11px 12px;border-radius:12px;border:1px solid var(--line);font-size:14px;}
  .hint{font-size:12px;color:var(--muted);line-height:1.4;margin:10px 2px 0;}
  a{color:var(--blue);text-decoration:none;font-weight:900;}
  #log{margin-top:12px;display:flex;flex-direction:column;gap:10px;}
  .row{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .row .left{display:flex;flex-direction:column;gap:5px;}
  .row b{font-size:14px;}
  .meta{font-size:12px;color:var(--muted);}
  .ctrl{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .hidden{display:none !important;}

  /* ì—ëŸ¬ ë°•ìŠ¤ */
  #errBox{display:none;margin-top:12px;border:1px solid #ffc9c9;background:#fff5f5;color:#b00020;border-radius:14px;padding:12px;white-space:pre-wrap;font-size:12px;line-height:1.35;}
  #okBox{display:none;margin-top:12px;border:1px solid #c9ffd1;background:#f6fff7;color:#0a6b1e;border-radius:14px;padding:12px;white-space:pre-wrap;font-size:12px;line-height:1.35;}

  /* íšŒì›ê°€ì… ëª¨ë‹¬ */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10;padding:18px;}
  .modal{width:min(420px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.18);overflow:hidden;}
  .modalHead{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--line);font-weight:900;}
  .xbtn{border:none;background:#f2f2f2;border-radius:10px;width:36px;height:36px;cursor:pointer;font-size:18px;}
  .modalBody{padding:14px;display:flex;flex-direction:column;gap:10px;}
  .modalFoot{padding:14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end;}
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">ğŸ“Š ë£°ë › ë¡œê·¸</div>
    <div class="right">
      <span id="nickBadge" class="nick"></span>
      <button id="logoutBtn" class="btn secondary" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</header>

<main>
  <div id="authBox" class="card">
    <div class="loginBar">
      <div class="loginLeft">
        <input id="email" placeholder="ì´ë©”ì¼" autocomplete="email" />
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì+)" autocomplete="current-password" />
        <button class="btn" id="loginBtn">ë¡œê·¸ì¸</button>
        <button class="btn secondary" id="openSignupBtn">íšŒì›ê°€ì…</button>
      </div>
      <div class="meta" id="status">ë¯¸ë¡œê·¸ì¸</div>
    </div>
  </div>

  <div id="errBox"></div>
  <div id="okBox"></div>

  <div class="hint">
    - ë¡œê·¸ì¸ ì„±ê³µí•˜ë©´ ì…ë ¥ì°½ì´ ì‚¬ë¼ì§€ê³  ìš°ì¸¡ìƒë‹¨ì— ë‹‰ë„¤ì„ë§Œ í‘œì‹œë¼.<br>
    - <a href="index.html">â† ë£°ë › í˜ì´ì§€</a>
  </div>

  <div id="log"></div>
</main>

<!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="signupBack" class="modalBack">
  <div class="modal">
    <div class="modalHead">
      <span>íšŒì›ê°€ì…(ë‹‰ë„¤ì„ í¬í•¨)</span>
      <button class="xbtn" id="closeSignupBtn">Ã—</button>
    </div>
    <div class="modalBody">
      <input id="suNick" placeholder="ë‹‰ë„¤ì„(ìµœëŒ€ 20ì)" maxlength="20" />
      <input id="suEmail" placeholder="ì´ë©”ì¼" autocomplete="email" />
      <input id="suPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(6ì+)" autocomplete="new-password" />
      <div class="meta">* ê°€ì… í›„ ìš°ì¸¡ìƒë‹¨ì— ë‹‰ë„¤ì„ì´ í‘œì‹œë¼.</div>
    </div>
    <div class="modalFoot">
      <button class="btn secondary" id="cancelSignupBtn">ì·¨ì†Œ</button>
      <button class="btn" id="doSignupBtn">ê°€ì…í•˜ê¸°</button>
    </div>
  </div>
</div>

<script type="module">
/** í™”ë©´ì— ì—ëŸ¬ë¥¼ ì°ê¸° ìœ„í•œ ë„êµ¬ */
const errBox = document.getElementById("errBox");
const okBox  = document.getElementById("okBox");
function showErr(msg){
  errBox.style.display = "block";
  errBox.textContent = String(msg);
}
function showOk(msg){
  okBox.style.display = "block";
  okBox.textContent = String(msg);
}
window.addEventListener("error", (e)=>showErr("JS ì˜¤ë¥˜:\n" + (e.message || e.error)));
window.addEventListener("unhandledrejection", (e)=>showErr("Promise ì˜¤ë¥˜:\n" + (e.reason?.message || e.reason)));

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/** âœ… ë„¤ í”„ë¡œì íŠ¸ ì„¤ì • (ì§€ê¸ˆ ì“°ë˜ ê·¸ëŒ€ë¡œ) */
const firebaseConfig = {
  apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
  authDomain: "roulette-b5455.firebaseapp.com",
  projectId: "roulette-b5455",
  storageBucket: "roulette-b5455.firebasestorage.app",
  messagingSenderId: "728191308035",
  appId: "1:728191308035:web:b14b46c38bbe0261969936"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const $ = (id)=>document.getElementById(id);

function openSignup(){ $("signupBack").style.display="flex"; }
function closeSignup(){ $("signupBack").style.display="none"; }

$("openSignupBtn").addEventListener("click", openSignup);
$("closeSignupBtn").addEventListener("click", closeSignup);
$("cancelSignupBtn").addEventListener("click", closeSignup);
$("signupBack").addEventListener("click",(e)=>{ if(e.target===$("signupBack")) closeSignup(); });

function showLoggedOut(){
  $("status").textContent = "ë¯¸ë¡œê·¸ì¸";
  $("authBox").classList.remove("hidden");
  $("logoutBtn").style.display = "none";
  $("nickBadge").style.display = "none";
}
function showLoggedIn(nickname){
  $("status").textContent = "ë¡œê·¸ì¸ë¨";
  $("authBox").classList.add("hidden");
  $("logoutBtn").style.display = "inline-block";
  $("nickBadge").style.display = "inline-block";
  $("nickBadge").textContent = nickname ? `ë‹‰ë„¤ì„: ${nickname}` : "ë‹‰ë„¤ì„ ì—†ìŒ";
}

$("doSignupBtn").addEventListener("click", async ()=>{
  try{
    okBox.style.display = "none"; errBox.style.display = "none";
    const nickname = $("suNick").value.trim();
    const email = $("suEmail").value.trim();
    const pw = $("suPw").value;

    if(!nickname) return showErr("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜");
    if(!email) return showErr("ì´ë©”ì¼ì„ ì…ë ¥í•´ì¤˜");
    if(!pw || pw.length < 6) return showErr("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì•¼");

    showOk("íšŒì›ê°€ì… ì²˜ë¦¬ì¤‘...");
    const cred = await createUserWithEmailAndPassword(auth, email, pw);
    await setDoc(doc(db,"users", cred.user.uid), {
      nickname, email, createdAt: new Date().toISOString()
    });
    showOk("íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ë¨");
    closeSignup();
  }catch(e){
    showErr("íšŒì›ê°€ì… ì‹¤íŒ¨:\n" + (e.code || "") + "\n" + (e.message || e));
  }
});

$("loginBtn").addEventListener("click", async ()=>{
  const btn = $("loginBtn");
  try{
    okBox.style.display = "none"; errBox.style.display = "none";
    const email = $("email").value.trim();
    const pw = $("pw").value;

    if(!email) return showErr("ì´ë©”ì¼ì„ ì…ë ¥í•´ì¤˜");
    if(!pw) return showErr("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜");

    btn.disabled = true;
    btn.textContent = "ì²˜ë¦¬ì¤‘...";
    showOk("ë¡œê·¸ì¸ ì‹œë„ì¤‘...");

    await signInWithEmailAndPassword(auth, email, pw);
    showOk("ë¡œê·¸ì¸ ì„±ê³µ!");
  }catch(e){
    showErr("ë¡œê·¸ì¸ ì‹¤íŒ¨:\n" + (e.code || "") + "\n" + (e.message || e));
  }finally{
    btn.disabled = false;
    btn.textContent = "ë¡œê·¸ì¸";
  }
});

$("logoutBtn").addEventListener("click", async ()=>{
  await signOut(auth);
});

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    showLoggedOut();
    return;
  }
  let nickname = "";
  try{
    const u = await getDoc(doc(db,"users", user.uid));
    nickname = u.exists() ? (u.data().nickname || "") : "";
  }catch(e){
    // users ì½ê¸° ê·œì¹™ ë¬¸ì œë©´ ì—¬ê¸°ì„œ ì¡í˜
    showErr("ë‹‰ë„¤ì„ ì½ê¸° ì‹¤íŒ¨(Users Rules í™•ì¸ í•„ìš”):\n" + (e.code || "") + "\n" + (e.message || e));
  }
  showLoggedIn(nickname);
});

showOk("ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì™„ë£Œ âœ… (ì´ ë¬¸êµ¬ê°€ ì•ˆ ë³´ì´ë©´ ìºì‹œ/ì—…ë°ì´íŠ¸ ë¬¸ì œ)");
</script>

</body>
</html>
