<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê¸°ë¡</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--danger:#ef4444;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
    .top{position:sticky;top:0;background:rgba(246,247,251,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;z-index:10;}
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .wrap{max-width:900px;margin:0 auto;padding:14px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 8px 30px rgba(16,24,40,.06);}
    h2{margin:0 0 10px;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .danger{color:var(--danger);font-weight:900;font-size:13px}

    .accHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff;cursor:pointer}
    .accHead b{font-size:16px}
    .badge{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:900;color:#2563eb;background:#eef2ff}
    .panel{margin-top:10px;display:none}
    .panel.on{display:block}

    .table{border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .tr{display:grid;grid-template-columns:1fr 90px 120px;gap:10px;padding:10px 12px;border-top:1px solid var(--line);background:#fff;align-items:center}
    .tr:first-child{border-top:none;background:#f9fafb;font-weight:900}
    .tdRight{text-align:right}
    .mini{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;font-weight:900;cursor:pointer}
    .mini:disabled{opacity:.4;cursor:not-allowed}
    .small{font-size:12px;color:var(--muted)}

    .rowsGrid{display:grid;grid-template-columns:1fr;gap:10px;padding:10px;background:#fff}
    @media (min-width: 740px){
      .rowsGrid{grid-template-columns:1fr 1fr;}
    }
    .itemCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .itemLeft b{display:block;font-size:14px}
    .itemLeft .small{margin-top:4px}
    .itemMid{min-width:60px;text-align:center;font-weight:900;font-size:16px}
    .itemRight{display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="top">
    <button class="btn" onclick="location.href='roulette.html'">â† ë£°ë › í˜ì´ì§€</button>
    <button class="btn" onclick="location.href='lotto.html'">ğŸŸï¸ ë³µê¶Œ</button>
    <div style="flex:1"></div>
    <div class="muted" id="who"></div>
    <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <div class="wrap">
    <div class="card">
      <h2>ê¸°ë¡(í•­ëª©ë³„ ì¹´ìš´íŠ¸)</h2>
      <div class="muted" id="modeText"></div>
      <div style="height:10px"></div>
      <div class="muted" id="loadState">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      <div class="danger" id="errBox" style="margin-top:8px; display:none;"></div>
    </div>

    <div id="accBox"></div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
    authDomain: "roulette-b5455.firebaseapp.com",
    projectId: "roulette-b5455",
    storageBucket: "roulette-b5455.firebasestorage.app",
    messagingSenderId: "728191308035",
    appId: "1:728191308035:web:b14b46c38bbe0261969936",
    measurementId: "G-SPY41ZKXYQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function showError(e){
    const box = $("errBox");
    box.style.display = "block";
    const code = e?.code ? `(${e.code}) ` : "";
    box.textContent = "ì˜¤ë¥˜: " + code + (e?.message || e);
  }
  function clearError(){
    const box = $("errBox");
    box.style.display = "none";
    box.textContent = "";
  }

  function normNick(v){
    return String(v ?? "").trim();
  }

  async function getProfile(uid){
    const snap = await getDoc(doc(db, "users", uid));
    return snap.exists() ? snap.data() : null;
  }

  async function getNickList(isAdmin, myNick){
    if(isAdmin){
      const snap = await getDocs(collection(db, "counts"));
      return snap.docs.map(d=>d.id);
    }
    return [myNick];
  }

  async function getRowsForNick(nick){
    const rows = [];
    const typesSnap = await getDocs(collection(db, "counts", nick, "types"));
    for(const tDoc of typesSnap.docs){
      const type = tDoc.id;
      const itemsSnap = await getDocs(collection(db, "counts", nick, "types", type, "items"));
      for(const it of itemsSnap.docs){
        const d = it.data();
        rows.push({
          type,
          item: d.itemText || "-",
          v: Number(d.count || 0),
          itemId: it.id
        });
      }
    }
    rows.sort((a,b)=>b.v-a.v);
    return rows;
  }

  async function applyDelta(nick, type, itemId, itemText, delta){
    const itemRef = doc(db, "counts", nick, "types", type, "items", itemId);
    await runTransaction(db, async (tx)=>{
      const snap = await tx.get(itemRef);
      if(!snap.exists()){
        if(delta <= 0) return;
        tx.set(itemRef, { itemText, count: delta });
        return;
      }
      const cur = Number(snap.data().count || 0);
      const next = Math.max(0, cur + delta);
      if(next === 0) tx.delete(itemRef);
      else tx.update(itemRef, { count: next, itemText });
    });
  }

  let profile = null;
  let isAdmin = false;

  $("refreshBtn").onclick = ()=>render();

  onAuthStateChanged(auth, async (u)=>{
    if(!u){ location.replace("index.html"); return; }

    try{
      profile = await getProfile(u.uid);
      if(!profile){ location.replace("index.html"); return; }

      const myNick = normNick(profile.nickname);
      if(!myNick){
        $("loadState").textContent = "ë‹‰ë„¤ì„ì´ ë¹„ì–´ìˆì–´ìš”. ë‹¤ì‹œ ê°€ì…/í”„ë¡œí•„ í™•ì¸ì´ í•„ìš”í•´ìš”.";
        showError({ message: "users/{uid} ë¬¸ì„œì— nickname ê°’ì´ ì—†ê±°ë‚˜ ê³µë°±ì…ë‹ˆë‹¤." });
        return;
      }

      isAdmin = (profile.role === "admin") || (myNick === "ë„ë¦¬");
      $("who").textContent = `${myNick} Â· ${isAdmin ? "admin" : "user"}`;
      $("modeText").textContent =
        isAdmin ? "ê´€ë¦¬ì ëª¨ë“œ: ì „ì²´ ì¹´ìš´íŠ¸ (+/- ê°€ëŠ¥)" : "ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ: ë‚´ ì¹´ìš´íŠ¸ë§Œ í‘œì‹œ";

      render();
    }catch(e){
      $("loadState").textContent = "ì´ˆê¸°í™” ì‹¤íŒ¨";
      showError(e);
    }
  });

  async function render(){
    clearError();
    $("loadState").textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
    const accBox = $("accBox");
    accBox.innerHTML = "";

    try{
      const myNick = normNick(profile?.nickname);
      const nicks = (await getNickList(isAdmin, myNick)).sort((a,b)=>a.localeCompare(b,"ko"));

      if(nicks.length === 0){
        $("loadState").textContent = "í‘œì‹œí•  ê¸°ë¡ì´ ì—†ì–´ìš”.";
        accBox.innerHTML = `<div class="card"><div class="muted">í‘œì‹œí•  ê¸°ë¡ì´ ì—†ì–´ìš”.</div></div>`;
        return;
      }

      let total = 0;

      for(const nick of nicks){
        const rows = await getRowsForNick(nick);
        const nickSum = rows.reduce((a,b)=>a + (b.v||0), 0);
        total += nickSum;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="accHead">
            <b>${escapeHtml(nick)}</b>
            <span class="badge">${nickSum}íšŒ</span>
          </div>
          <div class="panel"></div>
        `;

        const panel = card.querySelector(".panel");
        card.querySelector(".accHead").onclick = ()=> panel.classList.toggle("on");

        const headTable = document.createElement("div");
        headTable.className = "table";
        headTable.innerHTML = `
          <div class="tr">
            <div>í•­ëª© ì´ë¦„</div>
            <div class="tdRight">ìˆ˜ëŸ‰</div>
            <div class="tdRight">(+/-)</div>
          </div>
        `;

        const grid = document.createElement("div");
        grid.className = "rowsGrid";

        if(rows.length === 0){
          grid.innerHTML = `<div class="itemCard"><div class="muted">í•­ëª©ì´ ì—†ì–´ìš”</div></div>`;
        }else{
          for(const r of rows){
            const item = document.createElement("div");
            item.className = "itemCard";
            item.innerHTML = `
              <div class="itemLeft">
                <b>${escapeHtml(r.item)}</b>
                <div class="small">${escapeHtml(r.type)}</div>
              </div>
              <div class="itemMid">${r.v}</div>
              <div class="itemRight">
                <button class="mini" data-act="minus" ${isAdmin && r.v>0 ? "" : "disabled"}>-</button>
                <button class="mini" data-act="plus" ${isAdmin ? "" : "disabled"}>+</button>
              </div>
            `;

            item.querySelector('[data-act="plus"]').onclick = async (ev)=>{
              ev.stopPropagation();
              if(!isAdmin) return;
              await applyDelta(nick, r.type, r.itemId, r.item, +1);
              render();
            };
            item.querySelector('[data-act="minus"]').onclick = async (ev)=>{
              ev.stopPropagation();
              if(!isAdmin) return;
              await applyDelta(nick, r.type, r.itemId, r.item, -1);
              render();
            };

            grid.appendChild(item);
          }
        }

        panel.appendChild(headTable);
        panel.appendChild(grid);
        accBox.appendChild(card);
      }

      $("loadState").textContent = `ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ âœ… (í•©ì‚° ì´ ${total}íšŒ)`;
    }catch(e){
      // âœ… ì—¬ê¸°ì„œ ë©ˆì¶”ë˜ ë¬¸ì œë¥¼ "ì—ëŸ¬ í‘œì‹œ"ë¡œ ë°”ê¿ˆ
      $("loadState").textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
      showError(e);
    }
  }
</script>
</body>
</html>
