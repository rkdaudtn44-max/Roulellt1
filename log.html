<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ê¸°ë¡</title>

<style>
:root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--pri:#5b7cff;}
body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}
.top{position:sticky;top:0;background:#f6f7fb;border-bottom:1px solid var(--line);padding:10px;display:flex;gap:8px;align-items:center;}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
.wrap{max-width:900px;margin:0 auto;padding:14px}
.card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;margin-bottom:14px}
.accHead{display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.badge{background:#eef2ff;border-radius:999px;padding:4px 10px;font-weight:900}
.panel{display:none;margin-top:10px}
.panel.on{display:block}
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tab{padding:6px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
.tab.on{background:#111827;color:#fff}
.rowsGrid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:740px){.rowsGrid{grid-template-columns:1fr 1fr}}
.itemCard{border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;justify-content:space-between;align-items:center}
.itemRight{display:flex;gap:6px}
.mini{padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
.muted{color:var(--muted);font-size:13px}
</style>
</head>
<body>

<div class="top">
<button class="btn" onclick="location.href='roulette.html'">â† ë£°ë ›</button>
<button class="btn" onclick="location.href='lotto.html'">ğŸŸ ë³µê¶Œ</button>
<div style="flex:1"></div>
<div id="who"></div>
<button class="btn" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
</div>

<div class="wrap">
<div id="app">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore-compat.js"></script>

<script>
try {

const firebaseConfig={
apiKey:"AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
authDomain:"roulette-b5455.firebaseapp.com",
projectId:"roulette-b5455"
};

if (!firebase.apps.length) {
firebase.initializeApp(firebaseConfig);
}

const auth=firebase.auth();
const db=firebase.firestore();

const ADMIN_EMAILS=["dori0223@gmail.com"];

auth.onAuthStateChanged(async user=>{
if(!user){location.href="index.html";return;}

document.getElementById("who").textContent=user.email;

let profileSnap=await db.collection("users").doc(user.uid).get();
if(!profileSnap.exists){
document.getElementById("app").innerHTML="í”„ë¡œí•„ ì—†ìŒ";
return;
}

const nickname=profileSnap.data()?.nickname || "";
const isAdmin=ADMIN_EMAILS.includes(user.email);

render(nickname,isAdmin);

});

async function render(myNick,isAdmin){

const app=document.getElementById("app");
app.innerHTML="";

let nickList=[];

if(isAdmin){
try{
const snap=await db.collection("counts").get();
nickList=snap.docs.map(d=>d.id);
}catch(e){
app.innerHTML="ì¹´ìš´íŠ¸ ì½ê¸° ì‹¤íŒ¨";
return;
}
}else{
nickList=[myNick];
}

if(nickList.length===0){
app.innerHTML="<div class='muted'>ê¸°ë¡ ì—†ìŒ</div>";
return;
}

for(const nick of nickList){

const card=document.createElement("div");
card.className="card";

const head=document.createElement("div");
head.className="accHead";
head.innerHTML=`<b>${nick}</b><span class="badge">0íšŒ</span>`;

const panel=document.createElement("div");
panel.className="panel";

head.onclick=()=>panel.classList.toggle("on");

card.appendChild(head);
card.appendChild(panel);
app.appendChild(card);

let total=0;
let byType={normal:[],noble:[],time:[]};

try{
const typesSnap=await db.collection("counts").doc(nick).collection("types").get();

for(const t of typesSnap.docs){
const itemsSnap=await db.collection("counts").doc(nick)
.collection("types").doc(t.id)
.collection("items").get();

itemsSnap.forEach(it=>{
const data=it.data()||{};
const count=Number(data.count)||0;
total+=count;
if(byType[t.id]){
byType[t.id].push({text:data.itemText||"",count:count});
}
});
}
}catch(e){
console.log("ì½ê¸° ì˜¤ë¥˜",e);
}

head.querySelector(".badge").textContent=total+"íšŒ";

const tabs=document.createElement("div");
tabs.className="tabs";
panel.appendChild(tabs);

const grid=document.createElement("div");
grid.className="rowsGrid";
panel.appendChild(grid);

function renderType(type){
grid.innerHTML="";
tabs.querySelectorAll(".tab").forEach(t=>t.classList.remove("on"));
const activeTab=tabs.querySelector(`[data-type='${type}']`);
if(activeTab) activeTab.classList.add("on");

const list=byType[type]||[];
if(list.length===0){
grid.innerHTML="<div class='muted'>í•­ëª© ì—†ìŒ</div>";
return;
}

list.forEach(item=>{
const div=document.createElement("div");
div.className="itemCard";
div.innerHTML=`
<div>${item.text}</div>
<div class="itemRight">
<span>${item.count}</span>
</div>`;
grid.appendChild(div);
});
}

["normal","noble","time"].forEach(type=>{
const btn=document.createElement("div");
btn.className="tab";
btn.dataset.type=type;
btn.textContent=type==="normal"?"ì¼ë°˜":type==="noble"?"ê·€ì¡±":"ì‹œê°„";
btn.onclick=()=>renderType(type);
tabs.appendChild(btn);
});

renderType("normal");

}

}

} catch(e){
document.body.innerHTML="<h2>ì¹˜ëª…ì  ì˜¤ë¥˜</h2><pre>"+e+"</pre>";
}
</script>

</body>
</html>
