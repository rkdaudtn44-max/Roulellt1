<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë£°ë › ë¡œê·¸</title>
<style>
  :root{
    --bg:#f4f5f7; --card:#fff; --text:#111; --muted:#666;
    --line:#e7e7e7; --main:#111; --danger:#e53935;
  }
  body{margin:0;font-family:system-ui,-apple-system,Apple SD Gothic Neo,Segoe UI,Arial;background:var(--bg);color:var(--text);}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10;}
  .topbar{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;}
  .brand{font-weight:900;font-size:18px;display:flex;gap:8px;align-items:center;}
  .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
  .badge{
    display:none;
    background:#fff;border:1px solid var(--line);
    padding:6px 10px;border-radius:999px;font-size:12px;
    max-width:70vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .btn{
    border:none;cursor:pointer;padding:10px 12px;border-radius:12px;
    background:var(--main);color:#fff;font-weight:900;
  }
  .btn.secondary{background:#fff;color:#111;border:1px solid var(--line);}
  .btn.danger{background:var(--danger);}
  main{max-width:980px;margin:0 auto;padding:14px;}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;}
  .hidden{display:none !important;}
  .muted{color:var(--muted);font-size:12px;line-height:1.4;}
  input{
    width:100%;box-sizing:border-box;margin:6px 0;padding:12px;
    border-radius:12px;border:1px solid var(--line);font-size:16px;
    background:#fff;
  }
  .authBtns{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
  .sectionTitle{margin:14px 0 8px;font-weight:900;}
  .row{
    background:#fff;border:1px solid var(--line);border-radius:14px;
    padding:10px;display:flex;justify-content:space-between;gap:10px;
    align-items:center;margin-bottom:8px;
  }
  .row b{display:block;}
  .row small{color:var(--muted);}
  .ctrl{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
  .ctrl .mini{padding:8px 10px;border-radius:12px;font-weight:900;}
  .ctrl .mini.secondary{background:#fff;color:#111;border:1px solid var(--line);}
  .ctrl .mini.danger{background:var(--danger);color:#fff;border:none;}
  .link{display:inline-block;margin-top:10px;color:#5b2fbf;text-decoration:none;font-weight:800;}
  /* Signup modal */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50;padding:16px;}
  .modal{background:#fff;border-radius:16px;border:1px solid var(--line);padding:14px;width:min(420px,100%);}
  .modal h3{margin:0 0 8px;}
  .modal .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
  .toast{display:none;margin-top:8px;font-size:12px;color:#b00020;white-space:pre-wrap;}
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">ğŸ“Š ë£°ë › ë¡œê·¸</div>
    <div class="right">
      <span id="nickBadge" class="badge"></span>
      <button id="wipeAllBtn" class="btn danger" style="display:none;">ì „ì²´ì‚­ì œ</button>
      <button id="logoutBtn" class="btn secondary" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</header>

<main>
  <!-- ë¡œê·¸ì¸ ë°•ìŠ¤ -->
  <div id="authBox" class="card">
    <div style="font-weight:900;">ë¡œê·¸ì¸</div>
    <input id="email" placeholder="ì´ë©”ì¼" autocomplete="email" />
    <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
    <div class="authBtns">
      <button id="loginBtn" class="btn">ë¡œê·¸ì¸</button>
      <button id="openSignupBtn" class="btn secondary">íšŒì›ê°€ì…</button>
    </div>
    <div id="status" class="muted" style="margin-top:8px;">ìƒíƒœ: ë¯¸ë¡œê·¸ì¸</div>
    <div id="errBox" class="toast"></div>
  </div>

  <div class="sectionTitle">ê¸°ë¡</div>
  <div id="logList"></div>

  <a class="link" href="./roulette.html">â† ë£°ë › í˜ì´ì§€</a>
</main>

<!-- íšŒì›ê°€ì… ëª¨ë‹¬(ìƒˆì°½ ëŠë‚Œ) -->
<div id="signupBack" class="backdrop">
  <div class="modal">
    <h3>íšŒì›ê°€ì…</h3>
    <div class="muted">ë‹‰ë„¤ì„/ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸(6ì ì´ìƒ)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
    <input id="suNick" placeholder="ë‹‰ë„¤ì„" autocomplete="nickname" />
    <input id="suEmail" placeholder="ì´ë©”ì¼" autocomplete="email" />
    <input id="suPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì+)" autocomplete="new-password" />
    <div class="actions">
      <button id="doSignupBtn" class="btn">ê°€ì…</button>
      <button id="closeSignupBtn" class="btn secondary">ë‹«ê¸°</button>
    </div>
    <div id="suErr" class="toast"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword,
    signInWithEmailAndPassword, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, increment
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  // âœ… ë„¤ Firebase ì„¤ì • (ê·¸ëŒ€ë¡œ ìœ ì§€)
  const firebaseConfig = {
    apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
    authDomain: "roulette-b5455.firebaseapp.com",
    projectId: "roulette-b5455",
    storageBucket: "roulette-b5455.firebasestorage.app",
    messagingSenderId: "728191308035",
    appId: "1:728191308035:web:b14b46c38bbe0261969936"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  let currentUser = null;
  let isAdmin = false;

  function showErr(msg){
    const box = $("errBox");
    box.style.display = "block";
    box.textContent = String(msg);
  }
  function clearErr(){
    $("errBox").style.display = "none";
    $("errBox").textContent = "";
  }
  function showSuErr(msg){
    const box = $("suErr");
    box.style.display="block";
    box.textContent=String(msg);
  }
  function clearSuErr(){
    $("suErr").style.display="none";
    $("suErr").textContent="";
  }

  // ----- Signup modal open/close -----
  $("openSignupBtn").onclick = () => { clearSuErr(); $("signupBack").style.display="flex"; };
  $("closeSignupBtn").onclick = () => { $("signupBack").style.display="none"; };
  $("signupBack").addEventListener("click", (e)=>{
    if(e.target === $("signupBack")) $("signupBack").style.display="none";
  });

  // ----- Signup -----
  $("doSignupBtn").onclick = async () => {
    try{
      clearSuErr();
      const nick = $("suNick").value.trim();
      const email = $("suEmail").value.trim();
      const pw = $("suPw").value;

      if(!nick) return showSuErr("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      if(!email) return showSuErr("ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.");
      if(!pw || pw.length < 6) return showSuErr("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");

      const cred = await createUserWithEmailAndPassword(auth, email, pw);

      // users/{uid} ì €ì¥
      await setDoc(doc(db, "users", cred.user.uid), {
        nickname: nick,
        email: email,
        createdAt: new Date().toISOString()
      });

      $("signupBack").style.display="none";
      alert("íšŒì›ê°€ì… ì™„ë£Œ!");
    }catch(e){
      showSuErr(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${e.code || ""}\n${e.message || e}`);
    }
  };

  // ----- Login / Logout -----
  $("loginBtn").onclick = async () => {
    try{
      clearErr();
      const email = $("email").value.trim();
      const pw = $("pw").value;
      if(!email || !pw) return showErr("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      $("status").textContent = "ìƒíƒœ: ë¡œê·¸ì¸ ì‹œë„ì¤‘...";
      await signInWithEmailAndPassword(auth, email, pw);
    }catch(e){
      showErr(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.code || ""}\n${e.message || e}`);
      $("status").textContent = "ìƒíƒœ: ë¯¸ë¡œê·¸ì¸";
    }
  };

  $("logoutBtn").onclick = async () => {
    await signOut(auth);
  };

  // ----- Admin check -----
  async function checkAdmin(uid){
    // admins/{uid} ë¬¸ì„œê°€ ì¡´ì¬í•˜ë©´ ê´€ë¦¬ì
    const s = await getDoc(doc(db, "admins", uid));
    return s.exists();
  }

  // ----- Logs render -----
  async function loadLogs(){
    const list = $("logList");
    list.innerHTML = "";

    const snap = await getDocs(collection(db, "logs"));

    if(snap.empty){
      list.innerHTML = `<div class="card muted">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.</div>`;
      return;
    }

    snap.forEach(d=>{
      const data = d.data();
      const row = document.createElement("div");
      row.className = "row";

      const left = document.createElement("div");
      left.innerHTML = `
        <b>${escapeHtml(data.nickname || "ìµëª…")}</b>
        <small>${escapeHtml(data.result || "")}</small>
      `;

      const right = document.createElement("div");
      right.className = "ctrl";

      if(isAdmin){
        const plus = document.createElement("button");
        plus.className = "mini secondary";
        plus.textContent = "+";
        plus.onclick = async () => {
          await updateDoc(doc(db,"logs",d.id), { count: increment(1) }).catch(()=>{});
          loadLogs();
        };

        const minus = document.createElement("button");
        minus.className = "mini secondary";
        minus.textContent = "-";
        minus.onclick = async () => {
          await updateDoc(doc(db,"logs",d.id), { count: increment(-1) }).catch(()=>{});
          loadLogs();
        };

        const del = document.createElement("button");
        del.className = "mini danger";
        del.textContent = "ì‚­ì œ";
        del.onclick = async () => {
          if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
          await deleteDoc(doc(db,"logs",d.id));
          loadLogs();
        };

        right.appendChild(plus);
        right.appendChild(minus);
        right.appendChild(del);
      }

      row.appendChild(left);
      row.appendChild(right);
      list.appendChild(row);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // ----- Auth state -----
  onAuthStateChanged(auth, async (user)=>{
    currentUser = user;
    clearErr();

    if(!user){
      // logged out
      $("authBox").classList.remove("hidden");
      $("nickBadge").style.display = "none";
      $("logoutBtn").style.display = "none";
      $("wipeAllBtn").style.display = "none";
      $("status").textContent = "ìƒíƒœ: ë¯¸ë¡œê·¸ì¸";
      isAdmin = false;
      await loadLogs(); // ê¸°ë¡ì€ ë³´ì—¬ì¤˜ë„ ë¨(ë³´ê¸° ì „ìš©)
      return;
    }

    // logged in
    $("status").textContent = "ìƒíƒœ: ë¡œê·¸ì¸ë¨";
    $("authBox").classList.add("hidden");

    // ë‹‰ë„¤ì„ ì½ê¸°
    let nickname = "(ë‹‰ë„¤ì„ì—†ìŒ)";
    try{
      const u = await getDoc(doc(db,"users",user.uid));
      if(u.exists() && u.data().nickname) nickname = u.data().nickname;
    }catch(e){
      // ë‹‰ë„¤ì„ ëª» ì½ì–´ë„ ë¡œê·¸ì¸ì€ ìœ ì§€
    }

    // ê´€ë¦¬ì ì—¬ë¶€
    try{
      isAdmin = await checkAdmin(user.uid);
    }catch(e){
      isAdmin = false;
    }

    $("nickBadge").textContent = isAdmin ? `${nickname} (ê´€ë¦¬ì)` : `${nickname}`;
    $("nickBadge").style.display = "inline-block";
    $("logoutBtn").style.display = "inline-block";

    // ê´€ë¦¬ìë§Œ ì „ì²´ì‚­ì œ í‘œì‹œ
    $("wipeAllBtn").style.display = isAdmin ? "inline-block" : "none";

    await loadLogs();
  });

  // ----- Wipe all (admin only) -----
  $("wipeAllBtn").onclick = async ()=>{
    if(!isAdmin) return;
    if(!confirm("ì •ë§ ì „ì²´ ì‚­ì œí• ê¹Œìš”?")) return;
    const snap = await getDocs(collection(db,"logs"));
    for(const d of snap.docs){
      await deleteDoc(doc(db,"logs",d.id));
    }
    loadLogs();
  };
</script>

</body>
</html>
