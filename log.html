<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë£°ë › ë¡œê·¸</title>

<style>
:root{--bg:#f4f5f7;--card:#fff;--text:#111;--muted:#666;--line:#e8e8e8;--main:#111;--danger:#e53935;}
body{margin:0;font-family:system-ui,-apple-system,Arial;background:var(--bg);}

header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);}
.topbar{max-width:980px;margin:0 auto;display:flex;justify-content:space-between;padding:12px 16px;}

.nick{
  display:none;
  background:#fff;
  border:1px solid var(--line);
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
}

.btn{
  border:none;
  cursor:pointer;
  padding:10px 12px;
  border-radius:12px;
  background:var(--main);
  color:#fff;
  font-weight:900;
}
.btn.secondary{background:#fff;color:#111;border:1px solid var(--line);}
.btn.danger{background:var(--danger);}

main{max-width:980px;margin:0 auto;padding:16px;}
.card{background:white;border:1px solid var(--line);border-radius:16px;padding:12px;}
.hidden{display:none !important;}

.row{
  background:#fff;
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.ctrl button{margin-left:6px;}

.modalBack{
  position:fixed;inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal{
  background:white;
  padding:16px;
  border-radius:16px;
  width:320px;
}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <b>ğŸ“Š ë£°ë › ë¡œê·¸</b>
    <div>
      <span id="nickBadge" class="nick"></span>
      <button id="logoutBtn" class="btn secondary" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
      <button id="wipeAllBtn" class="btn danger" style="display:none;">ì „ì²´ì‚­ì œ</button>
    </div>
  </div>
</header>

<main>

<!-- ë¡œê·¸ì¸ ë°•ìŠ¤ -->
<div id="authBox" class="card">
  <input id="email" placeholder="ì´ë©”ì¼">
  <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
  <button id="loginBtn" class="btn">ë¡œê·¸ì¸</button>
  <button id="openSignupBtn" class="btn secondary">íšŒì›ê°€ì…</button>
  <div id="status" style="margin-top:8px;font-size:12px;color:#666;">ë¯¸ë¡œê·¸ì¸</div>
</div>

<div id="logList"></div>

</main>

<!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="signupBack" class="modalBack">
  <div class="modal">
    <h3>íšŒì›ê°€ì…</h3>
    <input id="suNick" placeholder="ë‹‰ë„¤ì„">
    <input id="suEmail" placeholder="ì´ë©”ì¼">
    <input id="suPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button id="doSignupBtn" class="btn">ê°€ì…</button>
    <button id="closeSignupBtn" class="btn secondary">ë‹«ê¸°</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
  getAuth, createUserWithEmailAndPassword, 
  signInWithEmailAndPassword, signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { 
  getFirestore, collection, doc, setDoc, getDoc,
  getDocs, deleteDoc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
  authDomain: "roulette-b5455.firebaseapp.com",
  projectId: "roulette-b5455",
  storageBucket: "roulette-b5455.firebasestorage.app",
  messagingSenderId: "728191308035",
  appId: "1:728191308035:web:b14b46c38bbe0261969936"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = id => document.getElementById(id);

let currentUser = null;
let isAdmin = false;

// ëª¨ë‹¬ ì—´ê³  ë‹«ê¸°
$("openSignupBtn").onclick = ()=> $("signupBack").style.display="flex";
$("closeSignupBtn").onclick = ()=> $("signupBack").style.display="none";

// íšŒì›ê°€ì…
$("doSignupBtn").onclick = async ()=>{
  const nick = $("suNick").value.trim();
  const email = $("suEmail").value.trim();
  const pw = $("suPw").value;

  if(!nick || !email || pw.length < 6){
    alert("ë‹‰ë„¤ì„/ì´ë©”ì¼/ë¹„ë²ˆ(6ì+) ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  const cred = await createUserWithEmailAndPassword(auth, email, pw);
  await setDoc(doc(db,"users",cred.user.uid),{
    nickname:nick,
    email,
    createdAt:new Date().toISOString()
  });

  alert("íšŒì›ê°€ì… ì™„ë£Œ!");
  $("signupBack").style.display="none";
};

// ë¡œê·¸ì¸
$("loginBtn").onclick = async ()=>{
  const email = $("email").value;
  const pw = $("pw").value;
  try{
    await signInWithEmailAndPassword(auth,email,pw);
  }catch(e){
    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+ e.code);
  }
};

// ë¡œê·¸ì•„ì›ƒ
$("logoutBtn").onclick = async ()=>{
  await signOut(auth);
};

// ê´€ë¦¬ì ì²´í¬
async function checkAdmin(uid){
  const s = await getDoc(doc(db,"admins",uid));
  return s.exists();
}

// ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadLogs(){
  const snap = await getDocs(collection(db,"logs"));
  const list = $("logList");
  list.innerHTML="";

  snap.forEach(d=>{
    const data = d.data();
    const row = document.createElement("div");
    row.className="row";

    let adminBtns = "";
    if(isAdmin){
      adminBtns = `
        <div class="ctrl">
          <button class="btn secondary" data-plus="${d.id}">+</button>
          <button class="btn secondary" data-minus="${d.id}">-</button>
          <button class="btn danger" data-del="${d.id}">ì‚­ì œ</button>
        </div>
      `;
    }

    row.innerHTML = `
      <div>
        <b>${data.nickname || "ìµëª…"}</b><br>
        <small>${data.result || ""}</small>
      </div>
      ${adminBtns}
    `;
    list.appendChild(row);
  });

  if(isAdmin){
    document.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = async ()=>{
        await deleteDoc(doc(db,"logs",btn.dataset.del));
        loadLogs();
      };
    });
  }
}

// ì¸ì¦ ìƒíƒœ ê°ì§€
onAuthStateChanged(auth, async user=>{
  currentUser = user;

  if(!user){
    $("authBox").classList.remove("hidden");
    $("nickBadge").style.display="none";
    $("logoutBtn").style.display="none";
    $("wipeAllBtn").style.display="none";
    $("status").textContent="ë¯¸ë¡œê·¸ì¸";
    return;
  }

  // ë¡œê·¸ì¸ ì„±ê³µ â†’ ì…ë ¥ì°½ ìˆ¨ê¹€
  $("authBox").classList.add("hidden");

  // ë‹‰ë„¤ì„ ë¶ˆëŸ¬ì˜¤ê¸°
  const u = await getDoc(doc(db,"users",user.uid));
  const nick = u.exists()?u.data().nickname:"(ë‹‰ë„¤ì„ì—†ìŒ)";

  // ê´€ë¦¬ì ì—¬ë¶€
  isAdmin = await checkAdmin(user.uid);

  // â­ï¸ ì—¬ê¸°ì„œ UIDë¥¼ í™”ë©´ì— í‘œì‹œ
  $("nickBadge").textContent =
    `${nick} | UID: ${user.uid}${isAdmin?" (ê´€ë¦¬ì)":""}`;
  $("nickBadge").style.display="inline-block";
  $("logoutBtn").style.display="inline-block";

  if(isAdmin){
    $("wipeAllBtn").style.display="inline-block";
  }

  loadLogs();
});

// ì „ì²´ì‚­ì œ(ê´€ë¦¬ì)
$("wipeAllBtn").onclick = async ()=>{
  if(!isAdmin) return;
  if(!confirm("ì „ì²´ì‚­ì œ?")) return;

  const snap = await getDocs(collection(db,"logs"));
  snap.forEach(d=> deleteDoc(doc(db,"logs",d.id)));
  loadLogs();
};
</script>

</body>
</html>
