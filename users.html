<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìœ ì € ëª©ë¡(ê´€ë¦¬ì)</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--line:#e7e9f2;--text:#111827;--muted:#6b7280;--pri:#5b7cff;--danger:#ef4444;}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;color:var(--text);}

    /* âœ… ìƒë‹¨ ê³µí†µë°” */
    .top{
      position:sticky;top:0;background:rgba(246,247,251,.92);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;display:flex;gap:10px;align-items:center;z-index:10;
      flex-wrap:wrap;
    }
    .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}

    .wrap{max-width:980px;margin:0 auto;padding:14px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;box-shadow:0 8px 30px rgba(16,24,40,.06);}
    h2{margin:0 0 10px;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .danger{color:var(--danger);font-weight:900;font-size:13px;white-space:pre-wrap}

    .fatal{
      max-width:980px;margin:12px auto 0;padding:12px 14px;
      background:#fff1f2;border:1px solid #fecdd3;border-radius:14px;
      color:#9f1239;font-weight:900;display:none;white-space:pre-wrap;font-size:13px;
    }

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .search{
      width:min(360px, 100%);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      background:#fff;
    }

    /* âœ… 2ì—´ í…Œì´ë¸” */
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:900px){
      .twoCol{ grid-template-columns:1fr; }
    }

    .table{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }

    .tr{
      display:grid;
      grid-template-columns: 56px 1fr 90px 120px; /* # / ë‹‰ / ë ˆë²¨ / ê²½í—˜ì¹˜ */
      gap:10px;
      padding:10px 12px;
      border-top:1px solid var(--line);
      align-items:center;
      background:#fff;
    }
    .tr.head{
      border-top:none;
      background:#f9fafb;
      font-weight:900;
      color:#111827;
    }
    .tdRight{ text-align:right; }
    .nums{ font-variant-numeric: tabular-nums; }

    .footerRow{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:12px}
  </style>
</head>
<body>
  <div id="fatal" class="fatal"></div>

  <div class="top">
    <button class="btn" onclick="location.href='roulette.html'">ğŸ¯ ë£°ë ›</button>
    <button class="btn" onclick="location.href='log.html'">ğŸ“’ ê¸°ë¡</button>
    <button class="btn" onclick="location.href='lotto.html'">ğŸŸï¸ ë³µê¶Œ</button>
    <button class="btn pri" onclick="location.href='users.html'">ğŸ‘¥ ìœ ì €</button>

    <div style="flex:1"></div>
    <div class="muted" id="who"></div>
    <button class="btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h2>ê°€ì… ìœ ì € ëª©ë¡ (ê´€ë¦¬ì ì „ìš©)</h2>
          <div class="muted" id="stateText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
        </div>
        <input id="q" class="search" placeholder="ê²€ìƒ‰: ë‹‰ë„¤ì„" />
      </div>

      <div style="height:10px"></div>
      <div id="errBox" class="danger" style="display:none"></div>

      <div class="twoCol">
        <div class="table" id="leftBox"></div>
        <div class="table" id="rightBox"></div>
      </div>

      <div class="footerRow">
        <div class="muted nums" id="countText">0ëª…</div>
        <button class="btn" id="moreBtn" disabled>ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc,
    collection, getDocs,
    query, orderBy, limit, startAfter
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCgVETP2TbQOkDeh5D2ocwXhUMPcZYYKbs",
    authDomain: "roulette-b5455.firebaseapp.com",
    projectId: "roulette-b5455",
    storageBucket: "roulette-b5455.firebasestorage.app",
    messagingSenderId: "728191308035",
    appId: "1:728191308035:web:b14b46c38bbe0261969936",
    measurementId: "G-SPY41ZKXYQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id)=>document.getElementById(id);
  const fatalEl = $("fatal");
  function fatal(msg){
    fatalEl.style.display = "block";
    fatalEl.textContent = String(msg || "ì˜¤ë¥˜");
  }
  window.addEventListener("error", (e)=> fatal("JS ì˜¤ë¥˜: " + (e.message || e.error || e)));
  window.addEventListener("unhandledrejection", (e)=> fatal("Promise ì˜¤ë¥˜: " + (e.reason?.message || e.reason || e)));

  const errBox = $("errBox");
  function showErr(e){
    errBox.style.display = "block";
    const code = e?.code ? `(${e.code}) ` : "";
    errBox.textContent = "ì˜¤ë¥˜: " + code + (e?.message || e);
  }
  function clearErr(){ errBox.style.display="none"; errBox.textContent=""; }

  function normNick(v){
    return String(v ?? "").normalize("NFC").trim().replace(/\s+/g, " ");
  }

  const TIMEOUT_MS = 12000;
  function withTimeout(promise, ms, label){
    return Promise.race([
      promise,
      new Promise((_, rej)=>setTimeout(()=>{
        const err = new Error(`${label} : ì‘ë‹µ ì§€ì—°(íƒ€ì„ì•„ì›ƒ ${ms}ms)`);
        err.code = "timeout";
        rej(err);
      }, ms))
    ]);
  }
  async function safeGetDoc(ref, label){ return await withTimeout(getDoc(ref), TIMEOUT_MS, label); }
  async function safeGetDocs(qy, label){ return await withTimeout(getDocs(qy), TIMEOUT_MS, label); }

  $("refreshBtn").onclick = ()=>location.reload();
  $("logoutBtn").onclick = async ()=>{
    await signOut(auth);
    location.replace("index.html");
  };

  const stateText = $("stateText");
  const countText = $("countText");
  const moreBtn = $("moreBtn");
  const qEl = $("q");
  const leftBox = $("leftBox");
  const rightBox = $("rightBox");

  // rows: { nickname, level, xp }
  let allRows = [];
  let filteredRows = [];
  let lastDoc = null;
  let loaded = 0;
  const PAGE_SIZE = 200;

  function renderTable(boxEl, rows, startIndex){
    boxEl.innerHTML = `
      <div class="tr head">
        <div class="nums">#</div>
        <div>ë‹‰ë„¤ì„</div>
        <div class="tdRight nums">ë ˆë²¨</div>
        <div class="tdRight nums">ê²½í—˜ì¹˜</div>
      </div>
    `;

    rows.forEach((r, i)=>{
      const tr = document.createElement("div");
      tr.className = "tr";
      tr.innerHTML = `
        <div class="nums">${startIndex + i}</div>
        <div>${r.nickname || "-"}</div>
        <div class="tdRight nums">${Number(r.level ?? 1)}</div>
        <div class="tdRight nums">${Number(r.xp ?? 0).toLocaleString("ko-KR")}</div>
      `;
      boxEl.appendChild(tr);
    });

    if(rows.length === 0){
      const empty = document.createElement("div");
      empty.className = "tr";
      empty.innerHTML = `<div class="muted" style="grid-column:1 / -1">í‘œì‹œí•  ìœ ì €ê°€ ì—†ì–´ìš”.</div>`;
      boxEl.appendChild(empty);
    }
  }

  function render(){
    const q = String(qEl.value || "").trim().toLowerCase();

    if(!q){
      filteredRows = allRows.slice();
    }else{
      filteredRows = allRows.filter(r => (r.nickname||"").toLowerCase().includes(q));
    }

    // âœ… 2ì—´ ë¶„ë°° (ì™¼ìª½ì´ í•œ ì¤„ ë” ë§ê²Œ)
    const n = filteredRows.length;
    const leftCount = Math.ceil(n / 2);
    const left = filteredRows.slice(0, leftCount);
    const right = filteredRows.slice(leftCount);

    renderTable(leftBox, left, 1);
    renderTable(rightBox, right, leftCount + 1);

    countText.textContent = `${filteredRows.length}ëª… í‘œì‹œ / ${allRows.length}ëª… ë¡œë“œë¨`;
  }

  qEl.addEventListener("input", render);

  async function loadNextPage(){
    clearErr();
    moreBtn.disabled = true;

    try{
      stateText.textContent = "ìœ ì € ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";

      const qy = query(
        collection(db, "users"),
        orderBy("nickname"),
        limit(PAGE_SIZE),
        ...(lastDoc ? [startAfter(lastDoc)] : [])
      );

      const snap = await safeGetDocs(qy, "users getDocs(page)");
      if(snap.empty){
        stateText.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ âœ… (ë” ì—†ìŒ)";
        return;
      }

      snap.docs.forEach(d=>{
        const u = d.data() || {};
        allRows.push({
          nickname: normNick(u.nickname || ""),
          level: u.level ?? 1,
          xp: u.xp ?? 0
        });
      });

      loaded += snap.size;
      lastDoc = snap.docs[snap.docs.length - 1];

      stateText.textContent = `ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦ (${loaded}ëª… ë¡œë“œë¨)`;
      render();

      // ë” ë‚¨ì•˜ì„ ê°€ëŠ¥ì„±
      moreBtn.disabled = snap.size < PAGE_SIZE ? true : false;
      if(moreBtn.disabled) stateText.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ âœ…";

    }catch(e){
      stateText.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
      showErr(e);
      if(String(e?.code||"") === "timeout"){
        fatal("ì‘ë‹µì´ ë„ˆë¬´ ëŠë¦¬ê±°ë‚˜ ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ ë§‰í˜”ì–´ìš”.\n(íƒ€ì„ì•„ì›ƒ)\n\n- rulesì—ì„œ ê´€ë¦¬ì users read í—ˆìš© í™•ì¸\n- ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ í™•ì¸");
      }
    }
  }

  moreBtn.onclick = loadNextPage;

  onAuthStateChanged(auth, async (u)=>{
    if(!u){
      location.replace("index.html");
      return;
    }

    try{
      clearErr();
      stateText.textContent = "ê´€ë¦¬ì í™•ì¸ ì¤‘â€¦";

      const snap = await safeGetDoc(doc(db, "users", u.uid), "users/{uid} getDoc(profile)");
      if(!snap.exists()){
        showErr({ message: "users/{uid} í”„ë¡œí•„ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. íšŒì›ê°€ì… ì™„ë£Œ ì—¬ë¶€ í™•ì¸í•´ì¤˜." });
        stateText.textContent = "í”„ë¡œí•„ ì—†ìŒ";
        return;
      }

      const profile = snap.data() || {};
      const myNick = normNick(profile.nickname || "-");
      const role = String(profile.role || "").toLowerCase();
      const isAdmin = role === "admin";

      $("who").textContent = `${myNick} Â· ${isAdmin ? "admin" : "user"}`;

      if(!isAdmin){
        alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
        location.replace("log.html");
        return;
      }

      // ìµœì´ˆ 1í˜ì´ì§€ ë¡œë“œ
      await loadNextPage();
      if(allRows.length >= PAGE_SIZE) moreBtn.disabled = false;

    }catch(e){
      stateText.textContent = "ì´ˆê¸°í™” ì‹¤íŒ¨";
      showErr(e);
      fatal("ì´ˆê¸°í™” ì˜¤ë¥˜:\n" + (e?.message || e));
    }
  });
</script>
</body>
</html>
